<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tạo Đề Thi Văn Học</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> 
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script> 
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script> 
    <!-- Tesseract OCR -->
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script> 
    <!-- Mammoth.js (đọc .docx) -->
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script> 
    <style>
        :root {
            --primary-color: #4A90E2;
            --bg-color: #f5f7fa;
            --text-color: #333;
            --border-color: #ddd;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .logo {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-buttons a {
            margin-left: 1rem;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"], 
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            background: #eee;
            transition: 0.3s;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 1rem;
            background: white;
            border-radius: 0 0 6px 6px;
            border: 1px solid var(--border-color);
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        .question-block {
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-block;
            margin-top: 1rem;
        }

        .btn-secondary {
            background: #eee;
            color: var(--primary-color);
            margin-left: 0.5rem;
        }

        .qr-code {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .share-links {
            margin-top: 1.5rem;
            text-align: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 6px;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Thi Văn Học</div>
            <div class="nav-buttons">
                <a href="index.html"><i class="fas fa-home"></i> Trang Chủ</a>
                <a href="manage-exam.html"><i class="fas fa-cog"></i> Quản Lý</a>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-pen"></i> Tạo Đề Thi Mới</h2>
            
            <div class="form-group">
                <label for="examTime">Thời Gian Thi (phút)</label>
                <input type="number" id="examTime" min="10" max="180" required>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="manual">Tự Tạo Đề</div>
                <div class="tab" data-tab="ai">AI Tạo Đề</div>
                <div class="tab" data-tab="word">Từ File Word</div>
                <div class="tab" data-tab="image">Từ Hình Ảnh</div>
            </div>

            <div id="manual" class="tab-content active">
                <div id="questions-container"></div>
                <button class="btn" onclick="addQuestion()"><i class="fas fa-plus"></i> Thêm Câu Hỏi</button>
            </div>

            <div id="ai" class="tab-content">
                <textarea id="aiDescription" rows="4" placeholder="Mô tả đề thi bạn muốn tạo..."></textarea>
                <button class="btn" onclick="generateWithAI()"><i class="fas fa-magic"></i> Tạo Đề Với AI</button>
            </div>

            <div id="word" class="tab-content">
                <input type="file" id="wordFile" accept=".docx">
                <button class="btn" onclick="importFromWord()"><i class="fas fa-file-word"></i> Nhập Từ Word</button>
            </div>

            <div id="image" class="tab-content">
                <input type="file" id="imageFile" accept="image/*">
                <button class="btn" onclick="importFromImage()"><i class="fas fa-camera"></i> Chụp Ảnh Đề Thi</button>
                <img id="previewImage" style="margin-top: 1rem; max-width: 100%; display: none;">
            </div>

            <div class="form-group">
                <label class="checkbox-group">
                    <input type="checkbox" id="antiCheating">
                    <i class="fas fa-shield-alt"></i> Kích hoạt chống gian lận
                </label>
            </div>

            <button class="btn" onclick="createExam()"><i class="fas fa-save"></i> Tạo Đề Thi</button>

            <div class="qr-code" id="qrContainer" style="display: none;">
                <div id="qrcode"></div>
                <div class="share-links">
                    <p>Chia sẻ qua:</p>
                    <a id="shareLink" target="_blank" class="btn btn-secondary"><i class="fas fa-link"></i> Sao Chép Link</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
            authDomain: "literatureexamapp.firebaseapp.com",
            projectId: "literatureexamapp",
            storageBucket: "literatureexamapp.firebasestorage.app",
            messagingSenderId: "829681704033",
            appId: "1:829681704033:web:f92a79de0c177b235b9e20"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Tab switch
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Add manual question
        let questionCount = 0;
        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questions-container');
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
                <h4>Câu Hỏi ${questionCount}</h4>
                <div class="form-group">
                    <label>Nội dung câu hỏi</label>
                    <input type="text" class="question-text" required>
                </div>
                <div class="form-group">
                    <select class="question-type" onchange="updateOptions(this)">
                        <option value="tracnghiem">Trắc nghiệm (A, B, C, D)</option>
                        <option value="dungsai">Đúng/Sai</option>
                        <option value="tuluan">Tự luận</option>
                    </select>
                </div>
                <div class="options-container"></div>
            `;
            container.appendChild(div);
            updateOptions(div.querySelector('.question-type'));
        }

        function updateOptions(select) {
            const container = select.closest('.question-block').querySelector('.options-container');
            container.innerHTML = '';
            
            switch(select.value) {
                case 'tracnghiem':
                    for(let i=0; i<4; i++) {
                        container.innerHTML += `
                            <div class="form-group">
                                <label>Đáp án ${String.fromCharCode(65+i)}</label>
                                <input type="text" class="option">
                                <label><input type="radio" name="correct-${questionCount}" value="${i}"> Đáp án đúng</label>
                            </div>
                        `;
                    }
                    break;
                case 'dungsai':
                    container.innerHTML = `
                        <div class="form-group">
                            <label><input type="radio" name="correct-${questionCount}" value="true"> Đúng</label>
                            <label><input type="radio" name="correct-${questionCount}" value="false"> Sai</label>
                        </div>
                    `;
                    break;
                case 'tuluan':
                    container.innerHTML = `
                        <div class="form-group">
                            <label>Đáp án mẫu</label>
                            <textarea class="option" rows="3"></textarea>
                        </div>
                    `;
                    break;
            }
        }

        // Create exam
        async function createExam() {
            const time = document.getElementById('examTime').value;
            const antiCheating = document.getElementById('antiCheating').checked;
            
            // Get questions based on current tab
            let questions = [];
            if(document.getElementById('manual').classList.contains('active')) {
                questions = getManualQuestions();
            }
            else if(document.getElementById('ai').classList.contains('active')) {
                questions = await generateWithAI();
            }
            else if(document.getElementById('word').classList.contains('active')) {
                questions = await importFromWord();
            }
            else if(document.getElementById('image').classList.contains('active')) {
                questions = await importFromImage();
            }

            if(questions.length === 0) {
                alert('Vui lòng nhập ít nhất một câu hỏi');
                return;
            }

            // Save to Firestore
            const examData = {
                time: parseInt(time),
                antiCheating,
                questions,
                createdAt: new Date()
            };

            const docRef = await db.collection("exams").add(examData);
            showQRCode(docRef.id);
        }

        function getManualQuestions() {
            const questions = [];
            document.querySelectorAll('.question-block').forEach((block, index) => {
                const typeSelect = block.querySelector('.question-type');
                const questionText = block.querySelector('.question-text').value;
                const options = [];

                switch(typeSelect.value) {
                    case 'tracnghiem':
                        const correctRadio = block.querySelector(`input[name="correct-${index+1}"]:checked`);
                        block.querySelectorAll('.option').forEach((input, i) => {
                            options.push({
                                text: input.value,
                                correct: correctRadio ? i === parseInt(correctRadio.value) : false
                            });
                        });
                        break;
                    case 'dungsai':
                        const dsRadio = block.querySelector(`input[name="correct-${index+1}"]:checked`);
                        options.push({
                            text: dsRadio ? dsRadio.value : ''
                        });
                        break;
                    case 'tuluan':
                        const answer = block.querySelector('.option').value;
                        options.push({ answer });
                        break;
                }

                questions.push({
                    text: questionText,
                    type: typeSelect.value,
                    options
                });
            });
            return questions;
        }

        // Gemini API
        const GEMINI_API_KEY = 'AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM';
        const GEMINI_MODEL = 'gemini-pro';

        async function generateWithAI() {
            const description = document.getElementById('aiDescription').value.trim();
            if (!description) {
                alert('Vui lòng mô tả đề thi!');
                return [];
            }

            const prompt = `Tạo một đề thi văn học với các câu hỏi sau: ${description}. 
            Định dạng đầu ra JSON với cấu trúc:
            {
                "questions": [
                    {
                        "text": "Nội dung câu hỏi",
                        "type": "tracnghiem|dungsai|tuluan",
                        "options": [
                            {"text": "Đáp án A", "correct": true/false},
                            ... (cho trắc nghiệm)
                        ]
                    }
                ]
            }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('Lỗi kết nối với Gemini API');

                const data = await response.json();
                const aiContent = data.candidates[0].content.parts[0].text;
                return JSON.parse(aiContent).questions;
            } catch (error) {
                console.error(error);
                alert('Không thể tạo đề thi bằng AI. Vui lòng thử lại sau.');
                return [];
            }
        }

        // Import từ Word
        async function importFromWord() {
            const fileInput = document.getElementById('wordFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Vui lòng chọn file Word!');
                return [];
            }

            const reader = new FileReader();
            return new Promise((resolve) => {
                reader.onload = async function () {
                    const arrayBuffer = reader.result;
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    const text = result.value;
                    resolve([{ text, type: 'tuluan', options: [{ answer: text }] }]);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Import từ Hình Ảnh (OCR)
        async function importFromImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Vui lòng chọn hình ảnh!');
                return [];
            }

            const imageUrl = URL.createObjectURL(file);
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('previewImage').style.display = 'block';

            return new Promise((resolve) => {
                Tesseract.recognize(
                    file,
                    'vie',
                    { logger: m => console.log(m) }
                ).then(({ data: { text } }) => {
                    resolve([{ text, type: 'tuluan', options: [{ answer: text }] }]);
                });
            });
        }

        // QR Code
        function showQRCode(examId) {
            const shareLink = `https://yourdomain.com/take-exam.html?id=${examId}`;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), {
                text: shareLink,
                width: 200,
                height: 200
            });
            
            document.getElementById('shareLink').href = shareLink;
            document.getElementById('qrContainer').style.display = 'block';
        }

        // Anti-cheating
        document.addEventListener('copy', (e) => {
            if(document.getElementById('antiCheating').checked) {
                e.preventDefault();
                alert('Không được phép sao chép trong khi làm bài!');
            }
        });

        document.addEventListener('visibilitychange', () => {
            if(document.getElementById('antiCheating').checked && document.visibilityState === 'hidden') {
                alert('Bạn đã chuyển tab! Bài thi sẽ tự đông được nộp.');
            }
        });
    </script>
</body>
</html>
