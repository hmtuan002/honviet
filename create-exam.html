<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tạo đề thi Văn học</title>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f8ff;
      color: #003366;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    h1 {
      margin-bottom: 1rem;
      font-weight: 700;
      color: #0059b3;
    }
    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 89, 179, 0.2);
      width: 100%;
      max-width: 900px;
      padding: 1rem 2rem 2rem 2rem;
    }
    label {
      display: block;
      margin: 0.5rem 0 0.25rem 0;
      font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1.5px solid #a9c9ff;
      border-radius: 5px;
      font-size: 1rem;
      color: #003366;
      background: #e6f0ff;
      resize: vertical;
    }
    textarea {
      min-height: 60px;
    }
    button {
      background-color: #3399ff;
      border: none;
      color: white;
      padding: 0.6rem 1.2rem;
      margin-top: 1rem;
      font-size: 1.1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    button:hover {
      background-color: #0073e6;
    }
    .btn-secondary {
      background-color: #cce4ff;
      color: #003366;
    }
    .btn-secondary:hover {
      background-color: #99ccff;
    }
    .section {
      margin-top: 1.5rem;
      border-top: 1px solid #cce4ff;
      padding-top: 1rem;
    }
    .question-list {
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #a9c9ff;
      border-radius: 6px;
      padding: 0.5rem;
      background: #f7fbff;
    }
    .question-item {
      border-bottom: 1px solid #a9c9ff;
      padding: 0.5rem 0;
    }
    .question-item:last-child {
      border-bottom: none;
    }
    .flex-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .flex-grow {
      flex-grow: 1;
    }
    .small-input {
      width: 80px;
    }
    .error {
      color: #cc0000;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .success {
      color: #006600;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .loading {
      color: #0059b3;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 26px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #3399ff;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    .qr-code {
      margin-top: 1rem;
      text-align: center;
    }
    .qr-code img {
      width: 150px;
      height: 150px;
    }
    .file-input-label {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #3399ff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .file-input-label:hover {
      background-color: #0073e6;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <h1><i class="fas fa-file-alt"></i> Tạo đề thi Văn học</h1>
  <div class="container">
    <form id="examForm">
      <label for="examTitle">Tiêu đề đề thi:</label>
      <input type="text" id="examTitle" name="examTitle" required placeholder="Nhập tiêu đề đề thi" />

      <label for="examDuration">Thời gian thi (phút):</label>
      <input type="number" id="examDuration" name="examDuration" min="1" max="180" value="60" required />

      <div class="section">
        <h2><i class="fas fa-pencil-alt"></i> Tạo đề thủ công</h2>
        <div id="manualQuestionForm">
          <label for="questionType">Loại câu hỏi:</label>
          <select id="questionType" required>
            <option value="multiple-choice">Trắc nghiệm (A, B, C, D)</option>
            <option value="true-false">Đúng/Sai</option>
            <option value="short-answer">Trả lời ngắn / Tự luận</option>
          </select>

          <label for="questionContent">Nội dung câu hỏi:</label>
          <textarea id="questionContent" rows="3" required placeholder="Nhập nội dung câu hỏi"></textarea>

          <div id="answerOptionsContainer" style="display: block;">
            <label>Đáp án:</label>
            <div class="flex-row" style="gap: 0.5rem;">
              <input type="text" class="answer-option" placeholder="A" />
              <input type="text" class="answer-option" placeholder="B" />
              <input type="text" class="answer-option" placeholder="C" />
              <input type="text" class="answer-option" placeholder="D" />
            </div>
          </div>

          <div id="trueFalseContainer" style="display: none;">
            <label>Chọn đáp án đúng:</label>
            <select id="trueFalseAnswer">
              <option value="true">Đúng</option>
              <option value="false">Sai</option>
            </select>
          </div>

          <div id="shortAnswerContainer" style="display: none;">
            <label for="shortAnswerKey">Đáp án mẫu (dùng để chấm):</label>
            <textarea id="shortAnswerKey" rows="2" placeholder="Nhập đáp án mẫu"></textarea>
          </div>

          <label>Chọn đáp án đúng:</label>
          <select id="correctAnswer" required>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>

          <button type="button" id="addQuestionBtn"><i class="fas fa-plus"></i> Thêm câu hỏi</button>
        </div>

        <div class="question-list" id="questionList" aria-live="polite" aria-label="Danh sách câu hỏi đã thêm">
          <!-- Danh sách câu hỏi sẽ hiển thị ở đây -->
        </div>
      </div>

      <div class="section">
        <h2><i class="fas fa-robot"></i> Tạo đề bằng AI (Gemini)</h2>
        <label for="aiPrompt">Mô tả đề thi (ví dụ: Đề thi Văn học lớp 10, gồm 5 câu trắc nghiệm, 2 câu tự luận):</label>
        <textarea id="aiPrompt" rows="3" placeholder="Nhập mô tả đề thi để AI tạo đề"></textarea>
        <button type="button" id="generateAIExamBtn"><i class="fas fa-magic"></i> Tạo đề bằng AI</button>
        <div id="aiStatus" role="status" aria-live="polite"></div>
      </div>

      <div class="section">
        <h2><i class="fas fa-file-word"></i> Nhập đề từ file Word</h2>
        <label for="wordFileInput" class="file-input-label"><i class="fas fa-upload"></i> Chọn file Word (.docx)</label>
        <input type="file" id="wordFileInput" accept=".doc,.docx" />
        <div id="wordStatus" role="status" aria-live="polite"></div>
      </div>

      <div class="section">
        <h2><i class="fas fa-camera"></i> Nhập đề từ hình ảnh</h2>
        <label for="imageFileInput" class="file-input-label"><i class="fas fa-upload"></i> Tải ảnh lên</label>
        <input type="file" id="imageFileInput" accept="image/*" />
        <button type="button" id="openCameraBtn"><i class="fas fa-camera"></i> Mở camera chụp ảnh</button>
        <video id="cameraStream" width="320" height="240" autoplay style="display:none; margin-top:10px; border-radius:8px;"></video>
        <button type="button" id="capturePhotoBtn" style="display:none; margin-top:10px;"><i class="fas fa-camera-retro"></i> Chụp ảnh</button>
        <canvas id="photoCanvas" width="320" height="240" style="display:none;"></canvas>
        <div id="imageStatus" role="status" aria-live="polite"></div>
      </div>

      <div class="section">
        <h2><i class="fas fa-shield-alt"></i> Tùy chỉnh chống gian lận</h2>
        <label>
          <span>Chống sao chép (copy-paste):</span>
          <label class="toggle-switch">
            <input type="checkbox" id="antiCopy" />
            <span class="slider"></span>
          </label>
        </label>
        <label>
          <span>Chống chuyển tab / tra cứu:</span>
          <label class="toggle-switch">
            <input type="checkbox" id="antiTabSwitch" />
            <span class="slider"></span>
          </label>
        </label>
      </div>

      <button type="submit" id="saveExamBtn"><i class="fas fa-save"></i> Lưu đề thi</button>
      <div id="formStatus" role="alert" aria-live="assertive"></div>
    </form>

    <div class="qr-code" id="qrCodeContainer" aria-live="polite"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- QRCode library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Docx parser (mammoth.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
      authDomain: "literatureexamapp.firebaseapp.com",
      projectId: "literatureexamapp",
      storageBucket: "literatureexamapp.firebasestorage.app",
      messagingSenderId: "829681704033",
      appId: "1:829681704033:web:f92a79de0c177b235b9e20"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Gemini AI config
    const GEMINI_API_KEY = 'AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM';
    const GEMINI_MODEL = 'gemini-2.5-flash-preview-05-20';

    // State
    let questions = [];

    // Elements
    const questionTypeSelect = document.getElementById('questionType');
    const questionContentInput = document.getElementById('questionContent');
    const answerOptionsContainer = document.getElementById('answerOptionsContainer');
    const trueFalseContainer = document.getElementById('trueFalseContainer');
    const shortAnswerContainer = document.getElementById('shortAnswerContainer');
    const correctAnswerSelect = document.getElementById('correctAnswer');
    const trueFalseAnswerSelect = document.getElementById('trueFalseAnswer');
    const shortAnswerKeyInput = document.getElementById('shortAnswerKey');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const questionList = document.getElementById('questionList');
    const aiPromptInput = document.getElementById('aiPrompt');
    const generateAIExamBtn = document.getElementById('generateAIExamBtn');
    const aiStatus = document.getElementById('aiStatus');
    const wordFileInput = document.getElementById('wordFileInput');
    const wordStatus = document.getElementById('wordStatus');
    const imageFileInput = document.getElementById('imageFileInput');
    const imageStatus = document.getElementById('imageStatus');
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraStream = document.getElementById('cameraStream');
    const capturePhotoBtn = document.getElementById('capturePhotoBtn');
    const photoCanvas = document.getElementById('photoCanvas');
    const antiCopyCheckbox = document.getElementById('antiCopy');
    const antiTabSwitchCheckbox = document.getElementById('antiTabSwitch');
    const saveExamBtn = document.getElementById('saveExamBtn');
    const formStatus = document.getElementById('formStatus');
    const qrCodeContainer = document.getElementById('qrCodeContainer');

    // Show/hide input fields theo loại câu hỏi
    function updateQuestionInputUI() {
      const type = questionTypeSelect.value;
      answerOptionsContainer.style.display = 'none';
      trueFalseContainer.style.display = 'none';
      shortAnswerContainer.style.display = 'none';
      correctAnswerSelect.style.display = 'inline-block';

      if (type === 'multiple-choice') {
        answerOptionsContainer.style.display = 'block';
        correctAnswerSelect.style.display = 'inline-block';
        correctAnswerSelect.innerHTML = `
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        `;
      } else if (type === 'true-false') {
        trueFalseContainer.style.display = 'block';
        correctAnswerSelect.style.display = 'none';
      } else if (type === 'short-answer') {
        shortAnswerContainer.style.display = 'block';
        correctAnswerSelect.style.display = 'none';
      }
    }
    questionTypeSelect.addEventListener('change', updateQuestionInputUI);
    updateQuestionInputUI();

    // Thêm câu hỏi thủ công
    addQuestionBtn.addEventListener('click', () => {
      const type = questionTypeSelect.value;
      const content = questionContentInput.value.trim();
      if (!content) {
        alert('Vui lòng nhập nội dung câu hỏi.');
        return;
      }

      let question = {
        id: Date.now(),
        type,
        content,
      };

      if (type === 'multiple-choice') {
        const answerInputs = document.querySelectorAll('.answer-option');
        const options = [];
        for (let i = 0; i < answerInputs.length; i++) {
          const val = answerInputs[i].value.trim();
          if (!val) {
            alert(`Vui lòng nhập đáp án ${String.fromCharCode(65 + i)}.`);
            return;
          }
          options.push(val);
        }
        const correct = correctAnswerSelect.value;
        question.options = options;
        question.correct = correct;
      } else if (type === 'true-false') {
        const correct = trueFalseAnswerSelect.value === 'true';
        question.correct = correct;
      } else if (type === 'short-answer') {
        const answerKey = shortAnswerKeyInput.value.trim();
        if (!answerKey) {
          alert('Vui lòng nhập đáp án mẫu cho câu hỏi tự luận/trả lời ngắn.');
          return;
        }
        question.answerKey = answerKey;
      }

      questions.push(question);
      renderQuestionList();
      clearQuestionForm();
    });

    // Xóa câu hỏi
    function deleteQuestion(id) {
      questions = questions.filter(q => q.id !== id);
      renderQuestionList();
    }

    // Hiển thị danh sách câu hỏi
    function renderQuestionList() {
      if (questions.length === 0) {
        questionList.innerHTML = '<p>Chưa có câu hỏi nào.</p>';
        return;
      }
      questionList.innerHTML = '';
      questions.forEach((q, idx) => {
        const div = document.createElement('div');
        div.className = 'question-item';
        let html = `<strong>Câu ${idx + 1} (${q.type === 'multiple-choice' ? 'Trắc nghiệm' : q.type === 'true-false' ? 'Đúng/Sai' : 'Tự luận'})</strong><br/>`;
        html += `<p>${q.content}</p>`;
        if (q.type === 'multiple-choice') {
          html += '<ul>';
          q.options.forEach((opt, i) => {
            const letter = String.fromCharCode(65 + i);
            const isCorrect = letter === q.correct ? ' <strong>(Đáp án đúng)</strong>' : '';
            html += `<li>${letter}. ${opt}${isCorrect}</li>`;
          });
          html += '</ul>';
        } else if (q.type === 'true-false') {
          html += `<p>Đáp án đúng: <strong>${q.correct ? 'Đúng' : 'Sai'}</strong></p>`;
        } else if (q.type === 'short-answer') {
          html += `<p>Đáp án mẫu: <em>${q.answerKey}</em></p>`;
        }
        html += `<button type="button" aria-label="Xóa câu hỏi ${idx + 1}" onclick="deleteQuestion(${q.id})" style="background:#cc0000; color:white; border:none; padding:0.3rem 0.6rem; border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i> Xóa</button>`;
        div.innerHTML = html;
        questionList.appendChild(div);
      });
    }

    // Xóa form nhập câu hỏi
    function clearQuestionForm() {
      questionContentInput.value = '';
      const answerInputs = document.querySelectorAll('.answer-option');
      answerInputs.forEach(input => (input.value = ''));
      shortAnswerKeyInput.value = '';
    }

    // Gọi API Gemini tạo đề AI
    async function generateExamByAI(prompt) {
      aiStatus.textContent = 'Đang tạo đề bằng AI...';
      try {
        // Giả lập gọi API Gemini (thay bằng endpoint thật của bạn)
        const response = await fetch('https://api.example.com/gemini/generateExam', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GEMINI_API_KEY}`
          },
          body: JSON.stringify({
            model: GEMINI_MODEL,
            prompt: prompt,
            max_tokens: 2000
          })
        });
        if (!response.ok) {
          throw new Error(`Lỗi API: ${response.statusText}`);
        }
        const data = await response.json();
        // Giả sử data.exam là mảng câu hỏi JSON
        if (!data.exam || !Array.isArray(data.exam)) {
          throw new Error('Dữ liệu đề thi không đúng định dạng.');
        }
        questions = data.exam;
        renderQuestionList();
        aiStatus.textContent = 'Tạo đề thành công!';
      } catch (error) {
        aiStatus.textContent = `Lỗi khi tạo đề AI: ${error.message}`;
      }
    }

    generateAIExamBtn.addEventListener('click', () => {
      const prompt = aiPromptInput.value.trim();
      if (!prompt) {
        alert('Vui lòng nhập mô tả đề thi để AI tạo đề.');
        return;
      }
      generateExamByAI(prompt);
    });

    // Xử lý nhập đề từ file Word (.docx)
    wordFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      wordStatus.textContent = 'Đang đọc file Word...';
      try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        const text = result.value;
        wordStatus.textContent = 'Gửi nội dung file tới AI để tạo đề...';

        // Gọi API Gemini để tạo đề từ text
        const response = await fetch('https://api.example.com/gemini/generateExam', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GEMINI_API_KEY}`
          },
          body: JSON.stringify({
            model: GEMINI_MODEL,
            prompt: `Tạo đề thi văn học từ nội dung sau:\n${text}`,
            max_tokens: 2000
          })
        });
        if (!response.ok) {
          throw new Error(`Lỗi API: ${response.statusText}`);
        }
        const data = await response.json();
        if (!data.exam || !Array.isArray(data.exam)) {
          throw new Error('Dữ liệu đề thi không đúng định dạng.');
        }
        questions = data.exam;
        renderQuestionList();
        wordStatus.textContent = 'Tạo đề thành công từ file Word!';
      } catch (error) {
        wordStatus.textContent = `Lỗi khi xử lý file Word: ${error.message}`;
      }
      wordFileInput.value = '';
    });

    // Xử lý nhập đề từ hình ảnh
    imageFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      await processImageFile(file);
      imageFileInput.value = '';
    });

    async function processImageFile(file) {
      imageStatus.textContent = 'Đang đọc ảnh và gửi AI...';
      try {
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          // Gọi API Gemini để OCR và tạo đề
          const response = await fetch('https://api.example.com/gemini/generateExamFromImage', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${GEMINI_API_KEY}`
            },
            body: JSON.stringify({
              model: GEMINI_MODEL,
              imageBase64: base64,
              prompt: 'Tạo đề thi văn học từ nội dung ảnh này.'
            })
          });
          if (!response.ok) {
            throw new Error(`Lỗi API: ${response.statusText}`);
          }
          const data = await response.json();
          if (!data.exam || !Array.isArray(data.exam)) {
            throw new Error('Dữ liệu đề thi không đúng định dạng.');
          }
          questions = data.exam;
          renderQuestionList();
          imageStatus.textContent = 'Tạo đề thành công từ ảnh!';
        };
        reader.readAsDataURL(file);
      } catch (error) {
        imageStatus.textContent = `Lỗi khi xử lý ảnh: ${error.message}`;
      }
    }

    // Mở camera chụp ảnh
    openCameraBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Trình duyệt không hỗ trợ camera.');
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraStream.srcObject = stream;
        cameraStream.style.display = 'block';
        capturePhotoBtn.style.display = 'inline-block';
        openCameraBtn.disabled = true;
      } catch (err) {
        alert('Không thể truy cập camera: ' + err.message);
      }
    });

    // Chụp ảnh từ camera và xử lý
    capturePhotoBtn.addEventListener('click', () => {
      const context = photoCanvas.getContext('2d');
      context.drawImage(cameraStream, 0, 0, photoCanvas.width, photoCanvas.height);
      cameraStream.srcObject.getTracks().forEach(track => track.stop());
      cameraStream.style.display = 'none';
      capturePhotoBtn.style.display = 'none';
      openCameraBtn.disabled = false;

      photoCanvas.toBlob(async (blob) => {
        if (!blob) {
          imageStatus.textContent = 'Lỗi khi chụp ảnh.';
          return;
        }
        await processImageFile(blob);
      }, 'image/jpeg');
    });

    // Lưu đề thi lên Firestore
    document.getElementById('examForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      formStatus.textContent = '';
      if (questions.length === 0) {
        alert('Vui lòng thêm ít nhất một câu hỏi cho đề thi.');
        return;
      }
      const title = document.getElementById('examTitle').value.trim();
      if (!title) {
        alert('Vui lòng nhập tiêu đề đề thi.');
        return;
      }
      const duration = parseInt(document.getElementById('examDuration').value);
      if (isNaN(duration) || duration < 1) {
        alert('Thời gian thi không hợp lệ.');
        return;
      }
      const antiCopy = antiCopyCheckbox.checked;
      const antiTabSwitch = antiTabSwitchCheckbox.checked;

      const examData = {
        title,
        duration,
        questions,
        antiCopy,
        antiTabSwitch,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      };

      formStatus.textContent = 'Đang lưu đề thi...';

      try {
        const docRef = await db.collection('exams').add(examData);
        formStatus.textContent = 'Lưu đề thi thành công!';

        // Tạo link chia sẻ
        const examId = docRef.id;
        const shareUrl = `${window.location.origin}/take-exam.html?examId=${examId}`;

        // Tạo mã QR
        qrCodeContainer.innerHTML = '<p>Mã QR và link chia sẻ đề thi:</p>';
        QRCode.toCanvas(shareUrl, { width: 150 }, (err, canvas) => {
          if (err) {
            qrCodeContainer.innerHTML += '<p>Lỗi tạo mã QR.</p>';
            return;
          }
          qrCodeContainer.appendChild(canvas);
          const linkElem = document.createElement('p');
          linkElem.innerHTML = `<a href="${shareUrl}" target="_blank" rel="noopener noreferrer">${shareUrl}</a>`;
          qrCodeContainer.appendChild(linkElem);
        });

        // Reset form và trạng thái
        questions = [];
        renderQuestionList();
        document.getElementById('examForm').reset();
        updateQuestionInputUI();
      } catch (error) {
        formStatus.textContent = `Lỗi khi lưu đề thi: ${error.message}`;
      }
    });

    // Chống gian lận copy-paste và chuyển tab
    if (antiCopyCheckbox) {
      antiCopyCheckbox.addEventListener('change', () => {
        if (antiCopyCheckbox.checked) {
          document.addEventListener('copy', handleCopyPaste);
          document.addEventListener('paste', handleCopyPaste);
        } else {
          document.removeEventListener('copy', handleCopyPaste);
          document.removeEventListener('paste', handleCopyPaste);
        }
      });
    }
    function handleCopyPaste(e) {
      alert('Hành động sao chép/dán bị cấm trong bài thi. Bài thi sẽ tự động nộp.');
      // TODO: Gửi thông báo và tự động nộp bài thi nếu đang thi (ở đây chỉ cảnh báo)
    }

    if (antiTabSwitchCheckbox) {
      antiTabSwitchCheckbox.addEventListener('change', () => {
        if (antiTabSwitchCheckbox.checked) {
          window.addEventListener('blur', handleTabSwitch);
        } else {
          window.removeEventListener('blur', handleTabSwitch);
        }
      });
    }
    function handleTabSwitch() {
      alert('Chuyển tab bị phát hiện. Bài thi sẽ tự động nộp.');
      // TODO: Gửi thông báo và tự động nộp bài thi nếu đang thi (ở đây chỉ cảnh báo)
    }

    // Expose deleteQuestion cho onclick inline
    window.deleteQuestion = deleteQuestion;

    // Khởi tạo danh sách câu hỏi trống
    renderQuestionList();
  </script>
</body>
</html>
