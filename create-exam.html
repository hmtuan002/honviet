<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đề Thi Văn Học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #e6f2ff;
            --accent-color: #5d9cec;
            --text-color: #333;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: #f5f7fa;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 137, 220, 0.25);
        }
        
        .question-item {
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 20px;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .step {
            text-align: center;
            position: relative;
            flex: 1;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background-color: #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: #666;
            font-weight: bold;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step.completed .step-number {
            background-color: #8bc34a;
            color: white;
        }
        
        .step-title {
            font-size: 14px;
            color: #666;
        }
        
        .step.active .step-title {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .step.completed .step-title {
            color: #8bc34a;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 2px;
            background-color: #ddd;
            z-index: -1;
        }
        
        .step.completed:not(:last-child)::after {
            background-color: #8bc34a;
        }
        
        .preview-container {
            border: 1px dashed #ccc;
            padding: 20px;
            border-radius: 5px;
            background-color: white;
        }
        
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .exam-link {
            background-color: var(--secondary-color);
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
        
        .camera-preview {
            width: 100%;
            height: 300px;
            background-color: #eee;
            margin-bottom: 15px;
            display: none;
        }
        
        #capturedImage {
            max-width: 100%;
            display: none;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>Văn Học Exam
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="create-exam.html"><i class="fas fa-plus-circle me-1"></i> Tạo đề</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="take-exam.html"><i class="fas fa-pen me-1"></i> Thi thử</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="manage-exam.html"><i class="fas fa-clipboard-list me-1"></i> Quản lý</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html"><i class="fas fa-sign-out-alt me-1"></i> Đăng xuất</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Tạo Đề Thi Mới</h4>
                    </div>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator px-4 pt-4">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <div class="step-title">Thông tin đề thi</div>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="step-title">Tạo câu hỏi</div>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <div class="step-title">Cài đặt</div>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-number">4</div>
                            <div class="step-title">Hoàn thành</div>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Step 1: Exam Info -->
                        <div class="tab-pane fade show active" id="step1-content">
                            <form id="examInfoForm">
                                <div class="mb-3">
                                    <label for="examTitle" class="form-label">Tiêu đề đề thi <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="examTitle" required placeholder="Ví dụ: Đề thi thử THPT Quốc gia môn Văn 2024">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="examDuration" class="form-label">Thời gian làm bài (phút) <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="examDuration" min="1" required value="60">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="examSubject" class="form-label">Môn học</label>
                                        <select class="form-select" id="examSubject">
                                            <option selected value="Ngữ Văn">Ngữ Văn</option>
                                            <option value="Văn học">Văn học</option>
                                            <option value="Tiếng Việt">Tiếng Việt</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="examDescription" class="form-label">Mô tả đề thi</label>
                                    <textarea class="form-control" id="examDescription" rows="3" placeholder="Mô tả ngắn gọn về đề thi"></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary" disabled>
                                        <i class="fas fa-arrow-left me-1"></i> Quay lại
                                    </button>
                                    <button type="button" class="btn btn-primary" id="nextToStep2">
                                        Tiếp theo <i class="fas fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Step 2: Create Questions -->
                        <div class="tab-pane fade" id="step2-content">
                            <ul class="nav nav-tabs mb-4" id="questionTypeTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button">
                                        <i class="fas fa-pen me-1"></i> Tạo thủ công
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button">
                                        <i class="fas fa-robot me-1"></i> Tạo bằng AI
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="word-tab" data-bs-toggle="tab" data-bs-target="#word" type="button">
                                        <i class="fas fa-file-word me-1"></i> Nhập từ Word
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image" type="button">
                                        <i class="fas fa-image me-1"></i> Nhập từ ảnh
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="questionTypeTabContent">
                                <!-- Manual Creation -->
                                <div class="tab-pane fade show active" id="manual" role="tabpanel">
                                    <div id="questionsContainer">
                                        <div class="question-item">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5>Câu hỏi 1</h5>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(this)">
                                                    <i class="fas fa-trash"></i> Xóa
                                                </button>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Nội dung câu hỏi <span class="text-danger">*</span></label>
                                                <textarea class="form-control question-content" rows="2" required placeholder="Nhập nội dung câu hỏi"></textarea>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Loại câu hỏi <span class="text-danger">*</span></label>
                                                <select class="form-select question-type" onchange="changeQuestionType(this)">
                                                    <option value="multiple-choice">Trắc nghiệm (A, B, C, D)</option>
                                                    <option value="true-false">Đúng/Sai</option>
                                                    <option value="short-answer">Trả lời ngắn</option>
                                                    <option value="essay">Tự luận</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Multiple Choice Options -->
                                            <div class="question-options multiple-choice-options">
                                                <div class="mb-2">
                                                    <label class="form-label">Đáp án <span class="text-danger">*</span></label>
                                                    <div class="input-group mb-2">
                                                        <span class="input-group-text">A</span>
                                                        <input type="text" class="form-control option-input" placeholder="Đáp án A">
                                                        <div class="input-group-text">
                                                            <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer1" value="A">
                                                        </div>
                                                    </div>
                                                    <div class="input-group mb-2">
                                                        <span class="input-group-text">B</span>
                                                        <input type="text" class="form-control option-input" placeholder="Đáp án B">
                                                        <div class="input-group-text">
                                                            <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer1" value="B">
                                                        </div>
                                                    </div>
                                                    <div class="input-group mb-2">
                                                        <span class="input-group-text">C</span>
                                                        <input type="text" class="form-control option-input" placeholder="Đáp án C">
                                                        <div class="input-group-text">
                                                            <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer1" value="C">
                                                        </div>
                                                    </div>
                                                    <div class="input-group mb-2">
                                                        <span class="input-group-text">D</span>
                                                        <input type="text" class="form-control option-input" placeholder="Đáp án D">
                                                        <div class="input-group-text">
                                                            <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer1" value="D">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- True/False Options -->
                                            <div class="question-options true-false-options" style="display: none;">
                                                <div class="mb-2">
                                                    <label class="form-label">Đáp án <span class="text-danger">*</span></label>
                                                    <div class="form-check">
                                                        <input class="form-check-input correct-answer" type="radio" name="correctTFAnswer1" id="true1" value="true">
                                                        <label class="form-check-label" for="true1">Đúng</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input correct-answer" type="radio" name="correctTFAnswer1" id="false1" value="false">
                                                        <label class="form-check-label" for="false1">Sai</label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Short Answer/Essay Options -->
                                            <div class="question-options short-answer-options" style="display: none;">
                                                <div class="mb-3">
                                                    <label class="form-label">Đáp án mẫu <span class="text-danger">*</span></label>
                                                    <textarea class="form-control model-answer" rows="3" placeholder="Nhập đáp án mẫu"></textarea>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Điểm số <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control question-points" min="0.1" step="0.1" value="1">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary mt-3" onclick="addNewQuestion()">
                                        <i class="fas fa-plus me-1"></i> Thêm câu hỏi
                                    </button>
                                    
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-outline-secondary" id="backToStep1">
                                            <i class="fas fa-arrow-left me-1"></i> Quay lại
                                        </button>
                                        <button type="button" class="btn btn-primary" id="nextToStep3">
                                            Tiếp theo <i class="fas fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- AI Generation -->
                                <div class="tab-pane fade" id="ai" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="aiPrompt" class="form-label">Mô tả đề thi bạn muốn tạo <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="aiPrompt" rows="5" placeholder="Ví dụ: Tạo một đề thi Ngữ Văn lớp 12 với 5 câu hỏi trắc nghiệm về tác phẩm 'Vợ chồng A Phủ', 2 câu hỏi đúng sai về tác giả Tô Hoài, và 1 câu tự luận phân tích nhân vật Mị. Thời gian làm bài 45 phút."></textarea>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary" id="backToStep1FromAI">
                                            <i class="fas fa-arrow-left me-1"></i> Quay lại
                                        </button>
                                        <button type="button" class="btn btn-primary" id="generateWithAI">
                                            <i class="fas fa-magic me-1"></i> Tạo đề với AI
                                        </button>
                                    </div>
                                    
                                    <div class="mt-4" id="aiGeneratedQuestions" style="display: none;">
                                        <h5>Đề thi được tạo bởi AI</h5>
                                        <div id="aiQuestionsContainer"></div>
                                        
                                        <div class="d-flex justify-content-between mt-3">
                                            <button type="button" class="btn btn-outline-danger" id="rejectAIQuestions">
                                                <i class="fas fa-times me-1"></i> Bỏ qua
                                            </button>
                                            <button type="button" class="btn btn-success" id="acceptAIQuestions">
                                                <i class="fas fa-check me-1"></i> Chấp nhận
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Word Import -->
                                <div class="tab-pane fade" id="word" role="tabpanel">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i> Hệ thống sẽ sử dụng AI để phân tích file Word và tạo đề thi tự động. Vui lòng đảm bảo file Word có cấu trúc rõ ràng.
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label">Chọn file Word (.docx) <span class="text-danger">*</span></label>
                                        <input class="form-control" type="file" id="wordFile" accept=".docx">
                                    </div>
                                    
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary" id="backToStep1FromWord">
                                            <i class="fas fa-arrow-left me-1"></i> Quay lại
                                        </button>
                                        <button type="button" class="btn btn-primary" id="importFromWord">
                                            <i class="fas fa-file-import me-1"></i> Nhập đề thi
                                        </button>
                                    </div>
                                    
                                    <div class="mt-4" id="wordGeneratedQuestions" style="display: none;">
                                        <h5>Đề thi được tạo từ file Word</h5>
                                        <div id="wordQuestionsContainer"></div>
                                        
                                        <div class="d-flex justify-content-between mt-3">
                                            <button type="button" class="btn btn-outline-danger" id="rejectWordQuestions">
                                                <i class="fas fa-times me-1"></i> Bỏ qua
                                            </button>
                                            <button type="button" class="btn btn-success" id="acceptWordQuestions">
                                                <i class="fas fa-check me-1"></i> Chấp nhận
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Image Import -->
                                <div class="tab-pane fade" id="image" role="tabpanel">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i> Bạn có thể tải lên hình ảnh chứa đề thi hoặc chụp ảnh trực tiếp. Hệ thống sẽ sử dụng AI để nhận dạng và tạo đề thi.
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Chọn phương thức nhập <span class="text-danger">*</span></label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="imageInputMethod" id="uploadImage" value="upload" checked>
                                            <label class="form-check-label" for="uploadImage">Tải lên hình ảnh</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="imageInputMethod" id="captureImage" value="capture">
                                            <label class="form-check-label" for="captureImage">Chụp ảnh bằng camera</label>
                                        </div>
                                    </div>
                                    
                                    <!-- Upload Image -->
                                    <div id="uploadImageSection">
                                        <div class="mb-3">
                                            <label for="imageFile" class="form-label">Chọn file ảnh <span class="text-danger">*</span></label>
                                            <input class="form-control" type="file" id="imageFile" accept="image/*">
                                        </div>
                                    </div>
                                    
                                    <!-- Capture Image -->
                                    <div id="captureImageSection" style="display: none;">
                                        <div class="camera-preview" id="cameraPreview"></div>
                                        <video id="video" width="100%" autoplay style="display: none;"></video>
                                        <canvas id="canvas" style="display: none;"></canvas>
                                        <img id="capturedImage" alt="Ảnh đã chụp">
                                        
                                        <div class="d-flex gap-2 mb-3">
                                            <button type="button" class="btn btn-primary" id="startCamera">
                                                <i class="fas fa-camera me-1"></i> Bật Camera
                                            </button>
                                            <button type="button" class="btn btn-success" id="takePhoto" disabled>
                                                <i class="fas fa-camera-retro me-1"></i> Chụp ảnh
                                            </button>
                                            <button type="button" class="btn btn-danger" id="retakePhoto" disabled>
                                                <i class="fas fa-redo me-1"></i> Chụp lại
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary" id="backToStep1FromImage">
                                            <i class="fas fa-arrow-left me-1"></i> Quay lại
                                        </button>
                                        <button type="button" class="btn btn-primary" id="importFromImage" disabled>
                                            <i class="fas fa-image me-1"></i> Nhận dạng đề thi
                                        </button>
                                    </div>
                                    
                                    <div class="mt-4" id="imageGeneratedQuestions" style="display: none;">
                                        <h5>Đề thi được tạo từ ảnh</h5>
                                        <div id="imageQuestionsContainer"></div>
                                        
                                        <div class="d-flex justify-content-between mt-3">
                                            <button type="button" class="btn btn-outline-danger" id="rejectImageQuestions">
                                                <i class="fas fa-times me-1"></i> Bỏ qua
                                            </button>
                                            <button type="button" class="btn btn-success" id="acceptImageQuestions">
                                                <i class="fas fa-check me-1"></i> Chấp nhận
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Exam Settings -->
                        <div class="tab-pane fade" id="step3-content">
                            <h5 class="mb-4">Cài đặt bổ sung</h5>
                            
                            <div class="mb-4">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="antiCheatCopyPaste" checked>
                                    <label class="form-check-label" for="antiCheatCopyPaste">Chống sao chép nội dung (ngăn copy/paste)</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="antiCheatTabSwitch" checked>
                                    <label class="form-check-label" for="antiCheatTabSwitch">Chống chuyển tab/ứng dụng (tự động nộp bài nếu phát hiện)</label>
                                </div>
                                
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="notifyCheating" checked>
                                    <label class="form-check-label" for="notifyCheating">Thông báo khi phát hiện gian lận</label>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6>Xem trước đề thi</h6>
                                <div class="preview-container" id="examPreview">
                                    <p class="text-muted">Xem trước đề thi sẽ hiển thị ở đây...</p>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep2">
                                    <i class="fas fa-arrow-left me-1"></i> Quay lại
                                </button>
                                <button type="button" class="btn btn-primary" id="nextToStep4">
                                    <i class="fas fa-check-circle me-1"></i> Hoàn thành
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Completion -->
                        <div class="tab-pane fade" id="step4-content">
                            <div class="text-center mb-4">
                                <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                                <h3 class="mt-3">Đề thi đã được tạo thành công!</h3>
                                <p class="text-muted">Bây giờ bạn có thể chia sẻ đề thi này với người khác</p>
                            </div>
                            
                            <div class="qr-code-container mb-4">
                                <div id="qrCode" class="mb-3"></div>
                                <p>Quét mã QR để tham gia thi</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Link đề thi:</label>
                                    <div class="exam-link" id="examLink">https://vanhocexam.com/take-exam?id=ABC123</div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-center gap-3">
                                <button type="button" class="btn btn-outline-primary" id="copyLinkBtn">
                                    <i class="fas fa-copy me-1"></i> Sao chép link
                                </button>
                                <button type="button" class="btn btn-primary" id="viewExamBtn">
                                    <i class="fas fa-eye me-1"></i> Xem đề thi
                                </button>
                                <button type="button" class="btn btn-success" id="manageExamBtn">
                                    <i class="fas fa-clipboard-list me-1"></i> Quản lý đề
                                </button>
                            </div>
                            
                            <div class="d-flex justify-content-center mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="createNewExamBtn">
                                    <i class="fas fa-plus me-1"></i> Tạo đề thi mới
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
            authDomain: "literatureexamapp.firebaseapp.com",
            projectId: "literatureexamapp",
            storageBucket: "literatureexamapp.appspot.com",
            messagingSenderId: "829681704033",
            appId: "1:829681704033:web:f92a79de0c177b235b9e20"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Current exam data
        let currentExam = {
            title: '',
            duration: 60,
            subject: 'Ngữ Văn',
            description: '',
            questions: [],
            settings: {
                antiCheatCopyPaste: true,
                antiCheatTabSwitch: true,
                notifyCheating: true
            },
            createdAt: new Date(),
            createdBy: '',
            examId: ''
        };

        // DOM elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step1Content = document.getElementById('step1-content');
        const step2Content = document.getElementById('step2-content');
        const step3Content = document.getElementById('step3-content');
        const step4Content = document.getElementById('step4-content');
        
        // Navigation buttons
        document.getElementById('nextToStep2').addEventListener('click', goToStep2);
        document.getElementById('backToStep1').addEventListener('click', goToStep1);
        document.getElementById('backToStep1FromAI').addEventListener('click', goToStep1);
        document.getElementById('backToStep1FromWord').addEventListener('click', goToStep1);
        document.getElementById('backToStep1FromImage').addEventListener('click', goToStep1);
        document.getElementById('nextToStep3').addEventListener('click', goToStep3);
        document.getElementById('backToStep2').addEventListener('click', goToStep2FromStep3);
        document.getElementById('nextToStep4').addEventListener('click', goToStep4);
        
        // Final step buttons
        document.getElementById('copyLinkBtn').addEventListener('click', copyExamLink);
        document.getElementById('viewExamBtn').addEventListener('click', viewExam);
        document.getElementById('manageExamBtn').addEventListener('click', manageExam);
        document.getElementById('createNewExamBtn').addEventListener('click', createNewExam);
        
        // Question type tabs
        document.querySelectorAll('input[name="imageInputMethod"]').forEach(radio => {
            radio.addEventListener('change', toggleImageInputMethod);
        });
        
        // Camera controls
        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('takePhoto').addEventListener('click', takePhoto);
        document.getElementById('retakePhoto').addEventListener('click', retakePhoto);
        
        // AI generation
        document.getElementById('generateWithAI').addEventListener('click', generateWithAI);
        document.getElementById('acceptAIQuestions').addEventListener('click', acceptAIQuestions);
        document.getElementById('rejectAIQuestions').addEventListener('click', rejectAIQuestions);
        
        // Word import
        document.getElementById('importFromWord').addEventListener('click', importFromWord);
        document.getElementById('acceptWordQuestions').addEventListener('click', acceptWordQuestions);
        document.getElementById('rejectWordQuestions').addEventListener('click', rejectWordQuestions);
        
        // Image import
        document.getElementById('importFromImage').addEventListener('click', importFromImage);
        document.getElementById('acceptImageQuestions').addEventListener('click', acceptImageQuestions);
        document.getElementById('rejectImageQuestions').addEventListener('click', rejectImageQuestions);
        
        // Anti-cheat settings
        document.getElementById('antiCheatCopyPaste').addEventListener('change', updateAntiCheatSettings);
        document.getElementById('antiCheatTabSwitch').addEventListener('change', updateAntiCheatSettings);
        document.getElementById('notifyCheating').addEventListener('change', updateAntiCheatSettings);
        
        // Navigation functions
        function goToStep1() {
            saveExamInfo();
            step1.classList.add('active');
            step2.classList.remove('active');
            step1Content.classList.add('show', 'active');
            step2Content.classList.remove('show', 'active');
        }
        
        function goToStep2() {
            if (document.getElementById('examInfoForm').checkValidity()) {
                saveExamInfo();
                step1.classList.remove('active');
                step1.classList.add('completed');
                step2.classList.add('active');
                step1Content.classList.remove('show', 'active');
                step2Content.classList.add('show', 'active');
            } else {
                alert('Vui lòng điền đầy đủ thông tin đề thi');
            }
        }
        
        function goToStep3() {
            if (validateQuestions()) {
                step2.classList.remove('active');
                step2.classList.add('completed');
                step3.classList.add('active');
                step2Content.classList.remove('show', 'active');
                step3Content.classList.add('show', 'active');
                updateExamPreview();
            } else {
                alert('Vui lòng kiểm tra lại các câu hỏi. Mỗi câu hỏi cần có nội dung và đáp án đúng.');
            }
        }
        
        function goToStep2FromStep3() {
            step3.classList.remove('active');
            step2.classList.add('active');
            step3Content.classList.remove('show', 'active');
            step2Content.classList.add('show', 'active');
        }
        
        function goToStep4() {
            saveExamSettings();
            
            // Generate exam ID
            currentExam.examId = generateExamId();
            currentExam.createdBy = auth.currentUser.uid;
            
            // Save to Firestore
            db.collection('exams').doc(currentExam.examId).set(currentExam)
                .then(() => {
                    step3.classList.remove('active');
                    step3.classList.add('completed');
                    step4.classList.add('active');
                    step3Content.classList.remove('show', 'active');
                    step4Content.classList.add('show', 'active');
                    
                    // Generate QR code
                    const examUrl = `${window.location.origin}/take-exam.html?id=${currentExam.examId}`;
                    document.getElementById('examLink').textContent = examUrl;
                    new QRCode(document.getElementById('qrCode'), {
                        text: examUrl,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                })
                .catch((error) => {
                    console.error('Error saving exam: ', error);
                    alert('Có lỗi xảy ra khi lưu đề thi. Vui lòng thử lại.');
                });
        }
        
        // Helper functions
        function saveExamInfo() {
            currentExam.title = document.getElementById('examTitle').value;
            currentExam.duration = parseInt(document.getElementById('examDuration').value);
            currentExam.subject = document.getElementById('examSubject').value;
            currentExam.description = document.getElementById('examDescription').value;
        }
        
        function saveExamSettings() {
            currentExam.settings.antiCheatCopyPaste = document.getElementById('antiCheatCopyPaste').checked;
            currentExam.settings.antiCheatTabSwitch = document.getElementById('antiCheatTabSwitch').checked;
            currentExam.settings.notifyCheating = document.getElementById('notifyCheating').checked;
        }
        
        function updateAntiCheatSettings() {
            saveExamSettings();
        }
        
        function generateExamId() {
            return 'exam_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        }
        
        function copyExamLink() {
            const link = document.getElementById('examLink').textContent;
            navigator.clipboard.writeText(link)
                .then(() => {
                    alert('Đã sao chép link đề thi vào clipboard!');
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                });
        }
        
        function viewExam() {
            window.open(document.getElementById('examLink').textContent, '_blank');
        }
        
        function manageExam() {
            window.location.href = 'manage-exam.html';
        }
        
        function createNewExam() {
            // Reset form
            document.getElementById('examInfoForm').reset();
            document.getElementById('questionsContainer').innerHTML = '';
            addNewQuestion(); // Add default question
            
            // Reset steps
            step1.classList.add('active');
            step2.classList.remove('active', 'completed');
            step3.classList.remove('active', 'completed');
            step4.classList.remove('active', 'completed');
            
            // Show first step
            step4Content.classList.remove('show', 'active');
            step1Content.classList.add('show', 'active');
            
            // Reset current exam
            currentExam = {
                title: '',
                duration: 60,
                subject: 'Ngữ Văn',
                description: '',
                questions: [],
                settings: {
                    antiCheatCopyPaste: true,
                    antiCheatTabSwitch: true,
                    notifyCheating: true
                },
                createdAt: new Date(),
                createdBy: '',
                examId: ''
            };
            
            // Clear QR code
            document.getElementById('qrCode').innerHTML = '';
        }
        
        // Question management functions
        function addNewQuestion() {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionCount = questionsContainer.children.length + 1;
            
            const questionHTML = `
                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Câu hỏi ${questionCount}</h5>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(this)">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nội dung câu hỏi <span class="text-danger">*</span></label>
                        <textarea class="form-control question-content" rows="2" required placeholder="Nhập nội dung câu hỏi"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Loại câu hỏi <span class="text-danger">*</span></label>
                        <select class="form-select question-type" onchange="changeQuestionType(this)">
                            <option value="multiple-choice">Trắc nghiệm (A, B, C, D)</option>
                            <option value="true-false">Đúng/Sai</option>
                            <option value="short-answer">Trả lời ngắn</option>
                            <option value="essay">Tự luận</option>
                        </select>
                    </div>
                    
                    <!-- Multiple Choice Options -->
                    <div class="question-options multiple-choice-options">
                        <div class="mb-2">
                            <label class="form-label">Đáp án <span class="text-danger">*</span></label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">A</span>
                                <input type="text" class="form-control option-input" placeholder="Đáp án A">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer${questionCount}" value="A">
                                </div>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">B</span>
                                <input type="text" class="form-control option-input" placeholder="Đáp án B">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer${questionCount}" value="B">
                                </div>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">C</span>
                                <input type="text" class="form-control option-input" placeholder="Đáp án C">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer${questionCount}" value="C">
                                </div>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">D</span>
                                <input type="text" class="form-control option-input" placeholder="Đáp án D">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0 correct-answer" type="radio" name="correctAnswer${questionCount}" value="D">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- True/False Options -->
                    <div class="question-options true-false-options" style="display: none;">
                        <div class="mb-2">
                            <label class="form-label">Đáp án <span class="text-danger">*</span></label>
                            <div class="form-check">
                                <input class="form-check-input correct-answer" type="radio" name="correctTFAnswer${questionCount}" id="true${questionCount}" value="true">
                                <label class="form-check-label" for="true${questionCount}">Đúng</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input correct-answer" type="radio" name="correctTFAnswer${questionCount}" id="false${questionCount}" value="false">
                                <label class="form-check-label" for="false${questionCount}">Sai</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Short Answer/Essay Options -->
                    <div class="question-options short-answer-options" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Đáp án mẫu <span class="text-danger">*</span></label>
                            <textarea class="form-control model-answer" rows="3" placeholder="Nhập đáp án mẫu"></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Điểm số <span class="text-danger">*</span></label>
                        <input type="number" class="form-control question-points" min="0.1" step="0.1" value="1">
                    </div>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
        }
        
        function removeQuestion(button) {
            if (confirm('Bạn có chắc chắn muốn xóa câu hỏi này?')) {
                const questionItem = button.closest('.question-item');
                questionItem.remove();
                
                // Update question numbers
                const questions = document.querySelectorAll('.question-item');
                questions.forEach((question, index) => {
                    question.querySelector('h5').textContent = `Câu hỏi ${index + 1}`;
                });
            }
        }
        
        function changeQuestionType(select) {
            const questionItem = select.closest('.question-item');
            const questionType = select.value;
            
            // Hide all options
            questionItem.querySelectorAll('.question-options').forEach(options => {
                options.style.display = 'none';
            });
            
            // Show selected options
            if (questionType === 'multiple-choice') {
                questionItem.querySelector('.multiple-choice-options').style.display = 'block';
            } else if (questionType === 'true-false') {
                questionItem.querySelector('.true-false-options').style.display = 'block';
            } else {
                questionItem.querySelector('.short-answer-options').style.display = 'block';
            }
        }
        
        function validateQuestions() {
            const questionItems = document.querySelectorAll('.question-item');
            
            if (questionItems.length === 0) {
                alert('Đề thi cần có ít nhất một câu hỏi');
                return false;
            }
            
            let isValid = true;
            
            questionItems.forEach((item, index) => {
                const content = item.querySelector('.question-content').value.trim();
                const type = item.querySelector('.question-type').value;
                const points = parseFloat(item.querySelector('.question-points').value);
                
                if (!content) {
                    alert(`Vui lòng nhập nội dung cho câu hỏi ${index + 1}`);
                    isValid = false;
                    return;
                }
                
                if (isNaN(points) {
                    alert(`Vui lòng nhập điểm số hợp lệ cho câu hỏi ${index + 1}`);
                    isValid = false;
                    return;
                }
                
                if (type === 'multiple-choice') {
                    const options = item.querySelectorAll('.option-input');
                    let hasOption = false;
                    let hasCorrectAnswer = false;
                    
                    options.forEach(option => {
                        if (option.value.trim()) {
                            hasOption = true;
                        }
                    });
                    
                    const correctAnswers = item.querySelectorAll('.correct-answer:checked');
                    if (correctAnswers.length > 0) {
                        hasCorrectAnswer = true;
                    }
                    
                    if (!hasOption) {
                        alert(`Vui lòng nhập ít nhất một đáp án cho câu hỏi trắc nghiệm ${index + 1}`);
                        isValid = false;
                        return;
                    }
                    
                    if (!hasCorrectAnswer) {
                        alert(`Vui lòng chọn đáp án đúng cho câu hỏi ${index + 1}`);
                        isValid = false;
                        return;
                    }
                } else if (type === 'true-false') {
                    const correctAnswers = item.querySelectorAll('.correct-answer:checked');
                    if (correctAnswers.length === 0) {
                        alert(`Vui lòng chọn đáp án đúng/sai cho câu hỏi ${index + 1}`);
                        isValid = false;
                        return;
                    }
                } else {
                    const modelAnswer = item.querySelector('.model-answer').value.trim();
                    if (!modelAnswer) {
                        alert(`Vui lòng nhập đáp án mẫu cho câu hỏi ${index + 1}`);
                        isValid = false;
                        return;
                    }
                }
            });
            
            if (!isValid) return false;
            
            // If all valid, save questions to currentExam
            currentExam.questions = [];
            
            questionItems.forEach(item => {
                const question = {
                    content: item.querySelector('.question-content').value.trim(),
                    type: item.querySelector('.question-type').value,
                    points: parseFloat(item.querySelector('.question-points').value)
                };
                
                if (question.type === 'multiple-choice') {
                    question.options = {
                        A: item.querySelectorAll('.option-input')[0].value.trim(),
                        B: item.querySelectorAll('.option-input')[1].value.trim(),
                        C: item.querySelectorAll('.option-input')[2].value.trim(),
                        D: item.querySelectorAll('.option-input')[3].value.trim()
                    };
                    question.correctAnswer = item.querySelector('.correct-answer:checked').value;
                } else if (question.type === 'true-false') {
                    question.correctAnswer = item.querySelector('.correct-answer:checked').value === 'true';
                } else {
                    question.modelAnswer = item.querySelector('.model-answer').value.trim();
                }
                
                currentExam.questions.push(question);
            });
            
            return true;
        }
        
        function updateExamPreview() {
            const previewContainer = document.getElementById('examPreview');
            previewContainer.innerHTML = '';
            
            const previewHTML = `
                <h4>${currentExam.title}</h4>
                <p class="text-muted">Môn: ${currentExam.subject} | Thời gian: ${currentExam.duration} phút</p>
                <hr>
                ${currentExam.questions.map((question, index) => `
                    <div class="mb-4">
                        <h5>Câu ${index + 1} (${question.points} điểm)</h5>
                        <p>${question.content}</p>
                        
                        ${question.type === 'multiple-choice' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">A. ${question.options.A}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">B. ${question.options.B}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">C. ${question.options.C}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">D. ${question.options.D}</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer}</small></p>
                        ` : ''}
                        
                        ${question.type === 'true-false' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Đúng</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Sai</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer ? 'Đúng' : 'Sai'}</small></p>
                        ` : ''}
                        
                        ${(question.type === 'short-answer' || question.type === 'essay') ? `
                            <textarea class="form-control" rows="3" disabled placeholder="Câu trả lời sẽ được hiển thị ở đây"></textarea>
                            <p class="text-success mt-2"><small>Đáp án mẫu: ${question.modelAnswer}</small></p>
                        ` : ''}
                    </div>
                `).join('')}
            `;
            
            previewContainer.innerHTML = previewHTML;
        }
        
        // Image import functions
        function toggleImageInputMethod() {
            const method = document.querySelector('input[name="imageInputMethod"]:checked').value;
            
            if (method === 'upload') {
                document.getElementById('uploadImageSection').style.display = 'block';
                document.getElementById('captureImageSection').style.display = 'none';
                document.getElementById('importFromImage').disabled = !document.getElementById('imageFile').files.length;
            } else {
                document.getElementById('uploadImageSection').style.display = 'none';
                document.getElementById('captureImageSection').style.display = 'block';
                document.getElementById('importFromImage').disabled = true;
            }
        }
        
        let stream = null;
        
        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(mediaStream) {
                        stream = mediaStream;
                        const video = document.getElementById('video');
                        video.srcObject = mediaStream;
                        video.style.display = 'block';
                        document.getElementById('cameraPreview').style.display = 'none';
                        
                        document.getElementById('takePhoto').disabled = false;
                        document.getElementById('startCamera').disabled = true;
                    })
                    .catch(function(error) {
                        console.error('Error accessing camera: ', error);
                        alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập.');
                    });
            } else {
                alert('Trình duyệt của bạn không hỗ trợ truy cập camera.');
            }
        }
        
        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            const capturedImage = document.getElementById('capturedImage');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImage.src = canvas.toDataURL('image/png');
            capturedImage.style.display = 'block';
            video.style.display = 'none';
            
            document.getElementById('takePhoto').disabled = true;
            document.getElementById('retakePhoto').disabled = false;
            document.getElementById('importFromImage').disabled = false;
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function retakePhoto() {
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('retakePhoto').disabled = true;
            document.getElementById('importFromImage').disabled = true;
            startCamera();
        }
        
        // AI Generation functions
        async function generateWithAI() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            
            if (!prompt) {
                alert('Vui lòng nhập mô tả đề thi bạn muốn tạo');
                return;
            }
            
            try {
                // Show loading
                const generateBtn = document.getElementById('generateWithAI');
                const originalText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Đang tạo đề...';
                generateBtn.disabled = true;
                
                // Call Gemini API
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Tạo một đề thi môn Văn học dựa trên mô tả sau: ${prompt}. 
                                Trả lời bằng JSON với cấu trúc: {
                                    "title": "Tiêu đề đề thi",
                                    "questions": [
                                        {
                                            "content": "Nội dung câu hỏi",
                                            "type": "Loại câu hỏi (multiple-choice/true-false/short-answer/essay)",
                                            "points": "Điểm số",
                                            "options": {"A": "...", "B": "...", ...} (nếu là trắc nghiệm),
                                            "correctAnswer": "Đáp án đúng (A/B/C/D hoặc true/false)",
                                            "modelAnswer": "Đáp án mẫu (nếu là tự luận hoặc trả lời ngắn)"
                                        }
                                    ]
                                }`
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    const examData = JSON.parse(data.candidates[0].content.parts[0].text);
                    displayAIQuestions(examData);
                } else {
                    throw new Error('Không thể tạo đề thi. Vui lòng thử lại với mô tả chi tiết hơn.');
                }
            } catch (error) {
                console.error('Error generating with AI:', error);
                alert('Có lỗi xảy ra khi tạo đề thi với AI: ' + error.message);
            } finally {
                // Reset button
                const generateBtn = document.getElementById('generateWithAI');
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }
        
        function displayAIQuestions(examData) {
            const container = document.getElementById('aiQuestionsContainer');
            container.innerHTML = '';
            
            // Update exam title if provided by AI
            if (examData.title) {
                document.getElementById('examTitle').value = examData.title;
                saveExamInfo();
            }
            
            examData.questions.forEach((question, index) => {
                const questionHTML = `
                    <div class="question-item mb-3 p-3 border rounded">
                        <h5>Câu ${index + 1} (${question.points || 1} điểm)</h5>
                        <p>${question.content}</p>
                        
                        ${question.type === 'multiple-choice' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">A. ${question.options.A}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">B. ${question.options.B}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">C. ${question.options.C}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">D. ${question.options.D}</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer}</small></p>
                        ` : ''}
                        
                        ${question.type === 'true-false' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Đúng</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Sai</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer ? 'Đúng' : 'Sai'}</small></p>
                        ` : ''}
                        
                        ${(question.type === 'short-answer' || question.type === 'essay') ? `
                            <p class="text-success mt-2"><small>Đáp án mẫu: ${question.modelAnswer}</small></p>
                        ` : ''}
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', questionHTML);
            });
            
            document.getElementById('aiGeneratedQuestions').style.display = 'block';
        }
        
        function acceptAIQuestions() {
            // Parse AI generated questions and add to form
            const container = document.getElementById('aiQuestionsContainer');
            const questionItems = container.querySelectorAll('.question-item');
            
            // Clear existing questions
            document.getElementById('questionsContainer').innerHTML = '';
            
            questionItems.forEach((item, index) => {
                addNewQuestion();
                
                const newQuestion = document.querySelectorAll('.question-item')[index];
                const questionText = item.querySelector('p').textContent;
                const points = parseFloat(item.querySelector('h5').textContent.match(/\((\d+) điểm\)/)[1]);
                
                newQuestion.querySelector('.question-content').value = questionText;
                newQuestion.querySelector('.question-points').value = points;
                
                // Determine question type
                if (item.innerHTML.includes('A.')) {
                    // Multiple choice
                    newQuestion.querySelector('.question-type').value = 'multiple-choice';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const options = item.querySelectorAll('.form-check-label');
                    newQuestion.querySelectorAll('.option-input')[0].value = options[0].textContent.replace('A. ', '');
                    newQuestion.querySelectorAll('.option-input')[1].value = options[1].textContent.replace('B. ', '');
                    newQuestion.querySelectorAll('.option-input')[2].value = options[2].textContent.replace('C. ', '');
                    newQuestion.querySelectorAll('.option-input')[3].value = options[3].textContent.replace('D. ', '');
                    
                    const correctAnswer = item.querySelector('.text-success small').textContent.replace('Đáp án đúng: ', '');
                    newQuestion.querySelector(`input[value="${correctAnswer}"]`).checked = true;
                } else if (item.innerHTML.includes('Đúng')) {
                    // True/false
                    newQuestion.querySelector('.question-type').value = 'true-false';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const isTrue = item.querySelector('.text-success small').textContent.includes('Đúng');
                    newQuestion.querySelector(`input[value="${isTrue}"]`).checked = true;
                } else {
                    // Short answer or essay
                    const isEssay = item.innerHTML.includes('Đáp án mẫu:') && item.querySelector('p').textContent.length > 100;
                    newQuestion.querySelector('.question-type').value = isEssay ? 'essay' : 'short-answer';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const modelAnswer = item.querySelector('.text-success small').textContent.replace('Đáp án mẫu: ', '');
                    newQuestion.querySelector('.model-answer').value = modelAnswer;
                }
            });
            
            // Hide AI generated section
            document.getElementById('aiGeneratedQuestions').style.display = 'none';
            
            // Show success message
            alert('Đã thêm các câu hỏi vào đề thi của bạn!');
        }
        
        function rejectAIQuestions() {
            document.getElementById('aiGeneratedQuestions').style.display = 'none';
            document.getElementById('aiPrompt').value = '';
        }
        
        // Word import functions
        async function importFromWord() {
            const fileInput = document.getElementById('wordFile');
            
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file Word trước khi nhập');
                return;
            }
            
            const file = fileInput.files[0];
            
            try {
                // Show loading
                const importBtn = document.getElementById('importFromWord');
                const originalText = importBtn.innerHTML;
                importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Đang xử lý...';
                importBtn.disabled = true;
                
                // Read file content (simplified - in real app you would use a proper Word parser)
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const content = e.target.result;
                    
                    // For demo purposes, we'll simulate parsing with AI
                    // In a real app, you would use mammoth.js or similar to extract text from Word
                    // Then send to AI for structuring into questions
                    
                    // Simulate delay for processing
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Mock response - in real app you would call Gemini API similar to generateWithAI()
                    const mockExamData = {
                        title: "Đề thi được tạo từ file Word",
                        questions: [
                            {
                                content: "Phân tích hình tượng nhân vật Mị trong tác phẩm 'Vợ chồng A Phủ' của Tô Hoài.",
                                type: "essay",
                                points: 5,
                                modelAnswer: "Hình tượng nhân vật Mị là một trong những thành công nghệ thuật của Tô Hoài..."
                            },
                            {
                                content: "Tác phẩm 'Chí Phèo' của Nam Cao thuộc giai đoạn văn học nào?",
                                type: "multiple-choice",
                                points: 1,
                                options: {
                                    A: "Trước Cách mạng tháng Tám",
                                    B: "Kháng chiến chống Pháp",
                                    C: "Kháng chiến chống Mỹ",
                                    D: "Đổi mới"
                                },
                                correctAnswer: "A"
                            },
                            {
                                content: "Nhận định sau đúng hay sai: 'Nguyễn Du là tác giả của truyện Kiều'",
                                type: "true-false",
                                points: 1,
                                correctAnswer: true
                            }
                        ]
                    };
                    
                    displayWordQuestions(mockExamData);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error importing from Word:', error);
                alert('Có lỗi xảy ra khi nhập đề thi từ Word: ' + error.message);
            } finally {
                // Reset button
                const importBtn = document.getElementById('importFromWord');
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            }
        }
        
        function displayWordQuestions(examData) {
            const container = document.getElementById('wordQuestionsContainer');
            container.innerHTML = '';
            
            examData.questions.forEach((question, index) => {
                const questionHTML = `
                    <div class="question-item mb-3 p-3 border rounded">
                        <h5>Câu ${index + 1} (${question.points || 1} điểm)</h5>
                        <p>${question.content}</p>
                        
                        ${question.type === 'multiple-choice' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">A. ${question.options.A}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">B. ${question.options.B}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">C. ${question.options.C}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">D. ${question.options.D}</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer}</small></p>
                        ` : ''}
                        
                        ${question.type === 'true-false' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Đúng</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Sai</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer ? 'Đúng' : 'Sai'}</small></p>
                        ` : ''}
                        
                        ${(question.type === 'short-answer' || question.type === 'essay') ? `
                            <p class="text-success mt-2"><small>Đáp án mẫu: ${question.modelAnswer}</small></p>
                        ` : ''}
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', questionHTML);
            });
            
            document.getElementById('wordGeneratedQuestions').style.display = 'block';
        }
        
        function acceptWordQuestions() {
            // Similar to acceptAIQuestions but for Word imported questions
            const container = document.getElementById('wordQuestionsContainer');
            const questionItems = container.querySelectorAll('.question-item');
            
            // Clear existing questions
            document.getElementById('questionsContainer').innerHTML = '';
            
            questionItems.forEach((item, index) => {
                addNewQuestion();
                
                const newQuestion = document.querySelectorAll('.question-item')[index];
                const questionText = item.querySelector('p').textContent;
                const points = parseFloat(item.querySelector('h5').textContent.match(/\((\d+) điểm\)/)[1]);
                
                newQuestion.querySelector('.question-content').value = questionText;
                newQuestion.querySelector('.question-points').value = points;
                
                // Determine question type
                if (item.innerHTML.includes('A.')) {
                    // Multiple choice
                    newQuestion.querySelector('.question-type').value = 'multiple-choice';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const options = item.querySelectorAll('.form-check-label');
                    newQuestion.querySelectorAll('.option-input')[0].value = options[0].textContent.replace('A. ', '');
                    newQuestion.querySelectorAll('.option-input')[1].value = options[1].textContent.replace('B. ', '');
                    newQuestion.querySelectorAll('.option-input')[2].value = options[2].textContent.replace('C. ', '');
                    newQuestion.querySelectorAll('.option-input')[3].value = options[3].textContent.replace('D. ', '');
                    
                    const correctAnswer = item.querySelector('.text-success small').textContent.replace('Đáp án đúng: ', '');
                    newQuestion.querySelector(`input[value="${correctAnswer}"]`).checked = true;
                } else if (item.innerHTML.includes('Đúng')) {
                    // True/false
                    newQuestion.querySelector('.question-type').value = 'true-false';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const isTrue = item.querySelector('.text-success small').textContent.includes('Đúng');
                    newQuestion.querySelector(`input[value="${isTrue}"]`).checked = true;
                } else {
                    // Short answer or essay
                    const isEssay = item.innerHTML.includes('Đáp án mẫu:') && item.querySelector('p').textContent.length > 100;
                    newQuestion.querySelector('.question-type').value = isEssay ? 'essay' : 'short-answer';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const modelAnswer = item.querySelector('.text-success small').textContent.replace('Đáp án mẫu: ', '');
                    newQuestion.querySelector('.model-answer').value = modelAnswer;
                }
            });
            
            // Hide Word imported section
            document.getElementById('wordGeneratedQuestions').style.display = 'none';
            
            // Show success message
            alert('Đã thêm các câu hỏi từ file Word vào đề thi của bạn!');
        }
        
        function rejectWordQuestions() {
            document.getElementById('wordGeneratedQuestions').style.display = 'none';
            document.getElementById('wordFile').value = '';
        }
        
        // Image import functions
        async function importFromImage() {
            try {
                // Show loading
                const importBtn = document.getElementById('importFromImage');
                const originalText = importBtn.innerHTML;
                importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Đang nhận dạng...';
                importBtn.disabled = true;
                
                // Get image data
                let imageData;
                const method = document.querySelector('input[name="imageInputMethod"]:checked').value;
                
                if (method === 'upload') {
                    const file = document.getElementById('imageFile').files[0];
                    imageData = await readFileAsDataURL(file);
                } else {
                    imageData = document.getElementById('capturedImage').src;
                }
                
                // For demo purposes, we'll simulate OCR with AI
                // In a real app, you would use Tesseract.js or similar for OCR
                // Then send to AI for structuring into questions
                
                // Simulate delay for processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Mock response - in real app you would call Gemini API Vision
                const mockExamData = {
                    title: "Đề thi được tạo từ ảnh",
                    questions: [
                        {
                            content: "Phân tích giá trị nhân đạo trong tác phẩm 'Vợ nhặt' của Kim Lân.",
                            type: "essay",
                            points: 5,
                            modelAnswer: "Tác phẩm 'Vợ nhặt' của Kim Lân thể hiện giá trị nhân đạo sâu sắc..."
                        },
                        {
                            content: "Tác phẩm 'Rừng xà nu' của Nguyễn Trung Thành viết về đề tài gì?",
                            type: "multiple-choice",
                            points: 1,
                            options: {
                                A: "Chiến tranh cách mạng",
                                B: "Tình yêu lứa đôi",
                                C: "Thiên nhiên Tây Nguyên",
                                D: "Đời sống nông thôn"
                            },
                            correctAnswer: "A"
                        },
                        {
                            content: "Nhận định sau đúng hay sai: 'Hồ Xuân Hương là nữ sĩ nổi tiếng thời Trung đại'",
                            type: "true-false",
                            points: 1,
                            correctAnswer: true
                        }
                    ]
                };
                
                displayImageQuestions(mockExamData);
            } catch (error) {
                console.error('Error importing from image:', error);
                alert('Có lỗi xảy ra khi nhập đề thi từ ảnh: ' + error.message);
            } finally {
                // Reset button
                const importBtn = document.getElementById('importFromImage');
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            }
        }
        
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function displayImageQuestions(examData) {
            const container = document.getElementById('imageQuestionsContainer');
            container.innerHTML = '';
            
            examData.questions.forEach((question, index) => {
                const questionHTML = `
                    <div class="question-item mb-3 p-3 border rounded">
                        <h5>Câu ${index + 1} (${question.points || 1} điểm)</h5>
                        <p>${question.content}</p>
                        
                        ${question.type === 'multiple-choice' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">A. ${question.options.A}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">B. ${question.options.B}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">C. ${question.options.C}</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">D. ${question.options.D}</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer}</small></p>
                        ` : ''}
                        
                        ${question.type === 'true-false' ? `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Đúng</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label">Sai</label>
                            </div>
                            <p class="text-success mt-2"><small>Đáp án đúng: ${question.correctAnswer ? 'Đúng' : 'Sai'}</small></p>
                        ` : ''}
                        
                        ${(question.type === 'short-answer' || question.type === 'essay') ? `
                            <p class="text-success mt-2"><small>Đáp án mẫu: ${question.modelAnswer}</small></p>
                        ` : ''}
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', questionHTML);
            });
            
            document.getElementById('imageGeneratedQuestions').style.display = 'block';
        }
        
        function acceptImageQuestions() {
            // Similar to acceptAIQuestions but for image imported questions
            const container = document.getElementById('imageQuestionsContainer');
            const questionItems = container.querySelectorAll('.question-item');
            
            // Clear existing questions
            document.getElementById('questionsContainer').innerHTML = '';
            
            questionItems.forEach((item, index) => {
                addNewQuestion();
                
                const newQuestion = document.querySelectorAll('.question-item')[index];
                const questionText = item.querySelector('p').textContent;
                const points = parseFloat(item.querySelector('h5').textContent.match(/\((\d+) điểm\)/)[1]);
                
                newQuestion.querySelector('.question-content').value = questionText;
                newQuestion.querySelector('.question-points').value = points;
                
                // Determine question type
                if (item.innerHTML.includes('A.')) {
                    // Multiple choice
                    newQuestion.querySelector('.question-type').value = 'multiple-choice';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const options = item.querySelectorAll('.form-check-label');
                    newQuestion.querySelectorAll('.option-input')[0].value = options[0].textContent.replace('A. ', '');
                    newQuestion.querySelectorAll('.option-input')[1].value = options[1].textContent.replace('B. ', '');
                    newQuestion.querySelectorAll('.option-input')[2].value = options[2].textContent.replace('C. ', '');
                    newQuestion.querySelectorAll('.option-input')[3].value = options[3].textContent.replace('D. ', '');
                    
                    const correctAnswer = item.querySelector('.text-success small').textContent.replace('Đáp án đúng: ', '');
                    newQuestion.querySelector(`input[value="${correctAnswer}"]`).checked = true;
                } else if (item.innerHTML.includes('Đúng')) {
                    // True/false
                    newQuestion.querySelector('.question-type').value = 'true-false';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const isTrue = item.querySelector('.text-success small').textContent.includes('Đúng');
                    newQuestion.querySelector(`input[value="${isTrue}"]`).checked = true;
                } else {
                    // Short answer or essay
                    const isEssay = item.innerHTML.includes('Đáp án mẫu:') && item.querySelector('p').textContent.length > 100;
                    newQuestion.querySelector('.question-type').value = isEssay ? 'essay' : 'short-answer';
                    changeQuestionType(newQuestion.querySelector('.question-type'));
                    
                    const modelAnswer = item.querySelector('.text-success small').textContent.replace('Đáp án mẫu: ', '');
                    newQuestion.querySelector('.model-answer').value = modelAnswer;
                }
            });
            
            // Hide image imported section
            document.getElementById('imageGeneratedQuestions').style.display = 'none';
            
            // Reset image input
            document.getElementById('imageFile').value = '';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('capturedImage').src = '';
            document.getElementById('video').style.display = 'none';
            
            // Show success message
            alert('Đã thêm các câu hỏi từ ảnh vào đề thi của bạn!');
        }
        
        function rejectImageQuestions() {
            document.getElementById('imageGeneratedQuestions').style.display = 'none';
            document.getElementById('imageFile').value = '';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('capturedImage').src = '';
            document.getElementById('video').style.display = 'none';
        }
        
        // Initialize with one question
        window.onload = function() {
            addNewQuestion();
            
            // Enable file input change detection
            document.getElementById('imageFile').addEventListener('change', function() {
                document.getElementById('importFromImage').disabled = !this.files.length;
            });
        };
    </script>
</body>
</html>
