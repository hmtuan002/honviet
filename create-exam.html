<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đề Thi Văn Học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #e6f2ff;
            --accent-color: #357bd8;
            --text-color: #333;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: #f5f7fa;
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .question-item {
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 20px;
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 5px;
        }
        
        .preview-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: white;
        }
        
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            position: relative;
        }
        
        .step.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step.completed {
            background-color: #5cb85c;
            color: white;
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background-color: #ddd;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step.active::after, .step.completed::after {
            background-color: var(--primary-color);
        }
        
        .exam-option-card {
            cursor: pointer;
            text-align: center;
            padding: 20px;
            height: 100%;
        }
        
        .exam-option-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .exam-option-card:hover {
            background-color: var(--secondary-color);
        }
        
        .exam-option-card.selected {
            border: 2px solid var(--primary-color);
            background-color: var(--secondary-color);
        }
        
        #wordFilePreview, #imagePreview {
            max-height: 300px;
            max-width: 100%;
            margin-top: 15px;
        }
        
        .anti-cheat-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .anti-cheat-option input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>Văn Học Thi
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="create-exam.html"><i class="fas fa-plus-circle me-1"></i> Tạo đề</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="take-exam.html"><i class="fas fa-pen-fancy me-1"></i> Thi thử</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="manage-exam.html"><i class="fas fa-tasks me-1"></i> Quản lý</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html"><i class="fas fa-sign-in-alt me-1"></i> Đăng nhập</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Tạo đề thi mới</h4>
                    </div>
                    <div class="card-body">
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" id="step1">1</div>
                            <div class="step" id="step2">2</div>
                            <div class="step" id="step3">3</div>
                            <div class="step" id="step4">4</div>
                        </div>
                        
                        <!-- Step 1: Basic Info -->
                        <div id="step1-content" class="step-content">
                            <h5 class="mb-4">Thông tin cơ bản</h5>
                            <div class="mb-3">
                                <label for="examTitle" class="form-label">Tiêu đề đề thi</label>
                                <input type="text" class="form-control" id="examTitle" placeholder="Ví dụ: Đề thi thử THPT Quốc gia môn Văn 2024">
                            </div>
                            <div class="mb-3">
                                <label for="examDescription" class="form-label">Mô tả đề thi</label>
                                <textarea class="form-control" id="examDescription" rows="3" placeholder="Mô tả ngắn gọn về đề thi"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="examTime" class="form-label">Thời gian làm bài (phút)</label>
                                    <input type="number" class="form-control" id="examTime" min="1" value="60">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="examSubject" class="form-label">Môn học</label>
                                    <select class="form-select" id="examSubject">
                                        <option selected value="van">Ngữ Văn</option>
                                        <option value="su">Lịch Sử</option>
                                        <option value="dia">Địa Lý</option>
                                        <option value="gdcd">GDCD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-primary" onclick="nextStep(1)">Tiếp theo <i class="fas fa-arrow-right ms-2"></i></button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Create Questions -->
                        <div id="step2-content" class="step-content" style="display: none;">
                            <h5 class="mb-4">Tạo câu hỏi</h5>
                            <p class="text-muted mb-4">Chọn phương thức tạo câu hỏi cho đề thi của bạn:</p>
                            
                            <ul class="nav nav-tabs mb-4" id="createMethodTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">Thủ công</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">AI Tạo đề</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="word-tab" data-bs-toggle="tab" data-bs-target="#word" type="button" role="tab">Từ file Word</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image" type="button" role="tab">Từ hình ảnh</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="createMethodTabContent">
                                <!-- Manual Creation -->
                                <div class="tab-pane fade show active" id="manual" role="tabpanel">
                                    <div id="questionsContainer">
                                        <!-- Questions will be added here -->
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button class="btn btn-outline-primary" onclick="addQuestion('multiple-choice')">
                                            <i class="fas fa-plus-circle me-2"></i>Thêm câu trắc nghiệm
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="addQuestion('true-false')">
                                            <i class="fas fa-plus-circle me-2"></i>Thêm câu đúng/sai
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="addQuestion('short-answer')">
                                            <i class="fas fa-plus-circle me-2"></i>Thêm câu trả lời ngắn
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="addQuestion('essay')">
                                            <i class="fas fa-plus-circle me-2"></i>Thêm câu tự luận
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- AI Creation -->
                                <div class="tab-pane fade" id="ai" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="aiPrompt" class="form-label">Mô tả đề thi bạn muốn tạo</label>
                                        <textarea class="form-control" id="aiPrompt" rows="5" placeholder="Ví dụ: Tạo một đề thi Ngữ Văn lớp 12 với 3 câu hỏi: 1 câu đọc hiểu về bài thơ 'Sóng' của Xuân Quỳnh, 1 câu nghị luận xã hội về chủ đề tình yêu tuổi trẻ, và 1 câu nghị luận văn học phân tích hình tượng người lái đò trong tác phẩm 'Người lái đò sông Đà' của Nguyễn Tuân"></textarea>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-outline-secondary" onclick="backToStep(2)">
                                            <i class="fas fa-arrow-left me-2"></i>Quay lại
                                        </button>
                                        <button class="btn btn-primary" onclick="generateWithAI()">
                                            <i class="fas fa-magic me-2"></i>Tạo đề với AI
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Word File -->
                                <div class="tab-pane fade" id="word" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label">Tải lên file Word (.docx)</label>
                                        <input class="form-control" type="file" id="wordFile" accept=".docx">
                                    </div>
                                    <div id="wordFilePreviewContainer" style="display: none;">
                                        <h6>Xem trước nội dung:</h6>
                                        <div id="wordFilePreview" class="preview-container"></div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button class="btn btn-outline-secondary" onclick="backToStep(2)">
                                            <i class="fas fa-arrow-left me-2"></i>Quay lại
                                        </button>
                                        <button class="btn btn-primary" id="processWordBtn" disabled onclick="processWordFile()">
                                            <i class="fas fa-cogs me-2"></i>Xử lý file Word
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Image -->
                                <div class="tab-pane fade" id="image" role="tabpanel">
                                    <div class="mb-3">
                                        <label class="form-label">Chọn nguồn ảnh</label>
                                        <div class="d-flex mb-3">
                                            <button class="btn btn-outline-primary me-2" onclick="document.getElementById('imageFile').click()">
                                                <i class="fas fa-image me-2"></i>Tải lên ảnh
                                            </button>
                                            <button class="btn btn-outline-primary" id="openCameraBtn">
                                                <i class="fas fa-camera me-2"></i>Mở camera
                                            </button>
                                            <input type="file" id="imageFile" accept="image/*" style="display: none;">
                                        </div>
                                        <div id="cameraContainer" style="display: none;">
                                            <div class="d-flex justify-content-center mb-3">
                                                <video id="cameraPreview" autoplay playsinline style="max-width: 100%; border-radius: 5px;"></video>
                                            </div>
                                            <div class="d-flex justify-content-center">
                                                <button class="btn btn-primary me-2" id="captureBtn">
                                                    <i class="fas fa-camera me-2"></i>Chụp ảnh
                                                </button>
                                                <button class="btn btn-outline-secondary" id="closeCameraBtn">
                                                    <i class="fas fa-times me-2"></i>Đóng camera
                                                </button>
                                            </div>
                                        </div>
                                        <canvas id="imageCanvas" style="display: none;"></canvas>
                                    </div>
                                    <div id="imagePreviewContainer" style="display: none;">
                                        <h6>Ảnh đã chọn:</h6>
                                        <img id="imagePreview" class="img-fluid rounded">
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button class="btn btn-outline-secondary" onclick="backToStep(2)">
                                            <i class="fas fa-arrow-left me-2"></i>Quay lại
                                        </button>
                                        <button class="btn btn-primary" id="processImageBtn" disabled onclick="processImage()">
                                            <i class="fas fa-cogs me-2"></i>Xử lý ảnh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4" id="manualCreationButtons" style="display: none;">
                                <button class="btn btn-outline-secondary" onclick="backToStep(2)">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </button>
                                <button class="btn btn-primary" onclick="nextStep(2)">
                                    Tiếp theo <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Anti-cheat Settings -->
                        <div id="step3-content" class="step-content" style="display: none;">
                            <h5 class="mb-4">Cài đặt chống gian lận</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Các cài đặt này giúp đảm bảo tính công bằng khi thí sinh làm bài thi của bạn.
                            </div>
                            
                            <div class="mb-4">
                                <h6 class="mb-3">Tùy chọn chống gian lận:</h6>
                                <div class="anti-cheat-option">
                                    <input type="checkbox" class="form-check-input" id="preventCopyPaste" checked>
                                    <label class="form-check-label" for="preventCopyPaste">Chống sao chép và dán nội dung</label>
                                </div>
                                <div class="anti-cheat-option">
                                    <input type="checkbox" class="form-check-input" id="preventTabSwitch" checked>
                                    <label class="form-check-label" for="preventTabSwitch">Tự động nộp bài khi thí sinh chuyển tab hoặc mở ứng dụng khác</label>
                                </div>
                                <div class="anti-cheat-option">
                                    <input type="checkbox" class="form-check-input" id="fullScreenRequired">
                                    <label class="form-check-label" for="fullScreenRequired">Yêu cầu thí sinh bật chế độ toàn màn hình</label>
                                </div>
                                <div class="anti-cheat-option">
                                    <input type="checkbox" class="form-check-input" id="enableWebcam">
                                    <label class="form-check-label" for="enableWebcam">Yêu cầu bật camera giám sát trong quá trình thi</label>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6 class="mb-3">Thông báo khi phát hiện gian lận:</h6>
                                <div class="mb-3">
                                    <label for="cheatNotificationEmail" class="form-label">Email nhận thông báo</label>
                                    <input type="email" class="form-control" id="cheatNotificationEmail" placeholder="Nhập email của bạn">
                                </div>
                                <div class="mb-3">
                                    <label for="cheatNotificationMessage" class="form-label">Nội dung thông báo</label>
                                    <textarea class="form-control" id="cheatNotificationMessage" rows="3">Hệ thống đã phát hiện thí sinh {student_name} có hành vi gian lận trong bài thi {exam_title}. Bài thi đã được tự động nộp.</textarea>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-outline-secondary" onclick="backToStep(3)">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </button>
                                <button class="btn btn-primary" onclick="nextStep(3)">
                                    Tiếp theo <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Finalize and Share -->
                        <div id="step4-content" class="step-content" style="display: none;">
                            <h5 class="mb-4">Xem trước và chia sẻ đề thi</h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="preview-container mb-4">
                                        <h4 id="previewExamTitle">Đề thi thử THPT Quốc gia môn Văn 2024</h4>
                                        <p id="previewExamDescription">Đề thi thử nghiệm với cấu trúc bám sát đề minh họa của Bộ GD&ĐT</p>
                                        <p><strong>Thời gian làm bài:</strong> <span id="previewExamTime">60</span> phút</p>
                                        <hr>
                                        <div id="previewQuestions">
                                            <!-- Questions preview will be added here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="qr-code-container mb-4">
                                        <h6 class="mb-3">Chia sẻ đề thi</h6>
                                        <div id="qrCode" class="mb-3" style="width: 200px; height: 200px;"></div>
                                        <div class="mb-3">
                                            <label for="examLink" class="form-label">Link đề thi</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="examLink" readonly>
                                                <button class="btn btn-outline-primary" onclick="copyExamLink()">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-center gap-2 mt-3">
                                            <button class="btn btn-outline-primary btn-sm">
                                                <i class="fab fa-facebook-f"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm">
                                                <i class="fab fa-twitter"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm">
                                                <i class="fab fa-telegram-plane"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Tùy chọn xuất bản</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="examVisibility" class="form-label">Chế độ hiển thị</label>
                                                <select class="form-select" id="examVisibility">
                                                    <option value="public">Công khai (ai cũng có thể làm bài)</option>
                                                    <option value="unlisted">Không công khai (chỉ người có link mới làm được)</option>
                                                    <option value="private">Riêng tư (chỉ mình bạn xem được)</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="examPassword" class="form-label">Mật khẩu bảo vệ (tùy chọn)</label>
                                                <input type="text" class="form-control" id="examPassword" placeholder="Nhập mật khẩu nếu muốn">
                                            </div>
                                            <button class="btn btn-primary w-100" onclick="publishExam()">
                                                <i class="fas fa-paper-plane me-2"></i>Xuất bản đề thi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-outline-secondary" onclick="backToStep(4)">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </button>
                                <button class="btn btn-success" id="finishBtn" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Hoàn thành
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Template (hidden) -->
    <div id="questionTemplate" style="display: none;">
        <div class="question-item" data-question-type="{type}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6>Câu hỏi <span class="question-number">1</span> ({type-name})</h6>
                <button class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="mb-3">
                <label class="form-label">Nội dung câu hỏi</label>
                <textarea class="form-control question-content" rows="2" placeholder="Nhập nội dung câu hỏi"></textarea>
            </div>
            <div class="question-options-container">
                <!-- Options will be added here based on question type -->
            </div>
            <div class="mt-2">
                <label class="form-label">Điểm số</label>
                <input type="number" class="form-control question-points" min="0" step="0.5" value="1" style="width: 80px;">
            </div>
        </div>
    </div>

    <!-- Option Templates (hidden) -->
    <div id="multipleChoiceOptionsTemplate" style="display: none;">
        <div class="mb-2">
            <label class="form-label">Lựa chọn</label>
            <div class="option-item mb-2">
                <div class="input-group">
                    <span class="input-group-text">A</span>
                    <input type="text" class="form-control option-text" placeholder="Nhập lựa chọn A">
                    <div class="input-group-text">
                        <input class="form-check-input correct-answer" type="radio" name="correctAnswer{index}" value="A">
                    </div>
                </div>
            </div>
            <div class="option-item mb-2">
                <div class="input-group">
                    <span class="input-group-text">B</span>
                    <input type="text" class="form-control option-text" placeholder="Nhập lựa chọn B">
                    <div class="input-group-text">
                        <input class="form-check-input correct-answer" type="radio" name="correctAnswer{index}" value="B">
                    </div>
                </div>
            </div>
            <div class="option-item mb-2">
                <div class="input-group">
                    <span class="input-group-text">C</span>
                    <input type="text" class="form-control option-text" placeholder="Nhập lựa chọn C">
                    <div class="input-group-text">
                        <input class="form-check-input correct-answer" type="radio" name="correctAnswer{index}" value="C">
                    </div>
                </div>
            </div>
            <div class="option-item">
                <div class="input-group">
                    <span class="input-group-text">D</span>
                    <input type="text" class="form-control option-text" placeholder="Nhập lựa chọn D">
                    <div class="input-group-text">
                        <input class="form-check-input correct-answer" type="radio" name="correctAnswer{index}" value="D">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="trueFalseOptionsTemplate" style="display: none;">
        <div class="mb-2">
            <label class="form-label">Đáp án đúng</label>
            <div class="form-check">
                <input class="form-check-input correct-answer" type="radio" name="correctAnswer{index}" value="true" checked>
                <label class="form-check-label">Đúng</label>
            </div>
            <div class="form-check">
                <input class="form-check-input correct-answer" type="radio" name="correctAnswer{index}" value="false">
                <label class="form-check-label">Sai</label>
            </div>
        </div>
    </div>

    <div id="shortAnswerOptionsTemplate" style="display: none;">
        <div class="mb-2">
            <label class="form-label">Đáp án mẫu</label>
            <textarea class="form-control correct-answer" rows="3" placeholder="Nhập đáp án mẫu cho câu trả lời ngắn"></textarea>
        </div>
    </div>

    <div id="essayOptionsTemplate" style="display: none;">
        <div class="mb-2">
            <label class="form-label">Hướng dẫn chấm điểm</label>
            <textarea class="form-control correct-answer" rows="4" placeholder="Nhập hướng dẫn chấm điểm cho câu tự luận"></textarea>
        </div>
    </div>

    <!-- Preview Templates (hidden) -->
    <div id="previewMultipleChoiceTemplate" style="display: none;">
        <div class="mb-4">
            <p><strong>Câu {number}:</strong> {content} ({points} điểm)</p>
            <div class="ms-3">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="previewQuestion{index}" disabled>
                    <label class="form-check-label">A. {optionA}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="previewQuestion{index}" disabled>
                    <label class="form-check-label">B. {optionB}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="previewQuestion{index}" disabled>
                    <label class="form-check-label">C. {optionC}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="previewQuestion{index}" disabled>
                    <label class="form-check-label">D. {optionD}</label>
                </div>
            </div>
        </div>
    </div>

    <div id="previewTrueFalseTemplate" style="display: none;">
        <div class="mb-4">
            <p><strong>Câu {number}:</strong> {content} ({points} điểm)</p>
            <div class="ms-3">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="previewQuestion{index}" disabled>
                    <label class="form-check-label">Đúng</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="previewQuestion{index}" disabled>
                    <label class="form-check-label">Sai</label>
                </div>
            </div>
        </div>
    </div>

    <div id="previewShortAnswerTemplate" style="display: none;">
        <div class="mb-4">
            <p><strong>Câu {number}:</strong> {content} ({points} điểm)</p>
            <div class="ms-3">
                <textarea class="form-control" rows="3" placeholder="Câu trả lời của thí sinh" disabled></textarea>
            </div>
        </div>
    </div>

    <div id="previewEssayTemplate" style="display: none;">
        <div class="mb-4">
            <p><strong>Câu {number}:</strong> {content} ({points} điểm)</p>
            <div class="ms-3">
                <textarea class="form-control" rows="5" placeholder="Bài làm của thí sinh" disabled></textarea>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="loadingMessage">Đang xử lý...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="mb-3">Thành công!</h4>
                    <p id="successMessage">Đề thi của bạn đã được tạo thành công.</p>
                    <button class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
            authDomain: "literatureexamapp.firebaseapp.com",
            projectId: "literatureexamapp",
            storageBucket: "literatureexamapp.appspot.com",
            messagingSenderId: "829681704033",
            appId: "1:829681704033:web:f92a79de0c177b235b9e20"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Global variables
        let currentStep = 1;
        let questions = [];
        let examId = '';
        let stream = null;
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize step 1 as active
            updateStepIndicator();
            
            // Event listeners for file inputs
            document.getElementById('wordFile').addEventListener('change', handleWordFileSelect);
            document.getElementById('imageFile').addEventListener('change', handleImageFileSelect);
            
            // Camera button
            document.getElementById('openCameraBtn').addEventListener('click', openCamera);
            document.getElementById('closeCameraBtn').addEventListener('click', closeCamera);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            
            // Check if user is logged in
            auth.onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'login.html';
                }
            });
        });
        
        // Step Navigation Functions
        function nextStep(step) {
            // Validate current step before proceeding
            if (step === 1 && !validateStep1()) return;
            if (step === 2 && !validateStep2()) return;
            
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            currentStep++;
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            updateStepIndicator();
            
            // Special handling for step 4
            if (currentStep === 4) {
                preparePreview();
            }
        }
        
        function backToStep(step) {
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            currentStep--;
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            updateStepIndicator();
        }
        
        function updateStepIndicator() {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    stepElement.classList.remove('active');
                    stepElement.classList.add('completed');
                } else if (i === currentStep) {
                    stepElement.classList.add('active');
                    stepElement.classList.remove('completed');
                } else {
                    stepElement.classList.remove('active');
                    stepElement.classList.remove('completed');
                }
            }
        }
        
        // Step Validation Functions
        function validateStep1() {
            const title = document.getElementById('examTitle').value.trim();
            const time = document.getElementById('examTime').value;
            
            if (!title) {
                alert('Vui lòng nhập tiêu đề đề thi');
                return false;
            }
            
            if (!time || parseInt(time) <= 0) {
                alert('Thời gian làm bài phải lớn hơn 0');
                return false;
            }
            
            return true;
        }
        
        function validateStep2() {
            // For manual creation
            if (document.getElementById('manual-tab').classList.contains('active')) {
                if (questions.length === 0) {
                    alert('Vui lòng thêm ít nhất một câu hỏi');
                    return false;
                }
                
                // Validate each question
                for (let i = 0; i < questions.length; i++) {
                    const question = questions[i];
                    if (!question.content.trim()) {
                        alert(`Vui lòng nhập nội dung cho câu hỏi ${i + 1}`);
                        return false;
                    }
                    
                    if (question.type === 'multiple-choice') {
                        const hasEmptyOption = question.options.some(opt => !opt.text.trim());
                        if (hasEmptyOption) {
                            alert(`Vui lòng nhập đầy đủ các lựa chọn cho câu hỏi ${i + 1}`);
                            return false;
                        }
                        
                        if (!question.correctAnswer) {
                            alert(`Vui lòng chọn đáp án đúng cho câu hỏi ${i + 1}`);
                            return false;
                        }
                    }
                }
            }
            
            return true;
        }
        
        // Question Management Functions
        function addQuestion(type) {
            const container = document.getElementById('questionsContainer');
            const template = document.getElementById('questionTemplate').cloneNode(true);
            template.style.display = 'block';
            
            // Set question type
            const typeNames = {
                'multiple-choice': 'Trắc nghiệm',
                'true-false': 'Đúng/Sai',
                'short-answer': 'Trả lời ngắn',
                'essay': 'Tự luận'
            };
            
            template.querySelector('.question-item').setAttribute('data-question-type', type);
            template.querySelector('h6 span').textContent = questions.length + 1;
            template.querySelector('h6').innerHTML = template.querySelector('h6').innerHTML.replace('{type-name}', typeNames[type]);
            
            // Add appropriate options based on type
            const optionsContainer = template.querySelector('.question-options-container');
            
            if (type === 'multiple-choice') {
                optionsContainer.innerHTML = document.getElementById('multipleChoiceOptionsTemplate').innerHTML;
            } else if (type === 'true-false') {
                optionsContainer.innerHTML = document.getElementById('trueFalseOptionsTemplate').innerHTML;
            } else if (type === 'short-answer') {
                optionsContainer.innerHTML = document.getElementById('shortAnswerOptionsTemplate').innerHTML;
            } else if (type === 'essay') {
                optionsContainer.innerHTML = document.getElementById('essayOptionsTemplate').innerHTML;
            }
            
            // Replace {index} with actual question index
            optionsContainer.innerHTML = optionsContainer.innerHTML.replace(/{index}/g, questions.length);
            
            // Add to DOM
            container.appendChild(template);
            
            // Add to questions array
            questions.push({
                type: type,
                content: '',
                options: type === 'multiple-choice' ? [
                    { text: '', value: 'A' },
                    { text: '', value: 'B' },
                    { text: '', value: 'C' },
                    { text: '', value: 'D' }
                ] : type === 'true-false' ? [
                    { text: 'Đúng', value: 'true' },
                    { text: 'Sai', value: 'false' }
                ] : [],
                correctAnswer: '',
                points: 1
            });
            
            // Show manual creation buttons if not already shown
            document.getElementById('manualCreationButtons').style.display = 'flex';
            
            // Add event listeners to update questions array
            const index = questions.length - 1;
            const questionElement = container.children[container.children.length - 1];
            
            // Content change
            questionElement.querySelector('.question-content').addEventListener('input', function() {
                questions[index].content = this.value;
            });
            
            // Points change
            questionElement.querySelector('.question-points').addEventListener('input', function() {
                questions[index].points = parseFloat(this.value) || 0;
            });
            
            // For multiple choice questions
            if (type === 'multiple-choice') {
                const optionInputs = questionElement.querySelectorAll('.option-text');
                optionInputs.forEach((input, i) => {
                    input.addEventListener('input', function() {
                        questions[index].options[i].text = this.value;
                    });
                });
                
                const correctRadios = questionElement.querySelectorAll('.correct-answer');
                correctRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            questions[index].correctAnswer = this.value;
                        }
                    });
                });
            }
            
            // For true/false questions
            else if (type === 'true-false') {
                const correctRadios = questionElement.querySelectorAll('.correct-answer');
                correctRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            questions[index].correctAnswer = this.value;
                        }
                    });
                });
            }
            
            // For short answer and essay questions
            else {
                const answerTextarea = questionElement.querySelector('.correct-answer');
                answerTextarea.addEventListener('input', function() {
                    questions[index].correctAnswer = this.value;
                });
            }
        }
        
        function removeQuestion(button) {
            const questionElement = button.closest('.question-item');
            const index = Array.from(questionElement.parentNode.children).indexOf(questionElement);
            
            // Remove from DOM
            questionElement.remove();
            
            // Remove from questions array
            questions.splice(index, 1);
            
            // Update question numbers
            const questionElements = document.querySelectorAll('.question-item');
            questionElements.forEach((element, i) => {
                element.querySelector('.question-number').textContent = i + 1;
            });
            
            // Hide manual creation buttons if no questions left
            if (questions.length === 0) {
                document.getElementById('manualCreationButtons').style.display = 'none';
            }
        }
        
        // AI Generation Functions
        async function generateWithAI() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            if (!prompt) {
                alert('Vui lòng nhập mô tả đề thi bạn muốn tạo');
                return;
            }
            
            showLoading('Đang tạo đề thi với AI...');
            
            try {
                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt + "\n\nHãy tạo một đề thi Ngữ Văn dựa trên mô tả trên. Trả về kết quả dưới dạng JSON với cấu trúc sau:\n\n" +
                                "{\n" +
                                "  \"title\": \"Tiêu đề đề thi\",\n" +
                                "  \"description\": \"Mô tả đề thi\",\n" +
                                "  \"timeLimit\": 60,\n" +
                                "  \"questions\": [\n" +
                                "    {\n" +
                                "      \"type\": \"multiple-choice|true-false|short-answer|essay\",\n" +
                                "      \"content\": \"Nội dung câu hỏi\",\n" +
                                "      \"options\": [\"Lựa chọn A\", \"Lựa chọn B\", ...],\n" +
                                "      \"correctAnswer\": \"Đáp án đúng\",\n" +
                                "      \"points\": 1\n" +
                                "    }\n" +
                                "  ]\n" +
                                "}"
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Không thể tạo đề thi với AI');
                }
                
                // Parse the response (Gemini returns text in candidates[0].content.parts[0].text)
                const responseText = data.candidates[0].content.parts[0].text;
                
                // Try to extract JSON from the response
                let jsonResponse;
                try {
                    // Sometimes Gemini wraps the JSON in markdown code blocks
                    const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/);
                    if (jsonMatch) {
                        jsonResponse = JSON.parse(jsonMatch[1]);
                    } else {
                        jsonResponse = JSON.parse(responseText);
                    }
                } catch (e) {
                    console.error('Failed to parse AI response:', e);
                    throw new Error('AI đã trả về định dạng không hợp lệ. Vui lòng thử lại với mô tả chi tiết hơn.');
                }
                
                // Validate the response
                if (!jsonResponse.questions || !Array.isArray(jsonResponse.questions) {
                    throw new Error('AI không trả về câu hỏi hợp lệ. Vui lòng thử lại.');
                }
                
                // Update the exam info
                document.getElementById('examTitle').value = jsonResponse.title || 'Đề thi Ngữ Văn';
                document.getElementById('examDescription').value = jsonResponse.description || 'Đề thi được tạo bởi AI';
                document.getElementById('examTime').value = jsonResponse.timeLimit || 60;
                
                // Clear existing questions
                document.getElementById('questionsContainer').innerHTML = '';
                questions = [];
                
                // Add questions from AI
                jsonResponse.questions.forEach((q, i) => {
                    // Map AI question types to our types
                    let questionType;
                    if (q.type === 'multiple-choice') questionType = 'multiple-choice';
                    else if (q.type === 'true-false') questionType = 'true-false';
                    else if (q.type === 'short-answer') questionType = 'short-answer';
                    else if (q.type === 'essay') questionType = 'essay';
                    else questionType = 'short-answer'; // default
                    
                    // Add question
                    addQuestion(questionType);
                    
                    // Get the last added question element
                    const questionElements = document.querySelectorAll('.question-item');
                    const lastQuestionElement = questionElements[questionElements.length - 1];
                    
                    // Set content
                    lastQuestionElement.querySelector('.question-content').value = q.content || '';
                    questions[i].content = q.content || '';
                    
                    // Set points
                    lastQuestionElement.querySelector('.question-points').value = q.points || 1;
                    questions[i].points = q.points || 1;
                    
                    // Set correct answer
                    if (questionType === 'multiple-choice') {
                        // Set options
                        q.options.forEach((opt, j) => {
                            if (j < 4) { // We only support A, B, C, D
                                const optionInput = lastQuestionElement.querySelectorAll('.option-text')[j];
                                optionInput.value = opt;
                                questions[i].options[j].text = opt;
                            }
                        });
                        
                        // Set correct answer
                        if (q.correctAnswer) {
                            const correctValue = q.correctAnswer.toUpperCase();
                            if (['A', 'B', 'C', 'D'].includes(correctValue)) {
                                const correctRadio = lastQuestionElement.querySelector(`.correct-answer[value="${correctValue}"]`);
                                if (correctRadio) {
                                    correctRadio.checked = true;
                                    questions[i].correctAnswer = correctValue;
                                }
                            }
                        }
                    } 
                    else if (questionType === 'true-false') {
                        if (q.correctAnswer) {
                            const correctValue = String(q.correctAnswer).toLowerCase() === 'true' ? 'true' : 'false';
                            const correctRadio = lastQuestionElement.querySelector(`.correct-answer[value="${correctValue}"]`);
                            if (correctRadio) {
                                correctRadio.checked = true;
                                questions[i].correctAnswer = correctValue;
                            }
                        }
                    }
                    else {
                        // For short answer and essay
                        const answerTextarea = lastQuestionElement.querySelector('.correct-answer');
                        answerTextarea.value = q.correctAnswer || '';
                        questions[i].correctAnswer = q.correctAnswer || '';
                    }
                });
                
                // Show manual creation tab
                document.getElementById('manual-tab').click();
                document.getElementById('manualCreationButtons').style.display = 'flex';
                
                hideLoading();
                showSuccess('Đề thi đã được tạo thành công bởi AI. Bạn có thể chỉnh sửa nếu cần.');
                
            } catch (error) {
                hideLoading();
                alert('Lỗi khi tạo đề thi với AI: ' + error.message);
                console.error('AI generation error:', error);
            }
        }
        
        // File Processing Functions
        function handleWordFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const btn = document.getElementById('processWordBtn');
            btn.disabled = true;
            
            // Show preview
            const previewContainer = document.getElementById('wordFilePreviewContainer');
            previewContainer.style.display = 'block';
            const previewElement = document.getElementById('wordFilePreview');
            previewElement.innerHTML = '<p class="text-muted">Đang đọc file Word...</p>';
            
            // Read Word file
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(function(result) {
                        const text = result.value;
                        previewElement.innerHTML = `<pre>${text}</pre>`;
                        btn.disabled = false;
                    })
                    .catch(function(error) {
                        previewElement.innerHTML = `<p class="text-danger">Lỗi khi đọc file Word: ${error.message}</p>`;
                        console.error('Word processing error:', error);
                    });
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processWordFile() {
            const file = document.getElementById('wordFile').files[0];
            if (!file) return;
            
            showLoading('Đang xử lý file Word...');
            
            // In a real app, you would send this to your backend for processing with AI
            // For this example, we'll simulate it with a timeout
            setTimeout(() => {
                hideLoading();
                alert('Chức năng xử lý file Word với AI cần được triển khai ở backend. Trong demo này, bạn có thể sử dụng chức năng AI với nội dung đã đọc từ file Word.');
                
                // Copy the text to AI prompt
                const previewText = document.getElementById('wordFilePreview').textContent;
                document.getElementById('aiPrompt').value = "File Word chứa nội dung sau:\n\n" + previewText + 
                    "\n\nHãy tạo một đề thi Ngữ Văn dựa trên nội dung trên.";
                
                // Switch to AI tab
                document.getElementById('ai-tab').click();
            }, 1500);
        }
        
        function handleImageFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const previewContainer = document.getElementById('imagePreviewContainer');
            const previewElement = document.getElementById('imagePreview');
            const btn = document.getElementById('processImageBtn');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewElement.src = e.target.result;
                previewContainer.style.display = 'block';
                btn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        function openCamera() {
            document.getElementById('cameraContainer').style.display = 'block';
            document.getElementById('openCameraBtn').style.display = 'none';
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    const video = document.getElementById('cameraPreview');
                    video.srcObject = stream;
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    alert('Không thể truy cập camera: ' + err.message);
                    closeCamera();
                });
        }
        
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('openCameraBtn').style.display = 'block';
        }
        
        function captureImage() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('imageCanvas');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const previewElement = document.getElementById('imagePreview');
            const btn = document.getElementById('processImageBtn');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            previewElement.src = canvas.toDataURL('image/png');
            previewContainer.style.display = 'block';
            btn.disabled = false;
            
            closeCamera();
        }
        
        function processImage() {
            showLoading('Đang xử lý hình ảnh với AI...');
            
            // In a real app, you would send the image to your backend for OCR processing
            // For this example, we'll simulate it with a timeout
            setTimeout(() => {
                hideLoading();
                alert('Chức năng xử lý hình ảnh với AI cần được triển khai ở backend với dịch vụ OCR như Google Vision hoặc Tesseract.js.');
                
                // For demo purposes, we'll suggest using manual creation or AI prompt
                document.getElementById('manual-tab').click();
            }, 1500);
        }
        
        // Preview Functions
        function preparePreview() {
            // Update basic info
            document.getElementById('previewExamTitle').textContent = document.getElementById('examTitle').value;
            document.getElementById('previewExamDescription').textContent = document.getElementById('examDescription').value;
            document.getElementById('previewExamTime').textContent = document.getElementById('examTime').value;
            
            // Generate questions preview
            const previewContainer = document.getElementById('previewQuestions');
            previewContainer.innerHTML = '';
            
            questions.forEach((question, index) => {
                let template;
                
                if (question.type === 'multiple-choice') {
                    template = document.getElementById('previewMultipleChoiceTemplate').innerHTML;
                    template = template.replace(/{number}/g, index + 1);
                    template = template.replace(/{content}/g, question.content);
                    template = template.replace(/{points}/g, question.points);
                    template = template.replace(/{index}/g, index);
                    template = template.replace(/{optionA}/g, question.options[0].text);
                    template = template.replace(/{optionB}/g, question.options[1].text);
                    template = template.replace(/{optionC}/g, question.options[2].text);
                    template = template.replace(/{optionD}/g, question.options[3].text);
                } 
                else if (question.type === 'true-false') {
                    template = document.getElementById('previewTrueFalseTemplate').innerHTML;
                    template = template.replace(/{number}/g, index + 1);
                    template = template.replace(/{content}/g, question.content);
                    template = template.replace(/{points}/g, question.points);
                    template = template.replace(/{index}/g, index);
                } 
                else if (question.type === 'short-answer') {
                    template = document.getElementById('previewShortAnswerTemplate').innerHTML;
                    template = template.replace(/{number}/g, index + 1);
                    template = template.replace(/{content}/g, question.content);
                    template = template.replace(/{points}/g, question.points);
                    template = template.replace(/{index}/g, index);
                } 
                else if (question.type === 'essay') {
                    template = document.getElementById('previewEssayTemplate').innerHTML;
                    template = template.replace(/{number}/g, index + 1);
                    template = template.replace(/{content}/g, question.content);
                    template = template.replace(/{points}/g, question.points);
                    template = template.replace(/{index}/g, index);
                }
                
                const div = document.createElement('div');
                div.innerHTML = template;
                previewContainer.appendChild(div);
            });
            
            // Generate a temporary exam ID (in real app, this would come from Firebase)
            examId = 'exam-' + Math.random().toString(36).substr(2, 9);
            const examLink = `${window.location.origin}/take-exam.html?id=${examId}`;
            document.getElementById('examLink').value = examLink;
            
            // Generate QR code
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: examLink,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        function copyExamLink() {
            const linkInput = document.getElementById('examLink');
            linkInput.select();
            document.execCommand('copy');
            
            // Show tooltip or notification
            alert('Đã sao chép link vào clipboard!');
        }
        
        // Publish Exam
        async function publishExam() {
            showLoading('Đang lưu đề thi...');
            
            try {
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Bạn cần đăng nhập để lưu đề thi');
                }
                
                // Prepare exam data
                const examData = {
                    title: document.getElementById('examTitle').value,
                    description: document.getElementById('examDescription').value,
                    timeLimit: parseInt(document.getElementById('examTime').value),
                    subject: document.getElementById('examSubject').value,
                    questions: questions,
                    antiCheatSettings: {
                        preventCopyPaste: document.getElementById('preventCopyPaste').checked,
                        preventTabSwitch: document.getElementById('preventTabSwitch').checked,
                        fullScreenRequired: document.getElementById('fullScreenRequired').checked,
                        enableWebcam: document.getElementById('enableWebcam').checked,
                        notificationEmail: document.getElementById('cheatNotificationEmail').value,
                        notificationMessage: document.getElementById('cheatNotificationMessage').value
                    },
                    visibility: document.getElementById('examVisibility').value,
                    password: document.getElementById('examPassword').value || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid,
                    participants: []
                };
                
                // Save to Firestore
                const examRef = await db.collection('exams').add(examData);
                examId = examRef.id;
                
                // Update exam link with real ID
                const examLink = `${window.location.origin}/take-exam.html?id=${examId}`;
                document.getElementById('examLink').value = examLink;
                
                // Regenerate QR code with real ID
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: examLink,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                hideLoading();
                showSuccess('Đề thi đã được lưu thành công! Bạn có thể chia sẻ link hoặc QR code cho thí sinh.');
                document.getElementById('finishBtn').style.display = 'block';
                
            } catch (error) {
                hideLoading();
                alert('Lỗi khi lưu đề thi: ' + error.message);
                console.error('Publish error:', error);
            }
        }
        
        // UI Helper Functions
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();
        }
        
        function hideLoading() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
            if (modal) modal.hide();
        }
        
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }
    </script>
</body>
</html>
