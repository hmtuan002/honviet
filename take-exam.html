<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tham gia thi Văn học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #e6f2ff;
            --accent-color: #3b7ddd;
            --text-color: #333;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: #f5f7fa;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 500;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 137, 220, 0.25);
        }
        
        .exam-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        .question-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .timer-container {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 8px;
        }
        
        .timer-warning {
            color: var(--danger-color);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .option-label {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .option-label:hover {
            background-color: var(--secondary-color);
        }
        
        .option-radio {
            margin-right: 10px;
        }
        
        .text-answer {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .text-answer:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .exam-complete {
            text-align: center;
            padding: 40px 20px;
        }
        
        .exam-complete-icon {
            font-size: 5rem;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        .qr-scanner-container {
            width: 100%;
            height: 300px;
            background-color: #eee;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .qr-scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .qr-scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-scanner-overlay::before {
            content: '';
            position: absolute;
            width: 80%;
            height: 2px;
            background-color: rgba(255, 0, 0, 0.5);
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
            border: 1px solid var(--border-color);
            border-top: none;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .fullscreen-warning i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--danger-color);
        }
        
        .ai-result-container {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .ai-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin: 10px 0;
        }
        
        .ai-feedback {
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .ai-feedback-good {
            border-left: 4px solid var(--success-color);
        }
        
        .ai-feedback-bad {
            border-left: 4px solid var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>Văn Học Exam
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-exam.html"><i class="fas fa-plus-circle me-1"></i> Tạo đề</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="take-exam.html"><i class="fas fa-pen-alt me-1"></i> Thi thử</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="manage-exam.html"><i class="fas fa-clipboard-list me-1"></i> Quản lý</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html"><i class="fas fa-sign-in-alt me-1"></i> Đăng nhập</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Exam Selection -->
                <div class="card" id="examSelectionCard">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-pen-alt me-2"></i>Tham gia thi</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="examTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="join-tab" data-bs-toggle="tab" data-bs-target="#join" type="button" role="tab">Thi đề có sẵn</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">Thi đề AI</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="examTypeTabsContent">
                            <!-- Join Exam Tab -->
                            <div class="tab-pane fade show active" id="join" role="tabpanel">
                                <div class="mt-3">
                                    <h5><i class="fas fa-link me-2"></i>Tham gia bằng link hoặc mã</h5>
                                    <div class="mb-3">
                                        <label for="examLink" class="form-label">Link hoặc mã đề thi</label>
                                        <input type="text" class="form-control" id="examLink" placeholder="Nhập link hoặc mã đề thi (ví dụ: VAN-5X7D9)">
                                    </div>
                                    <button class="btn btn-primary" id="joinExamBtn">
                                        <i class="fas fa-sign-in-alt me-2"></i> Tham gia thi
                                    </button>
                                    
                                    <hr>
                                    
                                    <h5><i class="fas fa-qrcode me-2"></i>Hoặc quét mã QR</h5>
                                    <div class="qr-scanner-container">
                                        <div id="qrScannerPlaceholder">
                                            <i class="fas fa-qrcode fa-5x text-muted"></i>
                                            <p class="mt-3">Nhấn nút bên dưới để bật quét mã QR</p>
                                        </div>
                                        <video id="qrScanner" style="display: none;"></video>
                                        <div class="qr-scanner-overlay" style="display: none;"></div>
                                    </div>
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn btn-primary" id="startScannerBtn">
                                            <i class="fas fa-camera me-2"></i> Bật quét QR
                                        </button>
                                        <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">
                                            <i class="fas fa-stop me-2"></i> Dừng quét
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Exam Tab -->
                            <div class="tab-pane fade" id="ai" role="tabpanel">
                                <div class="mt-3">
                                    <h5><i class="fas fa-robot me-2"></i>Thi đề do AI tạo</h5>
                                    <p class="text-muted">AI sẽ tạo ngẫu nhiên một đề thi văn học dựa trên yêu cầu của bạn và chấm điểm ngay sau khi hoàn thành.</p>
                                    
                                    <div class="mb-3">
                                        <label for="aiExamTopic" class="form-label">Chủ đề bạn muốn thi</label>
                                        <input type="text" class="form-control" id="aiExamTopic" placeholder="Ví dụ: Tác phẩm 'Chí Phèo' của Nam Cao">
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="aiQuestionCount" class="form-label">Số lượng câu hỏi</label>
                                            <select class="form-select" id="aiQuestionCount">
                                                <option value="5">5 câu</option>
                                                <option value="10" selected>10 câu</option>
                                                <option value="15">15 câu</option>
                                                <option value="20">20 câu</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="aiExamDuration" class="form-label">Thời gian làm bài (phút)</label>
                                            <select class="form-select" id="aiExamDuration">
                                                <option value="10">10 phút</option>
                                                <option value="20">20 phút</option>
                                                <option value="30" selected>30 phút</option>
                                                <option value="45">45 phút</option>
                                                <option value="60">60 phút</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" id="startAIExamBtn">
                                        <i class="fas fa-play me-2"></i> Bắt đầu thi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exam Info (hidden by default) -->
                <div class="exam-info d-none" id="examInfo">
                    <h4 id="examTitle">Đề thi học kỳ I môn Ngữ Văn 12</h4>
                    <p id="examDescription">Đề thi bao gồm các câu hỏi về tác phẩm "Vợ chồng A Phủ" và "Chiếc thuyền ngoài xa"</p>
                    <div class="d-flex justify-content-between">
                        <div>
                            <span class="text-muted"><i class="fas fa-clock me-1"></i> Thời gian: </span>
                            <span id="examDuration">60 phút</span>
                        </div>
                        <div>
                            <span class="text-muted"><i class="fas fa-book me-1"></i> Môn: </span>
                            <span id="examSubject">Ngữ Văn 12</span>
                        </div>
                    </div>
                </div>
                
                <!-- Student Info Form (hidden by default) -->
                <div class="card d-none" id="studentInfoCard">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Thông tin thí sinh</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="studentName" placeholder="Nhập họ và tên của bạn">
                        </div>
                        <div class="mb-3">
                            <label for="studentClass" class="form-label">Lớp (nếu có)</label>
                            <input type="text" class="form-control" id="studentClass" placeholder="Nhập lớp của bạn (không bắt buộc)">
                        </div>
                        <div class="mb-3">
                            <label for="studentEmail" class="form-label">Email (nếu có)</label>
                            <input type="email" class="form-control" id="studentEmail" placeholder="Nhập email của bạn (không bắt buộc)">
                        </div>
                        <button class="btn btn-primary" id="startExamBtn">
                            <i class="fas fa-play me-2"></i> Bắt đầu làm bài
                        </button>
                    </div>
                </div>
                
                <!-- Exam Content (hidden by default) -->
                <div class="d-none" id="examContent">
                    <div id="questionsContainer">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary" id="saveDraftBtn">
                            <i class="fas fa-save me-2"></i> Lưu nháp
                        </button>
                        <button class="btn btn-danger" id="submitExamBtn">
                            <i class="fas fa-paper-plane me-2"></i> Nộp bài
                        </button>
                    </div>
                </div>
                
                <!-- Exam Complete (hidden by default) -->
                <div class="card d-none" id="examCompleteCard">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i>Hoàn thành bài thi</h4>
                    </div>
                    <div class="card-body">
                        <div id="regularExamComplete" class="exam-complete">
                            <i class="fas fa-check-circle exam-complete-icon"></i>
                            <h3>Bạn đã hoàn thành bài thi!</h3>
                            <p class="text-muted">Kết quả sẽ được gửi về cho người tạo đề và bạn có thể xem điểm khi được chấm xong.</p>
                            <button class="btn btn-primary" id="backToHomeBtn">
                                <i class="fas fa-home me-2"></i> Về trang chủ
                            </button>
                        </div>
                        
                        <div id="aiExamComplete" class="exam-complete d-none">
                            <i class="fas fa-robot exam-complete-icon"></i>
                            <h3>AI đang chấm điểm bài làm của bạn</h3>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-3" id="aiGradingText">Đang phân tích câu trả lời...</p>
                            
                            <div id="aiResult" class="d-none">
                                <div class="ai-result-container">
                                    <h5 class="text-center">Kết quả bài thi</h5>
                                    <div class="ai-score">
                                        Điểm số: <span id="aiExamScore">8.5</span>/10
                                    </div>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-success" id="aiExamScoreBar" role="progressbar" style="width: 85%"></div>
                                    </div>
                                    
                                    <h6 class="text-center">Nhận xét của AI</h6>
                                    <p id="aiGeneralFeedback" class="text-center">Bạn đã làm bài rất tốt, hiểu sâu về tác phẩm và có cách phân tích logic.</p>
                                    
                                    <div id="aiDetailedFeedback">
                                        <!-- Detailed feedback will be added here -->
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary mt-4" id="tryAnotherExamBtn">
                                    <i class="fas fa-redo me-2"></i> Làm đề khác
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Container -->
    <div class="timer-container d-none" id="timerContainer">
        <i class="fas fa-clock"></i>
        <div class="timer" id="examTimer">60:00</div>
    </div>

    <!-- Fullscreen Warning (hidden by default) -->
    <div class="fullscreen-warning d-none" id="fullscreenWarning">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Vui lòng bật chế độ toàn màn hình để tiếp tục làm bài</h3>
        <p>Bạn có 10 giây để bật chế độ toàn màn hình, nếu không bài thi sẽ tự động nộp.</p>
        <div class="mt-3" id="fullscreenCountdown">10</div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container">
        <div class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successToastMessage">Thao tác thành công!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        
        <div class="toast align-items-center text-white bg-danger" role="alert" aria-live="assertive" aria-atomic="true" id="errorToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorToastMessage">Đã xảy ra lỗi!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Question Template (hidden) -->
    <div class="d-none">
        <div class="question-template question-container">
            <h5>Câu <span class="question-number">1</span>: <span class="question-content">Nội dung câu hỏi</span></h5>
            <p class="text-muted mb-3"><small><span class="question-points">1</span> điểm</small></p>
            
            <div class="multiple-choice-options">
                <label class="option-label">
                    <input type="radio" class="option-radio" name="question_X" value="A">
                    <span class="option-text">A. <span class="option-a">Đáp án A</span></span>
                </label>
                <label class="option-label">
                    <input type="radio" class="option-radio" name="question_X" value="B">
                    <span class="option-text">B. <span class="option-b">Đáp án B</span></span>
                </label>
                <label class="option-label">
                    <input type="radio" class="option-radio" name="question_X" value="C">
                    <span class="option-text">C. <span class="option-c">Đáp án C</span></span>
                </label>
                <label class="option-label">
                    <input type="radio" class="option-radio" name="question_X" value="D">
                    <span class="option-text">D. <span class="option-d">Đáp án D</span></span>
                </label>
            </div>
            
            <div class="true-false-options d-none">
                <label class="option-label">
                    <input type="radio" class="option-radio" name="question_X" value="true">
                    <span class="option-text">Đúng</span>
                </label>
                <label class="option-label">
                    <input type="radio" class="option-radio" name="question_X" value="false">
                    <span class="option-text">Sai</span>
                </label>
            </div>
            
            <div class="text-answer-options d-none">
                <textarea class="text-answer" placeholder="Nhập câu trả lời của bạn..."></textarea>
            </div>
            
            <div class="question-hint-container mt-3 d-none">
                <div class="alert alert-info p-2">
                    <i class="fas fa-lightbulb me-2"></i>
                    <small class="question-hint">Gợi ý cho câu hỏi</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
            authDomain: "literatureexamapp.firebaseapp.com",
            projectId: "literatureexamapp",
            storageBucket: "literatureexamapp.appspot.com",
            messagingSenderId: "829681704033",
            appId: "1:829681704033:web:f92a79de0c177b235b9e20"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Initialize Gemini AI (simulated)
        const geminiConfig = {
            apiKey: 'AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM',
            model: 'gemini-2.5-flash-preview-05-20'
        };

        // DOM Elements
        const examSelectionCard = document.getElementById('examSelectionCard');
        const examInfo = document.getElementById('examInfo');
        const studentInfoCard = document.getElementById('studentInfoCard');
        const examContent = document.getElementById('examContent');
        const examCompleteCard = document.getElementById('examCompleteCard');
        const regularExamComplete = document.getElementById('regularExamComplete');
        const aiExamComplete = document.getElementById('aiExamComplete');
        const aiResult = document.getElementById('aiResult');
        const timerContainer = document.getElementById('timerContainer');
        const examTimer = document.getElementById('examTimer');
        const fullscreenWarning = document.getElementById('fullscreenWarning');
        const fullscreenCountdown = document.getElementById('fullscreenCountdown');
        
        // QR Scanner elements
        const qrScannerPlaceholder = document.getElementById('qrScannerPlaceholder');
        const qrScanner = document.getElementById('qrScanner');
        const qrScannerOverlay = document.querySelector('.qr-scanner-overlay');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        
        // Toast elements
        const successToast = new bootstrap.Toast(document.getElementById('successToast'));
        const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
        
        // Exam data
        let currentExam = {
            id: '',
            title: '',
            description: '',
            duration: 60,
            subject: '',
            grade: '',
            questions: [],
            security: {
                preventCopyPaste: true,
                preventTabSwitch: true,
                enableFullscreen: false,
                enableMonitoring: false,
                password: '',
                access: 'private'
            },
            isAIExam: false,
            creatorId: ''
        };
        
        let studentAnswers = {};
        let examInterval;
        let timeLeft = 0;
        let isFullscreen = false;
        let fullscreenTimeout;
        let qrStream = null;
        let qrCanvas = document.createElement('canvas');
        let qrCanvasContext = qrCanvas.getContext('2d');
        
        // Show success toast
        function showSuccess(message) {
            document.getElementById('successToastMessage').textContent = message;
            successToast.show();
        }
        
        // Show error toast
        function showError(message) {
            document.getElementById('errorToastMessage').textContent = message;
            errorToast.show();
        }
        
        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Start exam timer
        function startTimer(durationInMinutes) {
            timeLeft = durationInMinutes * 60;
            updateTimerDisplay();
            
            examInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(examInterval);
                    submitExam();
                } else if (timeLeft <= 300) { // 5 minutes left
                    examTimer.classList.add('timer-warning');
                }
            }, 1000);
        }
        
        // Update timer display
        function updateTimerDisplay() {
            examTimer.textContent = formatTime(timeLeft);
        }
        
        // Start QR scanner
        function startQRScanner() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        qrStream = stream;
                        qrScanner.srcObject = stream;
                        qrScanner.play();
                        
                        qrScannerPlaceholder.style.display = 'none';
                        qrScanner.style.display = 'block';
                        qrScannerOverlay.style.display = 'flex';
                        startScannerBtn.style.display = 'none';
                        stopScannerBtn.style.display = 'inline-block';
                        
                        // Start scanning for QR codes
                        scanQRCode();
                    })
                    .catch(function(error) {
                        showError('Không thể truy cập camera: ' + error.message);
                    });
            } else {
                showError('Trình duyệt không hỗ trợ truy cập camera');
            }
        }
        
        // Stop QR scanner
        function stopQRScanner() {
            if (qrStream) {
                qrStream.getTracks().forEach(function(track) {
                    track.stop();
                });
                qrStream = null;
            }
            
            qrScanner.srcObject = null;
            qrScanner.style.display = 'none';
            qrScannerOverlay.style.display = 'none';
            qrScannerPlaceholder.style.display = 'flex';
            startScannerBtn.style.display = 'inline-block';
            stopScannerBtn.style.display = 'none';
        }
        
        // Scan for QR codes
        function scanQRCode() {
            if (qrScanner.readyState === qrScanner.HAVE_ENOUGH_DATA) {
                qrCanvas.width = qrScanner.videoWidth;
                qrCanvas.height = qrScanner.videoHeight;
                qrCanvasContext.drawImage(qrScanner, 0, 0, qrCanvas.width, qrCanvas.height);
                
                const imageData = qrCanvasContext.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert'
                });
                
                if (code) {
                    // Found a QR code
                    const examCode = extractExamCodeFromURL(code.data);
                    if (examCode) {
                        stopQRScanner();
                        document.getElementById('examLink').value = examCode;
                        showSuccess('Đã quét mã QR thành công');
                    } else {
                        showError('Mã QR không phải là mã đề thi hợp lệ');
                    }
                }
            }
            
            if (qrStream) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Extract exam code from URL
        function extractExamCodeFromURL(url) {
            try {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                return params.get('code');
            } catch (e) {
                // If it's not a URL, maybe it's just the code
                if (url.match(/^VAN-[A-Z0-9]{5}$/)) {
                    return url;
                }
                return null;
            }
        }
        
        // Load exam data
        function loadExam(examCode) {
            showSuccess('Đang tải đề thi...');
            
            db.collection('exams').doc(examCode).get()
                .then(function(doc) {
                    if (doc.exists) {
                        const data = doc.data();
                        currentExam = {
                            id: doc.id,
                            title: data.title,
                            description: data.description,
                            duration: data.duration,
                            subject: data.subject,
                            grade: data.grade,
                            questions: data.questions,
                            security: data.security,
                            isAIExam: false,
                            creatorId: data.createdBy
                        };
                        
                        // Display exam info
                        document.getElementById('examTitle').textContent = currentExam.title;
                        document.getElementById('examDescription').textContent = currentExam.description;
                        document.getElementById('examDuration').textContent = currentExam.duration + ' phút';
                        document.getElementById('examSubject').textContent = 'Ngữ Văn ' + currentExam.grade;
                        
                        // Show exam info and student form
                        examSelectionCard.classList.add('d-none');
                        examInfo.classList.remove('d-none');
                        studentInfoCard.classList.remove('d-none');
                        
                        // Check if exam has password
                        if (currentExam.security.password) {
                            const password = prompt('Đề thi này được bảo vệ bằng mật khẩu. Vui lòng nhập mật khẩu:');
                            if (password !== currentExam.security.password) {
                                showError('Mật khẩu không đúng');
                                resetExamView();
                                return;
                            }
                        }
                    } else {
                        showError('Không tìm thấy đề thi với mã này');
                    }
                })
                .catch(function(error) {
                    console.error('Error loading exam: ', error);
                    showError('Lỗi khi tải đề thi: ' + error.message);
                });
        }
        
        // Generate AI exam
        function generateAIExam(topic, questionCount, duration) {
            showSuccess('AI đang tạo đề thi cho bạn...');
            
            // Simulate AI call (in a real app, you would call the Gemini API)
            setTimeout(function() {
                currentExam = {
                    id: 'AI-' + Date.now(),
                    title: 'Đề thi AI: ' + topic,
                    description: 'Đề thi được tạo tự động bởi AI về chủ đề: ' + topic,
                    duration: duration,
                    subject: 'ngu_van',
                    grade: '12',
                    questions: generateMockQuestions(questionCount),
                    security: {
                        preventCopyPaste: true,
                        preventTabSwitch: true,
                        enableFullscreen: false,
                        enableMonitoring: false,
                        password: '',
                        access: 'public'
                    },
                    isAIExam: true,
                    creatorId: 'AI'
                };
                
                // Display exam info
                document.getElementById('examTitle').textContent = currentExam.title;
                document.getElementById('examDescription').textContent = currentExam.description;
                document.getElementById('examDuration').textContent = currentExam.duration + ' phút';
                document.getElementById('examSubject').textContent = 'Ngữ Văn ' + currentExam.grade;
                
                // Show exam info and student form
                examSelectionCard.classList.add('d-none');
                examInfo.classList.remove('d-none');
                studentInfoCard.classList.remove('d-none');
            }, 2000);
        }
        
        // Start exam
        function startExam() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showError('Vui lòng nhập họ và tên');
                return;
            }
            
            // Save student info
            currentExam.studentInfo = {
                name: studentName,
                class: document.getElementById('studentClass').value.trim(),
                email: document.getElementById('studentEmail').value.trim(),
                startTime: new Date()
            };
            
            // Hide student info form and show exam content
            studentInfoCard.classList.add('d-none');
            examContent.classList.remove('d-none');
            timerContainer.classList.remove('d-none');
            
            // Load questions
            loadQuestions();
            
            // Start timer
            startTimer(currentExam.duration);
            
            // Apply security settings
            applySecuritySettings();
        }
        
        // Load questions into the UI
        function loadQuestions() {
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '';
            
            currentExam.questions.forEach(function(question, index) {
                const template = document.querySelector('.question-template').cloneNode(true);
                template.classList.remove('question-template', 'd-none');
                
                // Set question number and content
                template.querySelector('.question-number').textContent = index + 1;
                template.querySelector('.question-content').textContent = question.content;
                template.querySelector('.question-points').textContent = question.points;
                
                // Set question type
                if (question.type === 'multiple_choice') {
                    template.querySelector('.multiple-choice-options').classList.remove('d-none');
                    template.querySelector('.option-a').textContent = question.options.A;
                    template.querySelector('.option-b').textContent = question.options.B;
                    template.querySelector('.option-c').textContent = question.options.C;
                    template.querySelector('.option-d').textContent = question.options.D;
                    
                    // Set radio names to be unique
                    const radioName = 'question_' + index;
                    template.querySelectorAll('.option-radio').forEach(function(radio) {
                        radio.name = radioName;
                    });
                } else if (question.type === 'true_false') {
                    template.querySelector('.true-false-options').classList.remove('d-none');
                    
                    // Set radio names to be unique
                    const radioName = 'question_' + index;
                    template.querySelectorAll('.option-radio').forEach(function(radio) {
                        radio.name = radioName;
                    });
                } else {
                    template.querySelector('.text-answer-options').classList.remove('d-none');
                }
                
                // Show hint if available
                if (question.hint) {
                    template.querySelector('.question-hint').textContent = question.hint;
                    template.querySelector('.question-hint-container').classList.remove('d-none');
                }
                
                questionsContainer.appendChild(template);
            });
        }
        
        // Apply security settings
        function applySecuritySettings() {
            if (currentExam.security.enableFullscreen) {
                requestFullscreen();
            }
            
            if (currentExam.security.preventCopyPaste) {
                document.addEventListener('copy', preventCopyPaste);
                document.addEventListener('paste', preventCopyPaste);
                document.addEventListener('cut', preventCopyPaste);
            }
            
            if (currentExam.security.preventTabSwitch) {
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('blur', handleWindowBlur);
            }
        }
        
        // Prevent copy/paste
        function preventCopyPaste(e) {
            e.preventDefault();
            showError('Không được phép sao chép/dán trong khi làm bài');
        }
        
        // Handle visibility change (tab switch)
        function handleVisibilityChange() {
            if (document.hidden) {
                showError('Bạn đã chuyển tab! Bài thi sẽ tự động nộp nếu tiếp tục.');
                autoSubmitIfNotReturned();
            }
        }
        
        // Handle window blur (switching apps)
        function handleWindowBlur() {
            showError('Bạn đã chuyển sang ứng dụng khác! Bài thi sẽ tự động nộp nếu tiếp tục.');
            autoSubmitIfNotReturned();
        }
        
        // Auto submit if user doesn't return
        function autoSubmitIfNotReturned() {
            setTimeout(function() {
                if (document.hidden) {
                    submitExam();
                }
            }, 5000); // 5 seconds grace period
        }
        
        // Request fullscreen
        function requestFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showFullscreenWarning();
                });
            }
        }
        
        // Show fullscreen warning
        function showFullscreenWarning() {
            fullscreenWarning.classList.remove('d-none');
            let count = 10;
            fullscreenCountdown.textContent = count;
            
            const countdownInterval = setInterval(function() {
                count--;
                fullscreenCountdown.textContent = count;
                
                if (count <= 0) {
                    clearInterval(countdownInterval);
                    submitExam();
                }
                
                if (document.fullscreenElement) {
                    clearInterval(countdownInterval);
                    fullscreenWarning.classList.add('d-none');
                    isFullscreen = true;
                }
            }, 1000);
        }
        
        // Collect student answers
        function collectAnswers() {
            studentAnswers = {};
            
            currentExam.questions.forEach(function(question, index) {
                const questionId = 'question_' + index;
                
                if (question.type === 'multiple_choice' || question.type === 'true_false') {
                    const selectedOption = document.querySelector(`input[name="${questionId}"]:checked`);
                    if (selectedOption) {
                        studentAnswers[index] = selectedOption.value;
                    }
                } else {
                    const textAnswer = document.querySelectorAll('.text-answer')[index];
                    if (textAnswer && textAnswer.value.trim()) {
                        studentAnswers[index] = textAnswer.value.trim();
                    }
                }
            });
            
            return studentAnswers;
        }
        
        // Submit exam
        function submitExam() {
            clearInterval(examInterval);
            timerContainer.classList.add('d-none');
            
            // Remove security event listeners
            document.removeEventListener('copy', preventCopyPaste);
            document.removeEventListener('paste', preventCopyPaste);
            document.removeEventListener('cut', preventCopyPaste);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);
            
            // Collect answers
            collectAnswers();
            
            // Hide exam content and show completion screen
            examContent.classList.add('d-none');
            examCompleteCard.classList.remove('d-none');
            
            if (currentExam.isAIExam) {
                // Show AI grading screen
                regularExamComplete.classList.add('d-none');
                aiExamComplete.classList.remove('d-none');
                
                // Simulate AI grading
                gradeWithAI();
            } else {
                // Regular exam - save to Firestore
                saveExamResults();
            }
        }
        
        // Save exam results to Firestore
        function saveExamResults() {
            const examResults = {
                examId: currentExam.id,
                examTitle: currentExam.title,
                studentInfo: currentExam.studentInfo,
                answers: studentAnswers,
                submittedAt: new Date(),
                score: null, // To be filled by teacher
                graded: false
            };
            
            db.collection('examResults').add(examResults)
                .then(function(docRef) {
                    showSuccess('Bài thi đã được nộp thành công!');
                })
                .catch(function(error) {
                    console.error('Error saving exam results: ', error);
                    showError('Lỗi khi lưu kết quả bài thi');
                });
        }
        
        // Grade with AI (simulated)
        function gradeWithAI() {
            const gradingTexts = [
                "Đang phân tích câu trả lời...",
                "Đang đánh giá kiến thức văn học...",
                "Đang kiểm tra khả năng phân tích...",
                "Đang tổng hợp kết quả..."
            ];
            
            let step = 0;
            const aiGradingText = document.getElementById('aiGradingText');
            
            const gradingInterval = setInterval(function() {
                aiGradingText.textContent = gradingTexts[step];
                step++;
                
                if (step >= gradingTexts.length) {
                    clearInterval(gradingInterval);
                    showAIResults();
                }
            }, 1500);
        }
        
        // Show AI results
        function showAIResults() {
            // Calculate score (simulated)
            const totalQuestions = currentExam.questions.length;
            let correctAnswers = 0;
            const feedbacks = [];
            
            currentExam.questions.forEach(function(question, index) {
                if (question.type === 'multiple_choice' || question.type === 'true_false') {
                    if (studentAnswers[index] === question.correctAnswer) {
                        correctAnswers++;
                        feedbacks.push({
                            question: question.content,
                            correct: true,
                            feedback: "Câu trả lời chính xác! Bạn hiểu rõ về " + question.content.split(':')[0]
                        });
                    } else {
                        feedbacks.push({
                            question: question.content,
                            correct: false,
                            feedback: "Câu trả lời chưa chính xác. Đáp án đúng là: " + 
                                (question.type === 'multiple_choice' ? question.correctAnswer : 
                                (question.correctAnswer === 'true' ? 'Đúng' : 'Sai'))
                        });
                    }
                } else {
                    // For text answers, simulate some random feedback
                    const isGood = Math.random() > 0.3;
                    if (isGood) {
                        correctAnswers += 0.8; // Partial credit for text answers
                        feedbacks.push({
                            question: question.content,
                            correct: true,
                            feedback: "Câu trả lời tốt! Bạn đã phân tích " + question.content.split(':')[0] + " một cách chi tiết"
                        });
                    } else {
                        correctAnswers += 0.3; // Some credit
                        feedbacks.push({
                            question: question.content,
                            correct: false,
                            feedback: "Câu trả lời cần cải thiện. Bạn nên tập trung vào " + 
                                question.content.split(':')[0] + " nhiều hơn"
                        });
                    }
                }
            });
            
            const score = Math.round((correctAnswers / totalQuestions) * 100) / 10; // Score out of 10
            
            // Display results
            document.getElementById('aiExamScore').textContent = score;
            document.getElementById('aiExamScoreBar').style.width = (score * 10) + '%';
            
            // General feedback
            let generalFeedback = '';
            if (score >= 8) {
                generalFeedback = "Xuất sắc! Bạn có kiến thức văn học rất tốt và khả năng phân tích sâu sắc.";
            } else if (score >= 6) {
                generalFeedback = "Tốt! Bạn hiểu các tác phẩm văn học nhưng cần cải thiện khả năng phân tích.";
            } else if (score >= 4) {
                generalFeedback = "Khá! Bạn có kiến thức cơ bản nhưng cần đọc kỹ tác phẩm và ôn tập thêm.";
            } else {
                generalFeedback = "Cần cải thiện! Bạn nên đọc lại các tác phẩm và tìm hiểu sâu hơn về chúng.";
            }
            
            document.getElementById('aiGeneralFeedback').textContent = generalFeedback;
            
            // Detailed feedback
            const detailedFeedbackContainer = document.getElementById('aiDetailedFeedback');
            detailedFeedbackContainer.innerHTML = '<h6 class="mt-4">Chi tiết từng câu:</h6>';
            
            feedbacks.forEach(function(feedback, index) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = `ai-feedback ${feedback.correct ? 'ai-feedback-good' : 'ai-feedback-bad'}`;
                
                const questionHeader = document.createElement('div');
                questionHeader.className = 'fw-bold';
                questionHeader.textContent = `Câu ${index + 1}: ${feedback.question}`;
                
                const feedbackText = document.createElement('div');
                feedbackText.textContent = feedback.feedback;
                
                feedbackDiv.appendChild(questionHeader);
                feedbackDiv.appendChild(feedbackText);
                detailedFeedbackContainer.appendChild(feedbackDiv);
            });
            
            // Show results
            aiResult.classList.remove('d-none');
        }
        
        // Reset exam view
        function resetExamView() {
            examSelectionCard.classList.remove('d-none');
            examInfo.classList.add('d-none');
            studentInfoCard.classList.add('d-none');
            examContent.classList.add('d-none');
            examCompleteCard.classList.add('d-none');
            timerContainer.classList.add('d-none');
            
            // Clear form
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentEmail').value = '';
            
            // Clear any intervals
            clearInterval(examInterval);
        }
        
        // Generate mock questions for AI exam
        function generateMockQuestions(count) {
            const mockQuestions = [];
            const literatureTopics = [
                "Tác phẩm 'Vợ chồng A Phủ' của Tô Hoài",
                "Truyện ngắn 'Chiếc thuyền ngoài xa' của Nguyễn Minh Châu",
                "Bài thơ 'Sóng' của Xuân Quỳnh",
                "Tác phẩm 'Chí Phèo' của Nam Cao",
                "Truyện 'Hai đứa trẻ' của Thạch Lam",
                "Bài thơ 'Đây thôn Vĩ Dạ' của Hàn Mặc Tử",
                "Tác phẩm 'Rừng xà nu' của Nguyễn Trung Thành",
                "Truyện 'Vợ nhặt' của Kim Lân",
                "Bài thơ 'Việt Bắc' của Tố Hữu",
                "Tác phẩm 'Người lái đò sông Đà' của Nguyễn Tuân"
            ];
            
            for (let i = 0; i < count; i++) {
                const topic = literatureTopics[Math.floor(Math.random() * literatureTopics.length)];
                const type = i % 4 === 0 ? 'multiple_choice' : 
                            i % 4 === 1 ? 'true_false' : 
                            i % 4 === 2 ? 'short_answer' : 'essay';
                
                const question = {
                    type: type,
                    content: 'Câu hỏi về ' + topic + ': ' + getQuestionContent(type, topic),
                    points: Math.floor(Math.random() * 3) + 1,
                    hint: i % 3 === 0 ? 'Gợi ý: Xem lại tác phẩm ' + (topic.split("'")[1] || topic) : undefined
                };
                
                if (type === 'multiple_choice') {
                    question.options = {
                        A: getRandomOption(topic, 'A'),
                        B: getRandomOption(topic, 'B'),
                        C: getRandomOption(topic, 'C'),
                        D: getRandomOption(topic, 'D')
                    };
                    question.correctAnswer = ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)];
                } else if (type === 'true_false') {
                    question.correctAnswer = Math.random() > 0.5 ? 'true' : 'false';
                } else {
                    question.modelAnswer = getModelAnswer(topic);
                }
                
                mockQuestions.push(question);
            }
            
            return mockQuestions;
        }
        
        function getQuestionContent(type, topic) {
            if (type === 'multiple_choice') {
                const questions = [
                    'Tác giả của ' + topic + ' là ai?',
                    'Nội dung chính của ' + topic + ' là gì?',
                    'Nhân vật chính trong ' + topic + ' là ai?',
                    'Bối cảnh của ' + topic + ' diễn ra ở đâu?'
                ];
                return questions[Math.floor(Math.random() * questions.length)];
            } else if (type === 'true_false') {
                const statements = [
                    topic + ' được sáng tác trong thời kỳ kháng chiến chống Mỹ.',
                    'Nhân vật chính trong ' + topic + ' là người nông dân.',
                    topic + ' thuộc thể loại truyện ngắn.',
                    'Tác phẩm ' + topic + ' được viết theo bút pháp hiện thực.'
                ];
                return statements[Math.floor(Math.random() * statements.length)];
            } else {
                const prompts = [
                    'Phân tích nhân vật chính trong ' + topic + '.',
                    'Nêu cảm nhận của em về ' + topic + '.',
                    'Trình bày giá trị nghệ thuật của ' + topic + '.',
                    'Phân tích một đoạn văn tiêu biểu trong ' + topic + '.'
                ];
                return prompts[Math.floor(Math.random() * prompts.length)];
            }
        }
        
        function getRandomOption(topic, option) {
            const authors = ["Tô Hoài", "Nguyễn Minh Châu", "Xuân Quỳnh", "Nam Cao", "Thạch Lam", "Hàn Mặc Tử", "Nguyễn Trung Thành", "Kim Lân", "Tố Hữu", "Nguyễn Tuân"];
            const places = ["Tây Bắc", "Huế", "Hà Nội", "Nông thôn Việt Nam", "Miền núi", "Đồng bằng", "Thành phố", "Làng quê"];
            const characters = ["Mị", "A Phủ", "Người đàn bà hàng chài", "Phùng", "Chí Phèo", "Thị Nở", "Liên", "Anh", "Người lái đò"];
            
            const randomOption = [
                authors[Math.floor(Math.random() * authors.length)],
                places[Math.floor(Math.random() * places.length)],
                characters[Math.floor(Math.random() * characters.length)],
                "Tất cả các đáp án trên"
            ][Math.floor(Math.random() * 4)];
            
            return randomOption;
        }
        
        function getModelAnswer(topic) {
            const answers = [
                topic + ' là một tác phẩm xuất sắc trong nền văn học Việt Nam hiện đại. Tác phẩm này đã khắc họa thành công...',
                'Nhân vật chính trong ' + topic + ' là hình tượng tiêu biểu cho... Tác giả đã sử dụng nghệ thuật miêu tả tâm lý nhân vật rất tinh tế...',
                'Giá trị nhân đạo của ' + topic + ' thể hiện qua... Tác phẩm đã lên án những bất công trong xã hội và đồng cảm với số phận...',
                'Nghệ thuật kể chuyện trong ' + topic + ' rất độc đáo với... Tác giả sử dụng ngôn ngữ giản dị nhưng giàu hình ảnh và cảm xúc...'
            ];
            
            return answers[Math.floor(Math.random() * answers.length)];
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's an exam code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const examCode = urlParams.get('code');
            
            if (examCode) {
                document.getElementById('examLink').value = examCode;
                loadExam(examCode);
            }
            
            // Join exam button
            document.getElementById('joinExamBtn').addEventListener('click', function() {
                const examLink = document.getElementById('examLink').value.trim();
                const examCode = extractExamCodeFromURL(examLink) || examLink;
                
                if (!examCode) {
                    showError('Vui lòng nhập link hoặc mã đề thi hợp lệ');
                    return;
                }
                
                loadExam(examCode);
            });
            
            // Start AI exam button
            document.getElementById('startAIExamBtn').addEventListener('click', function() {
                const topic = document.getElementById('aiExamTopic').value.trim();
                const questionCount = parseInt(document.getElementById('aiQuestionCount').value);
                const duration = parseInt(document.getElementById('aiExamDuration').value);
                
                if (!topic) {
                    showError('Vui lòng nhập chủ đề bạn muốn thi');
                    return;
                }
                
                generateAIExam(topic, questionCount, duration);
            });
            
            // Start exam button
            document.getElementById('startExamBtn').addEventListener('click', startExam);
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                collectAnswers();
                showSuccess('Đã lưu nháp câu trả lời');
            });
            
            // Submit exam button
            document.getElementById('submitExamBtn').addEventListener('click', function() {
                if (confirm('Bạn có chắc chắn muốn nộp bài? Sau khi nộp bạn không thể làm lại.')) {
                    submitExam();
                }
            });
            
            // Back to home button
            document.getElementById('backToHomeBtn').addEventListener('click', function() {
                window.location.href = 'index.html';
            });
            
            // Try another exam button
            document.getElementById('tryAnotherExamBtn').addEventListener('click', resetExamView);
            
            // QR scanner buttons
            startScannerBtn.addEventListener('click', startQRScanner);
            stopScannerBtn.addEventListener('click', stopQRScanner);
            
            // Fullscreen change event
            document.addEventListener('fullscreenchange', function() {
                isFullscreen = !!document.fullscreenElement;
            });
        });
    </script>
</body>
</html>
