<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tham gia thi Văn học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #e6f2ff;
            --accent-color: #3b7ddd;
            --text-color: #333;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
            --danger-color: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: #f5f7fa;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 500;
        }
        
        .exam-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .exam-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .question-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }
        
        .question-number {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .timer-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .option-label {
            display: block;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: var(--light-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option-label:hover {
            background-color: var(--secondary-color);
        }
        
        .option-radio:checked + .option-label {
            background-color: var(--primary-color);
            color: white;
        }
        
        .true-false-option {
            display: inline-block;
            margin-right: 15px;
        }
        
        .text-answer {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            resize: vertical;
        }
        
        .submit-btn {
            width: 100%;
            padding: 12px;
            font-weight: 600;
        }
        
        .qr-scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        #qr-video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .qr-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .qr-overlay-box {
            width: 70%;
            height: 70%;
            border: 4px dashed rgba(255, 255, 255, 0.7);
            position: relative;
        }
        
        .exam-result {
            text-align: center;
            padding: 30px;
        }
        
        .result-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .result-success {
            color: #2ecc71;
        }
        
        .result-score {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .result-feedback {
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
            border: 1px solid var(--border-color);
            border-top: none;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .ai-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .ai-loading .spinner {
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .timer-container {
                bottom: 10px;
                right: 10px;
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>Văn Học Exam
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-exam.html"><i class="fas fa-plus-circle me-1"></i> Tạo đề</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="take-exam.html"><i class="fas fa-pen-alt me-1"></i> Thi thử</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="manage-exam.html"><i class="fas fa-clipboard-list me-1"></i> Quản lý</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html"><i class="fas fa-sign-in-alt me-1"></i> Đăng nhập</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-pen-alt me-2"></i>Tham gia thi</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="examMethodTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="join-tab" data-bs-toggle="tab" data-bs-target="#join" type="button" role="tab">Tham gia đề thi</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">Thi thử với AI</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="examMethodTabsContent">
                            <!-- Join Exam Tab -->
                            <div class="tab-pane fade show active" id="join" role="tabpanel">
                                <div class="text-center my-4" id="joinExamForm">
                                    <div class="mb-4">
                                        <h5>Tham gia đề thi từ người khác</h5>
                                        <p class="text-muted">Nhập mã đề thi hoặc quét mã QR để bắt đầu làm bài</p>
                                    </div>
                                    
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="examCode" class="form-label">Mã đề thi</label>
                                                <input type="text" class="form-control" id="examCode" placeholder="Nhập mã đề thi (ví dụ: VAN-5X7D9)">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Hoặc quét mã QR</label>
                                                <button class="btn btn-outline-primary w-100" id="scanQRBtn">
                                                    <i class="fas fa-qrcode me-2"></i> Quét mã QR
                                                </button>
                                            </div>
                                            
                                            <div class="qr-scanner-container d-none" id="qrScanner">
                                                <video id="qr-video" playsinline></video>
                                                <div class="qr-overlay">
                                                    <div class="qr-overlay-box"></div>
                                                </div>
                                                <button class="btn btn-danger w-100 mt-2" id="stopScanBtn">
                                                    <i class="fas fa-stop me-2"></i> Dừng quét
                                                </button>
                                            </div>
                                            
                                            <button class="btn btn-primary w-100 mt-3" id="joinExamBtn">
                                                <i class="fas fa-sign-in-alt me-2"></i> Tham gia đề thi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-none" id="examPasswordForm">
                                    <div class="text-center mb-4">
                                        <h5>Đề thi yêu cầu mật khẩu</h5>
                                        <p class="text-muted">Vui lòng nhập mật khẩu để tiếp tục</p>
                                    </div>
                                    
                                    <div class="row justify-content-center">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="passwordInput" class="form-label">Mật khẩu đề thi</label>
                                                <input type="password" class="form-control" id="passwordInput" placeholder="Nhập mật khẩu">
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-secondary flex-grow-1" id="backToJoinBtn">
                                                    <i class="fas fa-arrow-left me-2"></i> Quay lại
                                                </button>
                                                <button class="btn btn-primary flex-grow-1" id="submitPasswordBtn">
                                                    <i class="fas fa-check me-2"></i> Xác nhận
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-none" id="studentInfoForm">
                                    <div class="text-center mb-4">
                                        <h5>Thông tin thí sinh</h5>
                                        <p class="text-muted">Vui lòng nhập thông tin của bạn trước khi bắt đầu làm bài</p>
                                    </div>
                                    
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="studentName" class="form-label">Họ và tên</label>
                                                <input type="text" class="form-control" id="studentName" placeholder="Nhập họ và tên của bạn">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="studentEmail" class="form-label">Email (tùy chọn)</label>
                                                <input type="email" class="form-control" id="studentEmail" placeholder="Nhập email để nhận kết quả">
                                            </div>
                                            
                                            <div class="d-flex justify-content-between">
                                                <button class="btn btn-outline-secondary" id="backToPasswordBtn">
                                                    <i class="fas fa-arrow-left me-2"></i> Quay lại
                                                </button>
                                                <button class="btn btn-primary" id="startExamBtn">
                                                    <i class="fas fa-play me-2"></i> Bắt đầu làm bài
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-none" id="examContainer">
                                    <div class="exam-info">
                                        <h4 class="exam-title" id="examTitleDisplay">Đề thi môn Ngữ Văn học kỳ I</h4>
                                        <div class="row mt-3">
                                            <div class="col-md-4">
                                                <div><i class="fas fa-clock me-2"></i> Thời gian: <span id="examDurationDisplay">60 phút</span></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div><i class="fas fa-book me-2"></i> Môn: <span id="examSubjectDisplay">Ngữ Văn</span></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div><i class="fas fa-user-graduate me-2"></i> Thí sinh: <span id="studentNameDisplay">Nguyễn Văn A</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <form id="examForm">
                                        <div id="questionsList">
                                            <!-- Questions will be loaded here -->
                                        </div>
                                        
                                        <div class="d-grid gap-2 mt-4">
                                            <button type="submit" class="btn btn-primary submit-btn">
                                                <i class="fas fa-paper-plane me-2"></i> Nộp bài
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div class="d-none" id="examResult">
                                    <div class="exam-result">
                                        <i class="fas fa-check-circle result-icon result-success"></i>
                                        <h3>Bài thi đã được nộp thành công!</h3>
                                        <div class="result-score">
                                            <span id="examScore">--</span>/<span id="totalScore">--</span>
                                        </div>
                                        <p>Kết quả chi tiết sẽ được gửi đến người tạo đề để chấm điểm.</p>
                                        
                                        <div class="mt-4">
                                            <button class="btn btn-outline-primary me-2" id="viewExamResultBtn">
                                                <i class="fas fa-eye me-2"></i> Xem lại bài làm
                                            </button>
                                            <button class="btn btn-primary" id="backToHomeBtn">
                                                <i class="fas fa-home me-2"></i> Về trang chủ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Exam Tab -->
                            <div class="tab-pane fade" id="ai" role="tabpanel">
                                <div id="aiExamForm">
                                    <div class="text-center mb-4">
                                        <h5>Thi thử với AI</h5>
                                        <p class="text-muted">AI sẽ tạo đề thi ngẫu nhiên và chấm điểm ngay cho bạn</p>
                                    </div>
                                    
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="aiStudentName" class="form-label">Họ và tên</label>
                                                <input type="text" class="form-control" id="aiStudentName" placeholder="Nhập họ và tên của bạn">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="aiExamTopic" class="form-label">Chủ đề thi</label>
                                                <select class="form-select" id="aiExamTopic">
                                                    <option value="random">Ngẫu nhiên</option>
                                                    <option value="van_hoc_trung_dai">Văn học trung đại</option>
                                                    <option value="van_hoc_hien_dai">Văn học hiện đại</option>
                                                    <option value="tho">Thơ</option>
                                                    <option value="truyen_ngan">Truyện ngắn</option>
                                                    <option value="tieu_thuyet">Tiểu thuyết</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="aiExamLevel" class="form-label">Độ khó</label>
                                                <select class="form-select" id="aiExamLevel">
                                                    <option value="easy">Dễ</option>
                                                    <option value="medium" selected>Trung bình</option>
                                                    <option value="hard">Khó</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="aiExamDuration" class="form-label">Thời gian làm bài (phút)</label>
                                                <input type="number" class="form-control" id="aiExamDuration" min="5" max="120" value="30">
                                            </div>
                                            
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-primary" id="startAIExamBtn">
                                                    <i class="fas fa-play me-2"></i> Bắt đầu thi thử
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-none" id="aiExamContainer">
                                    <div class="exam-info">
                                        <h4 class="exam-title">Đề thi thử với AI</h4>
                                        <div class="row mt-3">
                                            <div class="col-md-4">
                                                <div><i class="fas fa-clock me-2"></i> Thời gian: <span id="aiExamDurationDisplay">30 phút</span></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div><i class="fas fa-robot me-2"></i> Độ khó: <span id="aiExamLevelDisplay">Trung bình</span></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div><i class="fas fa-user-graduate me-2"></i> Thí sinh: <span id="aiStudentNameDisplay">Nguyễn Văn A</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <form id="aiExamForm">
                                        <div id="aiQuestionsList">
                                            <!-- AI Questions will be loaded here -->
                                        </div>
                                        
                                        <div class="d-grid gap-2 mt-4">
                                            <button type="submit" class="btn btn-primary submit-btn">
                                                <i class="fas fa-paper-plane me-2"></i> Nộp bài
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div class="d-none" id="aiExamResult">
                                    <div class="exam-result">
                                        <i class="fas fa-check-circle result-icon result-success"></i>
                                        <h3>Kết quả bài thi của bạn</h3>
                                        <div class="result-score">
                                            <span id="aiExamScore">8.5</span>/<span id="aiTotalScore">10</span>
                                        </div>
                                        <p id="aiExamFeedback">Bạn đã làm bài rất tốt!</p>
                                        
                                        <div class="result-feedback mt-4" id="aiDetailedFeedback">
                                            <!-- Detailed feedback will be loaded here -->
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button class="btn btn-outline-primary me-2" id="viewAIExamResultBtn">
                                                <i class="fas fa-eye me-2"></i> Xem lại bài làm
                                            </button>
                                            <button class="btn btn-primary" id="tryAnotherExamBtn">
                                                <i class="fas fa-redo me-2"></i> Làm đề khác
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ai-loading" id="aiExamLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>AI đang tạo đề thi cho bạn. Vui lòng chờ trong giây lát...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Container -->
    <div class="timer-container d-none" id="timer">
        <i class="fas fa-clock me-2"></i>
        <span id="timeDisplay">00:00:00</span>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container">
        <div class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successToastMessage">Thao tác thành công!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        
        <div class="toast align-items-center text-white bg-danger" role="alert" aria-live="assertive" aria-atomic="true" id="errorToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorToastMessage">Đã xảy ra lỗi!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
            authDomain: "literatureexamapp.firebaseapp.com",
            projectId: "literatureexamapp",
            storageBucket: "literatureexamapp.appspot.com",
            messagingSenderId: "829681704033",
            appId: "1:829681704033:web:f92a79de0c177b235b9e20"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Initialize Gemini AI
        const geminiConfig = {
            apiKey: 'AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM',
            model: 'gemini-2.5-flash-preview-05-20'
        };

        // DOM Elements
        const joinExamForm = document.getElementById('joinExamForm');
        const examPasswordForm = document.getElementById('examPasswordForm');
        const studentInfoForm = document.getElementById('studentInfoForm');
        const examContainer = document.getElementById('examContainer');
        const examResult = document.getElementById('examResult');
        const aiExamForm = document.getElementById('aiExamForm');
        const aiExamContainer = document.getElementById('aiExamContainer');
        const aiExamResult = document.getElementById('aiExamResult');
        const aiExamLoading = document.getElementById('aiExamLoading');
        
        // Timer elements
        const timer = document.getElementById('timer');
        const timeDisplay = document.getElementById('timeDisplay');
        
        // Toast elements
        const successToast = new bootstrap.Toast(document.getElementById('successToast'));
        const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
        
        // Current exam data
        let currentExam = null;
        let currentExamCode = '';
        let studentInfo = {};
        let examTimer = null;
        let timeLeft = 0;
        let examStartTime = null;
        
        // QR Scanner variables
        let qrScanner = null;
        let qrStream = null;
        
        // Show success toast
        function showSuccess(message) {
            document.getElementById('successToastMessage').textContent = message;
            successToast.show();
        }
        
        // Show error toast
        function showError(message) {
            document.getElementById('errorToastMessage').textContent = message;
            errorToast.show();
        }
        
        // Format time as HH:MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }
        
        // Start exam timer
        function startTimer(durationInMinutes) {
            timeLeft = durationInMinutes * 60;
            examStartTime = new Date();
            
            updateTimerDisplay();
            
            examTimer = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                }
            }, 1000);
        }
        
        // Update timer display
        function updateTimerDisplay() {
            timeDisplay.textContent = formatTime(timeLeft);
            
            // Change color when time is running out
            if (timeLeft <= 300) { // 5 minutes or less
                timer.style.backgroundColor = 'var(--danger-color)';
            }
        }
        
        // Stop exam timer
        function stopTimer() {
            if (examTimer) {
                clearInterval(examTimer);
                examTimer = null;
            }
        }
        
        // Load exam questions
        function loadExamQuestions(examData) {
            const questionsList = document.getElementById('questionsList');
            questionsList.innerHTML = '';
            
            examData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.innerHTML = `
                    <h5><span class="question-number">Câu ${index + 1}</span>. ${question.content}</h5>
                    <div class="question-points mb-3 text-muted">(${question.points} điểm)</div>
                    ${renderQuestionInput(question, index)}
                    ${question.hint ? `<div class="mt-3 text-muted"><i class="fas fa-lightbulb me-2"></i><strong>Gợi ý:</strong> ${question.hint}</div>` : ''}
                `;
                
                questionsList.appendChild(questionDiv);
            });
        }
        
        // Render appropriate input for question type
        function renderQuestionInput(question, index) {
            if (question.type === 'multiple_choice') {
                return `
                    <div class="question-options">
                        <div class="mb-2">
                            <input type="radio" id="q${index}_optionA" name="q${index}" value="A" class="d-none option-radio">
                            <label for="q${index}_optionA" class="option-label"><strong>A.</strong> ${question.options.A}</label>
                        </div>
                        <div class="mb-2">
                            <input type="radio" id="q${index}_optionB" name="q${index}" value="B" class="d-none option-radio">
                            <label for="q${index}_optionB" class="option-label"><strong>B.</strong> ${question.options.B}</label>
                        </div>
                        <div class="mb-2">
                            <input type="radio" id="q${index}_optionC" name="q${index}" value="C" class="d-none option-radio">
                            <label for="q${index}_optionC" class="option-label"><strong>C.</strong> ${question.options.C}</label>
                        </div>
                        <div class="mb-2">
                            <input type="radio" id="q${index}_optionD" name="q${index}" value="D" class="d-none option-radio">
                            <label for="q${index}_optionD" class="option-label"><strong>D.</strong> ${question.options.D}</label>
                        </div>
                    </div>
                `;
            } else if (question.type === 'true_false') {
                return `
                    <div class="question-options">
                        <div class="true-false-option">
                            <input type="radio" id="q${index}_true" name="q${index}" value="true" class="d-none option-radio">
                            <label for="q${index}_true" class="option-label"><i class="fas fa-check me-2"></i> Đúng</label>
                        </div>
                        <div class="true-false-option">
                            <input type="radio" id="q${index}_false" name="q${index}" value="false" class="d-none option-radio">
                            <label for="q${index}_false" class="option-label"><i class="fas fa-times me-2"></i> Sai</label>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="question-options">
                        <textarea class="text-answer" name="q${index}" rows="5" placeholder="Nhập câu trả lời của bạn..."></textarea>
                    </div>
                `;
            }
        }
        
        // Load AI exam questions
        function loadAIExamQuestions(questions) {
            const questionsList = document.getElementById('aiQuestionsList');
            questionsList.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.innerHTML = `
                    <h5><span class="question-number">Câu ${index + 1}</span>. ${question.content}</h5>
                    <div class="question-points mb-3 text-muted">(${question.points} điểm)</div>
                    ${renderQuestionInput(question, index)}
                    ${question.hint ? `<div class="mt-3 text-muted"><i class="fas fa-lightbulb me-2"></i><strong>Gợi ý:</strong> ${question.hint}</div>` : ''}
                `;
                
                questionsList.appendChild(questionDiv);
            });
        }
        
        // Submit exam answers
        function submitExam() {
            stopTimer();
            
            // Collect answers
            const formData = new FormData(document.getElementById('examForm'));
            const answers = {};
            
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }
            
            // Calculate time taken
            const endTime = new Date();
            const timeTaken = Math.floor((endTime - examStartTime) / 1000); // in seconds
            
            // Create exam result
            const examResultData = {
                examCode: currentExamCode,
                examTitle: currentExam.title,
                studentName: studentInfo.name,
                studentEmail: studentInfo.email || '',
                answers: answers,
                startTime: examStartTime,
                endTime: endTime,
                timeTaken: timeTaken,
                submittedAt: new Date(),
                status: 'submitted',
                graded: false
            };
            
            // Save to Firestore
            db.collection('examResults').add(examResultData)
                .then(function(docRef) {
                    // Show success message
                    document.getElementById('examScore').textContent = '--';
                    document.getElementById('totalScore').textContent = calculateTotalPoints(currentExam.questions);
                    
                    // Hide exam container, show result
                    examContainer.classList.add('d-none');
                    examResult.classList.remove('d-none');
                    timer.classList.add('d-none');
                    
                    showSuccess('Bài thi đã được nộp thành công!');
                })
                .catch(function(error) {
                    console.error('Error submitting exam: ', error);
                    showError('Lỗi khi nộp bài: ' + error.message);
                });
        }
        
        // Submit AI exam answers
        function submitAIExam() {
            stopTimer();
            
            // Collect answers
            const formData = new FormData(document.getElementById('aiExamForm'));
            const answers = {};
            
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }
            
            // Calculate score (simulated - in real app, use AI to grade)
            const totalPoints = calculateTotalPoints(currentExam.questions);
            const score = calculateAIScore(currentExam.questions, answers);
            
            // Generate feedback (simulated)
            const feedback = generateAIFeedback(currentExam.questions, answers);
            
            // Show result
            document.getElementById('aiExamScore').textContent = score.toFixed(1);
            document.getElementById('aiTotalScore').textContent = totalPoints;
            document.getElementById('aiExamFeedback').textContent = getGeneralFeedback(score / totalPoints * 10);
            document.getElementById('aiDetailedFeedback').innerHTML = feedback;
            
            // Hide exam container, show result
            aiExamContainer.classList.add('d-none');
            aiExamResult.classList.remove('d-none');
            timer.classList.add('d-none');
            
            showSuccess('AI đã chấm điểm xong bài thi của bạn!');
        }
        
        // Calculate total points for exam
        function calculateTotalPoints(questions) {
            return questions.reduce((total, q) => total + q.points, 0);
        }
        
        // Calculate AI exam score (simulated)
        function calculateAIScore(questions, answers) {
            let score = 0;
            
            questions.forEach((q, index) => {
                const answerKey = `q${index}`;
                const userAnswer = answers[answerKey];
                
                if (userAnswer) {
                    if (q.type === 'multiple_choice' || q.type === 'true_false') {
                        if (userAnswer === q.correctAnswer) {
                            score += q.points;
                        }
                    } else {
                        // For text answers, give partial credit
                        score += q.points * 0.8; // Simulate 80% correct for all text answers
                    }
                }
            });
            
            return score;
        }
        
        // Generate AI feedback (simulated)
        function generateAIFeedback(questions, answers) {
            let feedback = '<h5>Nhận xét chi tiết:</h5><ul class="list-group">';
            
            questions.forEach((q, index) => {
                const answerKey = `q${index}`;
                const userAnswer = answers[answerKey];
                let questionFeedback = '';
                
                if (q.type === 'multiple_choice' || q.type === 'true_false') {
                    if (userAnswer === q.correctAnswer) {
                        questionFeedback = `<li class="list-group-item list-group-item-success"><strong>Câu ${index + 1}:</strong> Đúng! ${q.explanation || ''}</li>`;
                    } else {
                        questionFeedback = `<li class="list-group-item list-group-item-danger"><strong>Câu ${index + 1}:</strong> Sai. Đáp án đúng là ${q.correctAnswer}. ${q.explanation || ''}</li>`;
                    }
                } else {
                    questionFeedback = `<li class="list-group-item"><strong>Câu ${index + 1}:</strong> Câu trả lời của bạn đã được ghi nhận. ${q.modelAnswer ? `<br><strong>Đáp án tham khảo:</strong> ${q.modelAnswer}` : ''}</li>`;
                }
                
                feedback += questionFeedback;
            });
            
            feedback += '</ul>';
            return feedback;
        }
        
        // Get general feedback based on score
        function getGeneralFeedback(scoreOutOf10) {
            if (scoreOutOf10 >= 9) {
                return "Xuất sắc! Bạn có kiến thức rất vững về văn học.";
            } else if (scoreOutOf10 >= 7) {
                return "Tốt! Bạn hiểu khá rõ về các tác phẩm văn học.";
            } else if (scoreOutOf10 >= 5) {
                return "Khá! Bạn cần ôn tập thêm một số tác phẩm.";
            } else {
                return "Cần cố gắng hơn! Bạn nên dành thời gian đọc lại các tác phẩm văn học.";
            }
        }
        
        // Generate AI exam (simulated)
        function generateAIExam(topic, level, duration) {
            // Show loading
            aiExamLoading.style.display = 'block';
            aiExamForm.classList.add('d-none');
            
            // Simulate API call to Gemini AI
            setTimeout(function() {
                // Generate mock exam based on parameters
                const exam = {
                    title: `Đề thi thử Văn học - ${getTopicName(topic)} - ${getLevelName(level)}`,
                    questions: generateMockQuestions(10, topic, level),
                    duration: duration
                };
                
                currentExam = exam;
                
                // Display exam info
                document.getElementById('aiExamDurationDisplay').textContent = `${duration} phút`;
                document.getElementById('aiExamLevelDisplay').textContent = getLevelName(level);
                document.getElementById('aiStudentNameDisplay').textContent = document.getElementById('aiStudentName').value;
                
                // Load questions
                loadAIExamQuestions(exam.questions);
                
                // Hide loading, show exam
                aiExamLoading.style.display = 'none';
                aiExamContainer.classList.remove('d-none');
                
                // Start timer
                startTimer(duration);
                timer.classList.remove('d-none');
            }, 2000);
        }
        
        // Generate mock questions for AI exam
        function generateMockQuestions(count, topic, level) {
            const mockQuestions = [];
            const literatureTopics = getTopicsForCategory(topic);
            
            for (let i = 0; i < count; i++) {
                const topicIndex = Math.floor(Math.random() * literatureTopics.length);
                const selectedTopic = literatureTopics[topicIndex];
                const type = getQuestionTypeForLevel(level, i);
                
                const question = {
                    type: type,
                    content: getQuestionContent(type, selectedTopic, level),
                    points: getPointsForLevel(level),
                    hint: i % 3 === 0 ? getHintForTopic(selectedTopic) : undefined
                };
                
                if (type === 'multiple_choice') {
                    question.options = {
                        A: getRandomOption(selectedTopic, 'A'),
                        B: getRandomOption(selectedTopic, 'B'),
                        C: getRandomOption(selectedTopic, 'C'),
                        D: getRandomOption(selectedTopic, 'D')
                    };
                    question.correctAnswer = ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)];
                    question.explanation = getExplanationForQuestion(selectedTopic);
                } else if (type === 'true_false') {
                    question.correctAnswer = Math.random() > 0.5 ? 'true' : 'false';
                    question.explanation = getExplanationForQuestion(selectedTopic);
                } else {
                    question.modelAnswer = getModelAnswer(selectedTopic);
                }
                
                mockQuestions.push(question);
            }
            
            return mockQuestions;
        }
        
        // Helper functions for AI exam generation
        function getTopicName(topic) {
            const topics = {
                'random': 'Tổng hợp',
                'van_hoc_trung_dai': 'Văn học trung đại',
                'van_hoc_hien_dai': 'Văn học hiện đại',
                'tho': 'Thơ',
                'truyen_ngan': 'Truyện ngắn',
                'tieu_thuyet': 'Tiểu thuyết'
            };
            return topics[topic] || 'Tổng hợp';
        }
        
        function getLevelName(level) {
            return level === 'easy' ? 'Dễ' : level === 'medium' ? 'Trung bình' : 'Khó';
        }
        
        function getTopicsForCategory(category) {
            const allTopics = [
                "Tác phẩm 'Vợ chồng A Phủ' của Tô Hoài",
                "Truyện ngắn 'Chiếc thuyền ngoài xa' của Nguyễn Minh Châu",
                "Bài thơ 'Sóng' của Xuân Quỳnh",
                "Tác phẩm 'Chí Phèo' của Nam Cao",
                "Truyện 'Hai đứa trẻ' của Thạch Lam",
                "Bài thơ 'Đây thôn Vĩ Dạ' của Hàn Mặc Tử",
                "Tác phẩm 'Rừng xà nu' của Nguyễn Trung Thành",
                "Truyện 'Vợ nhặt' của Kim Lân",
                "Bài thơ 'Việt Bắc' của Tố Hữu",
                "Tác phẩm 'Người lái đò sông Đà' của Nguyễn Tuân",
                "Truyện 'Lão Hạc' của Nam Cao",
                "Bài thơ 'Tây Tiến' của Quang Dũng",
                "Tác phẩm 'Hồn Trương Ba, da hàng thịt' của Lưu Quang Vũ",
                "Truyện 'Những đứa con trong gia đình' của Nguyễn Thi",
                "Bài thơ 'Đồng chí' của Chính Hữu"
            ];
            
            if (category === 'random') return allTopics;
            
            const categorized = {
                'van_hoc_trung_dai': [
                    "Truyện Kiều của Nguyễn Du",
                    "Chinh phụ ngâm của Đoàn Thị Điểm",
                    "Cung oán ngâm khúc của Nguyễn Gia Thiều",
                    "Thơ Hồ Xuân Hương",
                    "Thơ Nguyễn Khuyến"
                ],
                'van_hoc_hien_dai': allTopics.filter(t => !t.includes("Truyện Kiều") && !t.includes("Chinh phụ ngâm")),
                'tho': [
                    "Bài thơ 'Sóng' của Xuân Quỳnh",
                    "Bài thơ 'Đây thôn Vĩ Dạ' của Hàn Mặc Tử",
                    "Bài thơ 'Việt Bắc' của Tố Hữu",
                    "Bài thơ 'Tây Tiến' của Quang Dũng",
                    "Bài thơ 'Đồng chí' của Chính Hữu"
                ],
                'truyen_ngan': [
                    "Tác phẩm 'Vợ chồng A Phủ' của Tô Hoài",
                    "Truyện ngắn 'Chiếc thuyền ngoài xa' của Nguyễn Minh Châu",
                    "Tác phẩm 'Chí Phèo' của Nam Cao",
                    "Truyện 'Hai đứa trẻ' của Thạch Lam",
                    "Truyện 'Vợ nhặt' của Kim Lân"
                ],
                'tieu_thuyet': [
                    "Tiểu thuyết 'Số đỏ' của Vũ Trọng Phụng",
                    "Tiểu thuyết 'Bỉ vỏ' của Nguyên Hồng",
                    "Tiểu thuyết 'Đất rừng phương Nam' của Đoàn Giỏi",
                    "Tiểu thuyết 'Nỗi buồn chiến tranh' của Bảo Ninh"
                ]
            };
            
            return categorized[category] || allTopics;
        }
        
        function getQuestionTypeForLevel(level, index) {
            if (level === 'easy') {
                return index % 4 === 0 ? 'multiple_choice' : 
                       index % 4 === 1 ? 'true_false' : 
                       index % 4 === 2 ? 'short_answer' : 'multiple_choice';
            } else if (level === 'medium') {
                return index % 4 === 0 ? 'multiple_choice' : 
                       index % 4 === 1 ? 'true_false' : 
                       index % 4 === 2 ? 'short_answer' : 'essay';
            } else {
                return index % 3 === 0 ? 'essay' : 
                       index % 3 === 1 ? 'short_answer' : 'multiple_choice';
            }
        }
        
        function getPointsForLevel(level) {
            if (level === 'easy') return 1;
            if (level === 'medium') return Math.random() > 0.5 ? 1 : 1.5;
            return Math.random() > 0.5 ? 2 : 1.5;
        }
        
        function getQuestionContent(type, topic, level) {
            if (type === 'multiple_choice') {
                const questions = [
                    'Tác giả của ' + topic + ' là ai?',
                    'Nội dung chính của ' + topic + ' là gì?',
                    'Nhân vật chính trong ' + topic + ' là ai?',
                    'Bối cảnh của ' + topic + ' diễn ra ở đâu?',
                    'Giá trị nghệ thuật nổi bật của ' + topic + ' là gì?'
                ];
                return questions[Math.floor(Math.random() * questions.length)];
            } else if (type === 'true_false') {
                const statements = [
                    topic + ' được sáng tác trong thời kỳ kháng chiến chống Mỹ.',
                    'Nhân vật chính trong ' + topic + ' là người nông dân.',
                    topic + ' thuộc thể loại truyện ngắn.',
                    'Tác phẩm ' + topic + ' được viết theo bút pháp hiện thực.',
                    topic + ' phản ánh số phận người phụ nữ trong xã hội cũ.'
                ];
                return statements[Math.floor(Math.random() * statements.length)];
            } else {
                const prompts = [
                    'Phân tích nhân vật chính trong ' + topic + '.',
                    'Nêu cảm nhận của em về ' + topic + '.',
                    'Trình bày giá trị nghệ thuật của ' + topic + '.',
                    'Phân tích một đoạn văn/đoạn thơ tiêu biểu trong ' + topic + '.',
                    'Bình luận về chủ đề chính của ' + topic + '.',
                    'So sánh ' + topic + ' với một tác phẩm khác cùng thể loại.'
                ];
                return prompts[Math.floor(Math.random() * prompts.length)];
            }
        }
        
        function getRandomOption(topic, option) {
            const authors = ["Tô Hoài", "Nguyễn Minh Châu", "Xuân Quỳnh", "Nam Cao", "Thạch Lam", "Hàn Mặc Tử", 
                           "Nguyễn Trung Thành", "Kim Lân", "Tố Hữu", "Nguyễn Tuân", "Nguyễn Du", "Vũ Trọng Phụng"];
            const places = ["Tây Bắc", "Huế", "Hà Nội", "Nông thôn Việt Nam", "Miền núi", "Đồng bằng", "Thành phố", "Làng quê"];
            const characters = ["Mị", "A Phủ", "Người đàn bà hàng chài", "Phùng", "Chí Phèo", "Thị Nở", "Liên", "Anh", "Người lái đò"];
            const themes = ["Tình yêu", "Chiến tranh", "Số phận con người", "Thiên nhiên", "Xã hội phong kiến", "Cách mạng"];
            
            const randomOption = [
                authors[Math.floor(Math.random() * authors.length)],
                places[Math.floor(Math.random() * places.length)],
                characters[Math.floor(Math.random() * characters.length)],
                themes[Math.floor(Math.random() * themes.length)],
                "Tất cả các đáp án trên"
            ][Math.floor(Math.random() * 5)];
            
            return randomOption;
        }
        
        function getModelAnswer(topic) {
            const answers = [
                topic + ' là một tác phẩm xuất sắc trong nền văn học Việt Nam hiện đại. Tác phẩm này đã khắc họa thành công...',
                'Nhân vật chính trong ' + topic + ' là hình tượng tiêu biểu cho... Tác giả đã sử dụng nghệ thuật miêu tả tâm lý nhân vật rất tinh tế...',
                'Giá trị nhân đạo của ' + topic + ' thể hiện qua... Tác phẩm đã lên án những bất công trong xã hội và đồng cảm với số phận...',
                'Nghệ thuật kể chuyện trong ' + topic + ' rất độc đáo với... Tác giả sử dụng ngôn ngữ giản dị nhưng giàu hình ảnh và cảm xúc...',
                'Bằng những hình ảnh giàu sức gợi, tác giả đã... trong ' + topic + '. Tác phẩm mang đậm tính nhân văn và giá trị nghệ thuật cao...'
            ];
            
            return answers[Math.floor(Math.random() * answers.length)];
        }
        
        function getHintForTopic(topic) {
            const hints = [
                'Xem lại phần tóm tắt tác phẩm ' + topic,
                'Chú ý đến hoàn cảnh sáng tác của ' + topic,
                'Phân tích các nhân vật chính trong ' + topic,
                'Tập trung vào giá trị nội dung và nghệ thuật của ' + topic,
                'Xem lại các đoạn trích quan trọng trong ' + topic
            ];
            
            return hints[Math.floor(Math.random() * hints.length)];
        }
        
        function getExplanationForQuestion(topic) {
            const explanations = [
                'Câu hỏi liên quan đến kiến thức cơ bản về ' + topic,
                'Để trả lời câu hỏi này, cần nắm vững nội dung chính của ' + topic,
                'Thông tin này được đề cập rõ trong tác phẩm ' + topic,
                'Tác giả đã nhấn mạnh điểm này nhiều lần trong ' + topic,
                'Đây là một trong những chủ đề chính của ' + topic
            ];
            
            return explanations[Math.floor(Math.random() * explanations.length)];
        }
        
        // Initialize QR code scanner
        function initQRScanner() {
            const video = document.getElementById('qr-video');
            const qrScanner = document.getElementById('qrScanner');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    qrStream = stream;
                    video.srcObject = stream;
                    video.play();
                    
                    // Show scanner
                    qrScanner.classList.remove('d-none');
                    
                    // Start scanning
                    scanQRCode(video);
                })
                .catch(function(err) {
                    console.error("Error accessing camera: ", err);
                    showError('Không thể truy cập camera: ' + err.message);
                });
        }
        
        // Scan QR code from video stream
        function scanQRCode(video) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        // Found QR code
                        stopQRScanner();
                        document.getElementById('examCode').value = code.data;
                        showSuccess('Đã quét mã QR thành công!');
                    }
                }
                
                requestAnimationFrame(tick);
            }
            
            tick();
        }
        
        // Stop QR scanner
        function stopQRScanner() {
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
            
            document.getElementById('qrScanner').classList.add('d-none');
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL for exam code
            const urlParams = new URLSearchParams(window.location.search);
            const examCode = urlParams.get('code');
            
            if (examCode) {
                document.getElementById('examCode').value = examCode;
                document.getElementById('joinExamBtn').click();
            }
            
            // Join exam button
            document.getElementById('joinExamBtn').addEventListener('click', function() {
                currentExamCode = document.getElementById('examCode').value.trim();
                
                if (!currentExamCode) {
                    showError('Vui lòng nhập mã đề thi');
                    return;
                }
                
                // Check if exam exists
                db.collection('exams').doc(currentExamCode).get()
                    .then(function(doc) {
                        if (doc.exists) {
                            currentExam = doc.data();
                            
                            // Check if exam requires password
                            if (currentExam.security.password) {
                                joinExamForm.classList.add('d-none');
                                examPasswordForm.classList.remove('d-none');
                            } else {
                                joinExamForm.classList.add('d-none');
                                studentInfoForm.classList.remove('d-none');
                            }
                        } else {
                            showError('Mã đề thi không tồn tại');
                        }
                    })
                    .catch(function(error) {
                        console.error('Error getting exam: ', error);
                        showError('Lỗi khi tải đề thi: ' + error.message);
                    });
            });
            
            // Submit password button
            document.getElementById('submitPasswordBtn').addEventListener('click', function() {
                const password = document.getElementById('passwordInput').value;
                
                if (password === currentExam.security.password) {
                    examPasswordForm.classList.add('d-none');
                    studentInfoForm.classList.remove('d-none');
                } else {
                    showError('Mật khẩu không đúng');
                }
            });
            
            // Back to join form from password form
            document.getElementById('backToJoinBtn').addEventListener('click', function() {
                examPasswordForm.classList.add('d-none');
                joinExamForm.classList.remove('d-none');
            });
            
            // Back to password form from student info
            document.getElementById('backToPasswordBtn').addEventListener('click', function() {
                studentInfoForm.classList.add('d-none');
                
                if (currentExam.security.password) {
                    examPasswordForm.classList.remove('d-none');
                } else {
                    joinExamForm.classList.remove('d-none');
                }
            });
            
            // Start exam button
            document.getElementById('startExamBtn').addEventListener('click', function() {
                const name = document.getElementById('studentName').value.trim();
                
                if (!name) {
                    showError('Vui lòng nhập họ tên');
                    return;
                }
                
                studentInfo = {
                    name: name,
                    email: document.getElementById('studentEmail').value.trim()
                };
                
                // Load exam
                document.getElementById('examTitleDisplay').textContent = currentExam.title;
                document.getElementById('examDurationDisplay').textContent = currentExam.duration + ' phút';
                document.getElementById('examSubjectDisplay').textContent = getSubjectName(currentExam.subject);
                document.getElementById('studentNameDisplay').textContent = studentInfo.name;
                
                loadExamQuestions(currentExam);
                
                // Hide student info, show exam
                studentInfoForm.classList.add('d-none');
                examContainer.classList.remove('d-none');
                
                // Start timer
                startTimer(currentExam.duration);
                timer.classList.remove('d-none');
            });
            
            // Submit exam form
            document.getElementById('examForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitExam();
            });
            
            // Submit AI exam form
            document.getElementById('aiExamForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitAIExam();
            });
            
            // Back to home button
            document.getElementById('backToHomeBtn').addEventListener('click', function() {
                window.location.href = 'index.html';
            });
            
            // View exam result button
            document.getElementById('viewExamResultBtn').addEventListener('click', function() {
                // In a real app, this would show the exam with answers
                showSuccess('Chức năng xem lại bài làm đang được phát triển');
            });
            
            // View AI exam result button
            document.getElementById('viewAIExamResultBtn').addEventListener('click', function() {
                // In a real app, this would show the exam with answers
                showSuccess('Chức năng xem lại bài làm đang được phát triển');
            });
            
            // Try another exam button
            document.getElementById('tryAnotherExamBtn').addEventListener('click', function() {
                aiExamResult.classList.add('d-none');
                aiExamForm.classList.remove('d-none');
            });
            
            // Start AI exam button
            document.getElementById('startAIExamBtn').addEventListener('click', function() {
                const name = document.getElementById('aiStudentName').value.trim();
                
                if (!name) {
                    showError('Vui lòng nhập họ tên');
                    return;
                }
                
                const topic = document.getElementById('aiExamTopic').value;
                const level = document.getElementById('aiExamLevel').value;
                const duration = parseInt(document.getElementById('aiExamDuration').value);
                
                if (isNaN(duration) {
                    showError('Thời gian làm bài phải là số');
                    return;
                }
                
                generateAIExam(topic, level, duration);
            });
            
            // Scan QR button
            document.getElementById('scanQRBtn').addEventListener('click', function() {
                initQRScanner();
            });
            
            // Stop scan button
            document.getElementById('stopScanBtn').addEventListener('click', function() {
                stopQRScanner();
            });
        });
        
        // Helper function to get subject name
        function getSubjectName(subjectCode) {
            const subjects = {
                'ngu_van': 'Ngữ Văn',
                'van_hoc': 'Văn học',
                'tieng_viet': 'Tiếng Việt'
            };
            
            return subjects[subjectCode] || subjectCode;
        }
    </script>
</body>
</html>
