<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý bài thi Văn học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #e6f2ff;
            --accent-color: #3b7ddd;
            --text-color: #333;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: #f5f7fa;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 500;
        }
        
        .exam-item {
            border-left: 4px solid var(--primary-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            transition: transform 0.2s;
        }
        
        .exam-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .exam-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .exam-code {
            font-family: monospace;
            background-color: var(--light-color);
            padding: 2px 5px;
            border-radius: 3px;
            color: var(--text-color);
        }
        
        .badge-primary {
            background-color: var(--primary-color);
        }
        
        .badge-success {
            background-color: var(--success-color);
        }
        
        .badge-warning {
            background-color: var(--warning-color);
        }
        
        .badge-danger {
            background-color: var(--danger-color);
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
            border: 1px solid var(--border-color);
            border-top: none;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .attempt-item {
            border-left: 3px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            transition: all 0.2s;
        }
        
        .attempt-item:hover {
            border-left-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        .attempt-item.graded {
            border-left-color: var(--success-color);
        }
        
        .attempt-item.not-graded {
            border-left-color: var(--warning-color);
        }
        
        .grading-form {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .question-review {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .question-review:last-child {
            border-bottom: none;
        }
        
        .correct-answer {
            color: var(--success-color);
            font-weight: 500;
        }
        
        .student-answer.correct {
            color: var(--success-color);
        }
        
        .student-answer.incorrect {
            color: var(--danger-color);
        }
        
        .ai-feedback {
            background-color: #f8f9fa;
            border-left: 3px solid var(--primary-color);
            padding: 10px;
            margin-top: 10px;
            border-radius: 0 5px 5px 0;
        }
        
        .ai-feedback .feedback-label {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 30px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--border-color);
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .pagination .page-link {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>Văn Học Exam
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-exam.html"><i class="fas fa-plus-circle me-1"></i> Tạo đề</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="take-exam.html"><i class="fas fa-pen-alt me-1"></i> Thi thử</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="manage-exam.html"><i class="fas fa-clipboard-list me-1"></i> Quản lý</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html"><i class="fas fa-sign-in-alt me-1"></i> Đăng nhập</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Quản lý bài thi</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="manageTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="exams-tab" data-bs-toggle="tab" data-bs-target="#exams" type="button" role="tab">Đề thi của bạn</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="attempts-tab" data-bs-toggle="tab" data-bs-target="#attempts" type="button" role="tab">Bài thi của bạn</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="manageTabsContent">
                            <!-- Exams Tab -->
                            <div class="tab-pane fade show active" id="exams" role="tabpanel">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="examSearch" placeholder="Tìm kiếm đề thi...">
                                </div>
                                
                                <div id="examsList">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <nav aria-label="Exam pagination">
                                    <ul class="pagination justify-content-center" id="examsPagination">
                                        <!-- Pagination will be added here -->
                                    </ul>
                                </nav>
                            </div>
                            
                            <!-- Attempts Tab -->
                            <div class="tab-pane fade" id="attempts" role="tabpanel">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="attemptSearch" placeholder="Tìm kiếm bài thi...">
                                </div>
                                
                                <div id="attemptsList">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <nav aria-label="Attempt pagination">
                                    <ul class="pagination justify-content-center" id="attemptsPagination">
                                        <!-- Pagination will be added here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Exam Details Modal -->
    <div class="modal fade" id="examDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Chi tiết đề thi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h4 id="modalExamTitle">Đề thi học kỳ I môn Ngữ Văn 12</h4>
                        <div class="d-flex gap-3 mb-2">
                            <span class="badge bg-primary"><i class="fas fa-clock me-1"></i> <span id="modalExamDuration">60 phút</span></span>
                            <span class="badge bg-secondary"><i class="fas fa-book me-1"></i> <span id="modalExamSubject">Ngữ Văn</span></span>
                            <span class="badge bg-info"><i class="fas fa-graduation-cap me-1"></i> Lớp <span id="modalExamGrade">12</span></span>
                        </div>
                        <p id="modalExamDescription">Mô tả đề thi sẽ hiển thị ở đây</p>
                    </div>
                    
                    <div class="mb-3">
                        <h5><i class="fas fa-link me-2"></i>Liên kết chia sẻ</h5>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="modalExamLink" readonly>
                            <button class="btn btn-outline-secondary" id="copyExamLinkBtn">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="fab fa-facebook-f me-1"></i> Facebook
                            </button>
                            <button class="btn btn-sm btn-outline-info">
                                <i class="fab fa-twitter me-1"></i> Twitter
                            </button>
                            <button class="btn btn-sm btn-outline-success">
                                <i class="fab fa-whatsapp me-1"></i> WhatsApp
                            </button>
                            <button class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-envelope me-1"></i> Email
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5><i class="fas fa-qrcode me-2"></i>Mã QR</h5>
                        <div class="text-center">
                            <canvas id="examQRCode" width="200" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <h5><i class="fas fa-shield-alt me-2"></i>Cài đặt bảo mật</h5>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Chống sao chép/dán
                                <span class="badge bg-primary" id="modalExamCopyPaste">Bật</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Chống chuyển tab
                                <span class="badge bg-primary" id="modalExamTabSwitch">Bật</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Yêu cầu toàn màn hình
                                <span class="badge bg-secondary" id="modalExamFullscreen">Tắt</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Mật khẩu bảo vệ
                                <span class="badge bg-secondary" id="modalExamPassword">Không</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" id="deleteExamBtn">
                        <i class="fas fa-trash me-1"></i> Xóa đề thi
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Attempt Details Modal -->
    <div class="modal fade" id="attemptDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Chi tiết bài thi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h4 id="modalAttemptExamTitle">Đề thi học kỳ I môn Ngữ Văn 12</h4>
                        <div class="d-flex gap-3 mb-2">
                            <span class="badge bg-primary"><i class="fas fa-user me-1"></i> <span id="modalAttemptStudent">Nguyễn Văn A</span></span>
                            <span class="badge bg-secondary"><i class="fas fa-calendar me-1"></i> <span id="modalAttemptDate">01/01/2023</span></span>
                            <span class="badge bg-success"><i class="fas fa-star me-1"></i> <span id="modalAttemptScore">8.5/10</span></span>
                        </div>
                    </div>
                    
                    <div id="attemptQuestionsReview">
                        <!-- Questions review will be loaded here -->
                    </div>
                    
                    <div class="grading-form" id="gradingForm">
                        <h5><i class="fas fa-check-circle me-2"></i>Chấm điểm</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="attemptScoreInput" class="form-label">Điểm số</label>
                                <input type="number" class="form-control" id="attemptScoreInput" min="0" max="10" step="0.1" placeholder="Nhập điểm từ 0 đến 10">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="attemptFeedbackInput" class="form-label">Nhận xét (tùy chọn)</label>
                                <textarea class="form-control" id="attemptFeedbackInput" rows="1" placeholder="Nhập nhận xét cho bài thi"></textarea>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" id="gradeWithAIBtn">
                                <i class="fas fa-robot me-1"></i> Chấm bằng AI
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="gradeWithAIAssistBtn">
                                <i class="fas fa-magic me-1"></i> AI hỗ trợ chấm
                            </button>
                            <button type="button" class="btn btn-success ms-auto" id="saveGradeBtn">
                                <i class="fas fa-save me-1"></i> Lưu điểm
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Grading Loading Modal -->
    <div class="modal fade" id="aiGradingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-robot me-2"></i>AI đang chấm điểm</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="aiGradingMessage">AI đang phân tích và chấm điểm bài thi. Vui lòng chờ trong giây lát...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container">
        <div class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successToastMessage">Thao tác thành công!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        
        <div class="toast align-items-center text-white bg-danger" role="alert" aria-live="assertive" aria-atomic="true" id="errorToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorToastMessage">Đã xảy ra lỗi!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD16Qh_b09HK2YPVslMkefDGhBSlkLqCLc",
            authDomain: "literatureexamapp.firebaseapp.com",
            projectId: "literatureexamapp",
            storageBucket: "literatureexamapp.appspot.com",
            messagingSenderId: "829681704033",
            appId: "1:829681704033:web:f92a79de0c177b235b9e20"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Initialize Gemini AI
        const geminiConfig = {
            apiKey: 'AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM',
            model: 'gemini-2.5-flash-preview-05-20'
        };

        // DOM Elements
        const examsTab = document.getElementById('exams-tab');
        const attemptsTab = document.getElementById('attempts-tab');
        const examsContent = document.getElementById('exams');
        const attemptsContent = document.getElementById('attempts');
        
        // Toast elements
        const successToast = new bootstrap.Toast(document.getElementById('successToast'));
        const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
        
        // Modal elements
        const examDetailsModal = new bootstrap.Modal(document.getElementById('examDetailsModal'));
        const attemptDetailsModal = new bootstrap.Modal(document.getElementById('attemptDetailsModal'));
        const aiGradingModal = new bootstrap.Modal(document.getElementById('aiGradingModal'));
        
        // Current user data
        let currentUser = null;
        let currentExamDetails = null;
        let currentAttemptDetails = null;
        
        // Pagination
        const examsPerPage = 5;
        const attemptsPerPage = 5;
        let currentExamsPage = 1;
        let currentAttemptsPage = 1;
        let totalExams = 0;
        let totalAttempts = 0;
        
        // Show success toast
        function showSuccess(message) {
            document.getElementById('successToastMessage').textContent = message;
            successToast.show();
        }
        
        // Show error toast
        function showError(message) {
            document.getElementById('errorToastMessage').textContent = message;
            errorToast.show();
        }
        
        // Format date
        function formatDate(date) {
            if (!date) return '';
            
            const d = date.toDate();
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
        }
        
        // Format date with time
        function formatDateTime(date) {
            if (!date) return '';
            
            const d = date.toDate();
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // Get subject name
        function getSubjectName(subject) {
            switch (subject) {
                case 'ngu_van': return 'Ngữ Văn';
                case 'van_hoc': return 'Văn học';
                case 'tieng_viet': return 'Tiếng Việt';
                default: return subject;
            }
        }
        
        // Load user's exams
        function loadUserExams(page = 1, searchQuery = '') {
            if (!currentUser) return;
            
            currentExamsPage = page;
            const examsList = document.getElementById('examsList');
            examsList.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            let query = db.collection('exams')
                .where('createdBy', '==', currentUser.uid)
                .orderBy('createdAt', 'desc');
            
            if (searchQuery) {
                query = query.where('title', '>=', searchQuery)
                            .where('title', '<=', searchQuery + '\uf8ff');
            }
            
            query.get()
                .then(snapshot => {
                    totalExams = snapshot.size;
                    const totalPages = Math.ceil(totalExams / examsPerPage);
                    
                    // Reset if page is out of bounds
                    if (page > totalPages && totalPages > 0) {
                        loadUserExams(totalPages, searchQuery);
                        return;
                    }
                    
                    if (snapshot.empty) {
                        examsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-book-open"></i>
                                <h5>Không có đề thi nào</h5>
                                <p>Bạn chưa tạo đề thi nào. Hãy tạo đề thi mới để bắt đầu.</p>
                                <a href="create-exam.html" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i> Tạo đề thi mới
                                </a>
                            </div>
                        `;
                        document.getElementById('examsPagination').innerHTML = '';
                        return;
                    }
                    
                    examsList.innerHTML = '';
                    
                    // Calculate start and end index for pagination
                    const startIndex = (page - 1) * examsPerPage;
                    const endIndex = Math.min(startIndex + examsPerPage, totalExams);
                    
                    let count = 0;
                    snapshot.forEach(doc => {
                        if (count >= startIndex && count < endIndex) {
                            const exam = doc.data();
                            renderExamItem(exam, doc.id);
                        }
                        count++;
                    });
                    
                    // Render pagination
                    renderPagination('examsPagination', totalPages, page, 'loadUserExams', searchQuery);
                })
                .catch(error => {
                    console.error('Error loading exams:', error);
                    examsList.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Đã xảy ra lỗi khi tải danh sách đề thi
                        </div>
                    `;
                });
        }
        
        // Render exam item
        function renderExamItem(exam, examId) {
            const examsList = document.getElementById('examsList');
            if (!examsList) return;
            
            const examItem = document.createElement('div');
            examItem.className = 'exam-item';
            examItem.dataset.id = examId;
            
            const createdAt = exam.createdAt ? formatDate(exam.createdAt) : 'Không rõ';
            const participantCount = exam.participants ? Object.keys(exam.participants).length : 0;
            const gradedCount = exam.gradedParticipants ? Object.keys(exam.gradedParticipants).length : 0;
            
            examItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="exam-title">${exam.title || 'Đề thi không có tiêu đề'}</h5>
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-light text-dark"><i class="fas fa-code me-1"></i> <span class="exam-code">${examId}</span></span>
                            <span class="badge bg-light text-dark"><i class="fas fa-clock me-1"></i> ${exam.duration || 60} phút</span>
                            <span class="badge bg-light text-dark"><i class="fas fa-graduation-cap me-1"></i> Lớp ${exam.grade === 'other' ? 'Khác' : exam.grade || '12'}</span>
                        </div>
                        <p class="text-muted mb-1"><small><i class="fas fa-calendar me-1"></i> Tạo ngày ${createdAt}</small></p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary mb-1"><i class="fas fa-users me-1"></i> ${participantCount} thí sinh</span>
                        <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> ${gradedCount} đã chấm</span>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary view-exam-btn">
                        <i class="fas fa-eye me-1"></i> Xem
                    </button>
                    <button class="btn btn-sm btn-outline-secondary view-participants-btn">
                        <i class="fas fa-users me-1"></i> Danh sách
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-exam-btn ms-auto">
                        <i class="fas fa-trash me-1"></i> Xóa
                    </button>
                </div>
            `;
            
            examsList.appendChild(examItem);
            
            // Add event listeners
            examItem.querySelector('.view-exam-btn').addEventListener('click', () => showExamDetails(exam, examId));
            examItem.querySelector('.view-participants-btn').addEventListener('click', () => showExamParticipants(examId));
            examItem.querySelector('.delete-exam-btn').addEventListener('click', () => confirmDeleteExam(examId, exam.title));
        }
        
        // Render pagination
        function renderPagination(paginationId, totalPages, currentPage, callbackFunction, searchQuery = '') {
            const pagination = document.getElementById(paginationId);
            if (!pagination) return;
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    window[callbackFunction](currentPage - 1, searchQuery);
                }
            });
            pagination.appendChild(prevLi);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#">1</a>`;
                firstLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    window[callbackFunction](1, searchQuery);
                });
                pagination.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    window[callbackFunction](i, searchQuery);
                });
                pagination.appendChild(pageLi);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                lastLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    window[callbackFunction](totalPages, searchQuery);
                });
                pagination.appendChild(lastLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    window[callbackFunction](currentPage + 1, searchQuery);
                }
            });
            pagination.appendChild(nextLi);
        }
        
        // Show exam details modal
        function showExamDetails(exam, examId) {
            currentExamDetails = { ...exam, id: examId };
            
            // Set exam info
            document.getElementById('modalExamTitle').textContent = exam.title || 'Đề thi không có tiêu đề';
            document.getElementById('modalExamDuration').textContent = `${exam.duration || 60} phút`;
            document.getElementById('modalExamSubject').textContent = getSubjectName(exam.subject);
            document.getElementById('modalExamGrade').textContent = exam.grade === 'other' ? 'Khác' : exam.grade || '12';
            document.getElementById('modalExamDescription').textContent = exam.description || 'Không có mô tả';
            
            // Set security settings
            if (exam.security) {
                document.getElementById('modalExamCopyPaste').textContent = exam.security.preventCopyPaste ? 'Bật' : 'Tắt';
                document.getElementById('modalExamCopyPaste').className = `badge ${exam.security.preventCopyPaste ? 'bg-primary' : 'bg-secondary'}`;
                
                document.getElementById('modalExamTabSwitch').textContent = exam.security.preventTabSwitch ? 'Bật' : 'Tắt';
                document.getElementById('modalExamTabSwitch').className = `badge ${exam.security.preventTabSwitch ? 'bg-primary' : 'bg-secondary'}`;
                
                document.getElementById('modalExamFullscreen').textContent = exam.security.enableFullscreen ? 'Bật' : 'Tắt';
                document.getElementById('modalExamFullscreen').className = `badge ${exam.security.enableFullscreen ? 'bg-primary' : 'bg-secondary'}`;
                
                document.getElementById('modalExamPassword').textContent = exam.security.password ? 'Có' : 'Không';
                document.getElementById('modalExamPassword').className = `badge ${exam.security.password ? 'bg-primary' : 'bg-secondary'}`;
            }
            
            // Generate share link and QR code
            const examLink = `https://${window.location.hostname}/take-exam.html?code=${examId}`;
            document.getElementById('modalExamLink').value = examLink;
            
            // Clear previous QR code
            const qrCodeContainer = document.getElementById('examQRCode');
            qrCodeContainer.innerHTML = '';
            
            // Generate new QR code
            new QRCode(qrCodeContainer, {
                text: examLink,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Set up copy link button
            document.getElementById('copyExamLinkBtn').onclick = function() {
                const examLinkInput = document.getElementById('modalExamLink');
                examLinkInput.select();
                document.execCommand('copy');
                showSuccess('Đã sao chép liên kết vào clipboard');
            };
            
            // Set up delete exam button
            document.getElementById('deleteExamBtn').onclick = function() {
                confirmDeleteExam(examId, exam.title);
            };
            
            // Show modal
            examDetailsModal.show();
        }
        
        // Confirm delete exam
        function confirmDeleteExam(examId, examTitle) {
            if (confirm(`Bạn có chắc muốn xóa đề thi "${examTitle || examId}"? Tất cả bài làm liên quan cũng sẽ bị xóa.`)) {
                deleteExam(examId);
            }
        }
        
        // Delete exam
        function deleteExam(examId) {
            // First delete all attempts for this exam
            db.collection('examAttempts').where('examCode', '==', examId).get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    // Then delete the exam itself
                    return db.collection('exams').doc(examId).delete();
                })
                .then(() => {
                    showSuccess('Đề thi đã được xóa thành công');
                    examDetailsModal.hide();
                    loadUserExams(currentExamsPage);
                })
                .catch(error => {
                    console.error('Error deleting exam:', error);
                    showError('Lỗi khi xóa đề thi: ' + error.message);
                });
        }
        
        // Show exam participants
        function showExamParticipants(examId) {
            // Switch to attempts tab and filter by this exam
            attemptsTab.click();
            document.getElementById('attemptSearch').value = examId;
            loadUserAttempts(1, examId);
        }
        
        // Load user's exam attempts
        function loadUserAttempts(page = 1, searchQuery = '') {
            if (!currentUser) return;
            
            currentAttemptsPage = page;
            const attemptsList = document.getElementById('attemptsList');
            attemptsList.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            let query = db.collection('examAttempts')
                .where('examCode', '!=', '') // Ensure we're not getting AI attempts
                .orderBy('submittedAt', 'desc');
            
            // Check if we're filtering by exam code
            if (searchQuery && searchQuery.length > 0) {
                query = query.where('examCode', '==', searchQuery);
            } else {
                // Otherwise, get attempts for exams created by this user
                query = query.where('examCode', 'in', []); // This is a placeholder
                
                // First get all exams created by this user
                db.collection('exams').where('createdBy', '==', currentUser.uid).get()
                    .then(examSnapshot => {
                        const examCodes = [];
                        examSnapshot.forEach(doc => {
                            examCodes.push(doc.id);
                        });
                        
                        if (examCodes.length === 0) {
                            attemptsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-file-alt"></i>
                                    <h5>Không có bài thi nào</h5>
                                    <p>Chưa có thí sinh nào tham gia các đề thi của bạn.</p>
                                </div>
                            `;
                            document.getElementById('attemptsPagination').innerHTML = '';
                            return;
                        }
                        
                        // Now query attempts for these exams
                        return db.collection('examAttempts')
                            .where('examCode', 'in', examCodes)
                            .orderBy('submittedAt', 'desc')
                            .get();
                    })
                    .then(snapshot => {
                        if (!snapshot) return;
                        
                        totalAttempts = snapshot.size;
                        const totalPages = Math.ceil(totalAttempts / attemptsPerPage);
                        
                        // Reset if page is out of bounds
                        if (page > totalPages && totalPages > 0) {
                            loadUserAttempts(totalPages, searchQuery);
                            return;
                        }
                        
                        if (snapshot.empty) {
                            attemptsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-file-alt"></i>
                                    <h5>Không có bài thi nào</h5>
                                    <p>Chưa có thí sinh nào tham gia các đề thi của bạn.</p>
                                </div>
                            `;
                            document.getElementById('attemptsPagination').innerHTML = '';
                            return;
                        }
                        
                        attemptsList.innerHTML = '';
                        
                        // Calculate start and end index for pagination
                        const startIndex = (page - 1) * attemptsPerPage;
                        const endIndex = Math.min(startIndex + attemptsPerPage, totalAttempts);
                        
                        let count = 0;
                        snapshot.forEach(doc => {
                            if (count >= startIndex && count < endIndex) {
                                const attempt = doc.data();
                                renderAttemptItem(attempt, doc.id);
                            }
                            count++;
                        });
                        
                        // Render pagination
                        renderPagination('attemptsPagination', totalPages, page, 'loadUserAttempts', searchQuery);
                    })
                    .catch(error => {
                        console.error('Error loading attempts:', error);
                        attemptsList.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>Đã xảy ra lỗi khi tải danh sách bài thi
                            </div>
                        `;
                    });
                
                return;
            }
            
            // If we're filtering by exam code, just execute the query
            query.get()
                .then(snapshot => {
                    totalAttempts = snapshot.size;
                    const totalPages = Math.ceil(totalAttempts / attemptsPerPage);
                    
                    // Reset if page is out of bounds
                    if (page > totalPages && totalPages > 0) {
                        loadUserAttempts(totalPages, searchQuery);
                        return;
                    }
                    
                    if (snapshot.empty) {
                        attemptsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <h5>Không có bài thi nào</h5>
                                <p>Chưa có thí sinh nào tham gia đề thi này.</p>
                            </div>
                        `;
                        document.getElementById('attemptsPagination').innerHTML = '';
                        return;
                    }
                    
                    attemptsList.innerHTML = '';
                    
                    // Calculate start and end index for pagination
                    const startIndex = (page - 1) * attemptsPerPage;
                    const endIndex = Math.min(startIndex + attemptsPerPage, totalAttempts);
                    
                    let count = 0;
                    snapshot.forEach(doc => {
                        if (count >= startIndex && count < endIndex) {
                            const attempt = doc.data();
                            renderAttemptItem(attempt, doc.id);
                        }
                        count++;
                    });
                    
                    // Render pagination
                    renderPagination('attemptsPagination', totalPages, page, 'loadUserAttempts', searchQuery);
                })
                .catch(error => {
                    console.error('Error loading attempts:', error);
                    attemptsList.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Đã xảy ra lỗi khi tải danh sách bài thi
                        </div>
                    `;
                });
        }
        
        // Render attempt item
        function renderAttemptItem(attempt, attemptId) {
            const attemptsList = document.getElementById('attemptsList');
            if (!attemptsList) return;
            
            const attemptItem = document.createElement('div');
            attemptItem.className = `attempt-item ${attempt.graded ? 'graded' : 'not-graded'}`;
            attemptItem.dataset.id = attemptId;
            
            const submittedAt = attempt.submittedAt ? formatDateTime(attempt.submittedAt) : 'Không rõ';
            const scoreDisplay = attempt.graded ? `${attempt.score}/10` : 'Chưa chấm';
            const badgeClass = attempt.graded ? (attempt.score >= 8 ? 'bg-success' : attempt.score >= 5 ? 'bg-primary' : 'bg-danger') : 'bg-warning';
            
            attemptItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5>${attempt.studentName || 'Thí sinh không tên'}</h5>
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-light text-dark"><i class="fas fa-code me-1"></i> <span class="exam-code">${attempt.examCode}</span></span>
                            ${attempt.studentClass ? `<span class="badge bg-light text-dark"><i class="fas fa-users me-1"></i> ${attempt.studentClass}</span>` : ''}
                        </div>
                        <p class="text-muted mb-1"><small><i class="fas fa-clock me-1"></i> Nộp bài lúc ${submittedAt}</small></p>
                    </div>
                    <div class="text-end">
                        <span class="badge ${badgeClass} mb-1"><i class="fas fa-star me-1"></i> ${scoreDisplay}</span>
                        <span class="badge ${attempt.graded ? 'bg-success' : 'bg-warning'}">${attempt.graded ? 'Đã chấm' : 'Chưa chấm'}</span>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary view-attempt-btn">
                        <i class="fas fa-eye me-1"></i> Xem
                    </button>
                    ${attempt.graded ? '' : `<button class="btn btn-sm btn-outline-success grade-attempt-btn">
                        <i class="fas fa-check-circle me-1"></i> Chấm điểm
                    </button>`}
                </div>
            `;
            
            attemptsList.appendChild(attemptItem);
            
            // Add event listeners
            attemptItem.querySelector('.view-attempt-btn').addEventListener('click', () => showAttemptDetails(attempt, attemptId));
            
            if (!attempt.graded) {
                attemptItem.querySelector('.grade-attempt-btn').addEventListener('click', () => showAttemptDetails(attempt, attemptId));
            }
        }
        
        // Show attempt details modal
        function showAttemptDetails(attempt, attemptId) {
            currentAttemptDetails = { ...attempt, id: attemptId };
            
            // First load the exam details
            db.collection('exams').doc(attempt.examCode).get()
                .then(examDoc => {
                    if (!examDoc.exists) {
                        throw new Error('Exam not found');
                    }
                    
                    const exam = examDoc.data();
                    
                    // Set attempt info
                    document.getElementById('modalAttemptExamTitle').textContent = exam.title || 'Đề thi không có tiêu đề';
                    document.getElementById('modalAttemptStudent').textContent = attempt.studentName || 'Thí sinh không tên';
                    document.getElementById('modalAttemptDate').textContent = attempt.submittedAt ? formatDateTime(attempt.submittedAt) : 'Không rõ';
                    
                    if (attempt.graded) {
                        document.getElementById('modalAttemptScore').textContent = `${attempt.score}/10`;
                        document.getElementById('gradingForm').classList.add('d-none');
                    } else {
                        document.getElementById('modalAttemptScore').textContent = 'Chưa chấm';
                        document.getElementById('gradingForm').classList.remove('d-none');
                        document.getElementById('attemptScoreInput').value = '';
                        document.getElementById('attemptFeedbackInput').value = attempt.feedback || '';
                    }
                    
                    // Load questions and answers
                    const questionsReview = document.getElementById('attemptQuestionsReview');
                    questionsReview.innerHTML = '';
                    
                    exam.questions.forEach((question, index) => {
                        const questionReview = document.createElement('div');
                        questionReview.className = 'question-review';
                        
                        const studentAnswer = attempt.answers ? attempt.answers[index] : null;
                        let answerDisplay = '';
                        
                        if (question.type === 'multiple_choice') {
                            answerDisplay = `
                                <div class="mb-2"><strong>Đáp án đúng:</strong> <span class="correct-answer">${question.correctAnswer}</span></div>
                                <div class="mb-2"><strong>Thí sinh chọn:</strong> <span class="student-answer ${studentAnswer === question.correctAnswer ? 'correct' : 'incorrect'}">${studentAnswer || 'Không trả lời'}</span></div>
                            `;
                        } else if (question.type === 'true_false') {
                            answerDisplay = `
                                <div class="mb-2"><strong>Đáp án đúng:</strong> <span class="correct-answer">${question.correctAnswer === 'true' ? 'Đúng' : 'Sai'}</span></div>
                                <div class="mb-2"><strong>Thí sinh chọn:</strong> <span class="student-answer ${studentAnswer === question.correctAnswer ? 'correct' : 'incorrect'}">${studentAnswer ? (studentAnswer === 'true' ? 'Đúng' : 'Sai') : 'Không trả lời'}</span></div>
                            `;
                        } else {
                            answerDisplay = `
                                <div class="mb-2"><strong>Câu trả lời của thí sinh:</strong></div>
                                <div class="mb-2 p-2 bg-light rounded">${studentAnswer || 'Không trả lời'}</div>
                                ${question.modelAnswer ? `<div class="mb-2"><strong>Đáp án mẫu:</strong></div>
                                <div class="mb-2 p-2 bg-light rounded">${question.modelAnswer}</div>` : ''}
                            `;
                        }
                        
                        questionReview.innerHTML = `
                            <h6>Câu ${index + 1}: ${question.content || 'Nội dung câu hỏi'}</h6>
                            <div class="mb-2"><small class="text-muted">Loại câu hỏi: ${question.type === 'multiple_choice' ? 'Trắc nghiệm' : 
                                                                                     question.type === 'true_false' ? 'Đúng/Sai' : 
                                                                                     question.type === 'short_answer' ? 'Trả lời ngắn' : 'Tự luận'}</small></div>
                            ${answerDisplay}
                        `;
                        
                        questionsReview.appendChild(questionReview);
                    });
                    
                    // Set up grading buttons
                    document.getElementById('gradeWithAIBtn').onclick = function() {
                        gradeWithAI(attemptId, exam, attempt);
                    };
                    
                    document.getElementById('gradeWithAIAssistBtn').onclick = function() {
                        gradeWithAIAssist(attemptId, exam, attempt);
                    };
                    
                    document.getElementById('saveGradeBtn').onclick = function() {
                        saveGrade(attemptId);
                    };
                    
                    // Show modal
                    attemptDetailsModal.show();
                })
                .catch(error => {
                    console.error('Error loading exam details:', error);
                    showError('Lỗi khi tải chi tiết đề thi: ' + error.message);
                });
        }
        
        // Grade with AI
        function gradeWithAI(attemptId, exam, attempt) {
            aiGradingModal.show();
            document.getElementById('aiGradingMessage').textContent = 'AI đang phân tích và chấm điểm bài thi. Vui lòng chờ trong giây lát...';
            
            // Simulate AI grading (in a real app, you would call the Gemini API)
            setTimeout(() => {
                // Calculate score based on answers
                let score = 0;
                let totalPoints = 0;
                
                exam.questions.forEach((question, index) => {
                    const studentAnswer = attempt.answers ? attempt.answers[index] : null;
                    totalPoints += question.points || 1;
                    
                    if (question.type === 'multiple_choice' || question.type === 'true_false') {
                        if (studentAnswer === question.correctAnswer) {
                            score += question.points || 1;
                        }
                    } else {
                        // For text answers, give partial credit (50-100% of points)
                        if (studentAnswer) {
                            score += (question.points || 1) * (0.5 + Math.random() * 0.5);
                        }
                    }
                });
                
                const finalScore = totalPoints > 0 ? (score / totalPoints * 10).toFixed(1) : 0;
                
                // Generate feedback
                let feedback = '';
                if (finalScore >= 8) {
                    feedback = 'Bài làm xuất sắc, trình bày rõ ràng, đầy đủ ý và sâu sắc.';
                } else if (finalScore >= 6.5) {
                    feedback = 'Bài làm tốt, đáp ứng được yêu cầu cơ bản, có thể phát triển thêm một số ý.';
                } else if (finalScore >= 5) {
                    feedback = 'Bài làm đạt yêu cầu, cần bổ sung thêm kiến thức và phân tích sâu hơn.';
                } else {
                    feedback = 'Bài làm chưa đạt yêu cầu, cần ôn tập lại kiến thức và cải thiện kỹ năng làm bài.';
                }
                
                // Set the score and feedback
                document.getElementById('attemptScoreInput').value = finalScore;
                document.getElementById('attemptFeedbackInput').value = feedback;
                
                aiGradingModal.hide();
                showSuccess('AI đã chấm điểm bài thi thành công');
            }, 3000);
        }
        
        // Grade with AI assist
        function gradeWithAIAssist(attemptId, exam, attempt) {
            aiGradingModal.show();
            document.getElementById('aiGradingMessage').textContent = 'AI đang phân tích bài thi để hỗ trợ chấm điểm. Vui lòng chờ trong giây lát...';
            
            // Simulate AI assist (in a real app, you would call the Gemini API)
            setTimeout(() => {
                // Add AI feedback to each question
                const questionsReview = document.getElementById('attemptQuestionsReview');
                questionsReview.innerHTML = '';
                
                exam.questions.forEach((question, index) => {
                    const questionReview = document.createElement('div');
                    questionReview.className = 'question-review';
                    
                    const studentAnswer = attempt.answers ? attempt.answers[index] : null;
                    let answerDisplay = '';
                    
                    if (question.type === 'multiple_choice') {
                        answerDisplay = `
                            <div class="mb-2"><strong>Đáp án đúng:</strong> <span class="correct-answer">${question.correctAnswer}</span></div>
                            <div class="mb-2"><strong>Thí sinh chọn:</strong> <span class="student-answer ${studentAnswer === question.correctAnswer ? 'correct' : 'incorrect'}">${studentAnswer || 'Không trả lời'}</span></div>
                        `;
                    } else if (question.type === 'true_false') {
                        answerDisplay = `
                            <div class="mb-2"><strong>Đáp án đúng:</strong> <span class="correct-answer">${question.correctAnswer === 'true' ? 'Đúng' : 'Sai'}</span></div>
                            <div class="mb-2"><strong>Thí sinh chọn:</strong> <span class="student-answer ${studentAnswer === question.correctAnswer ? 'correct' : 'incorrect'}">${studentAnswer ? (studentAnswer === 'true' ? 'Đúng' : 'Sai') : 'Không trả lời'}</span></div>
                        `;
                    } else {
                        answerDisplay = `
                            <div class="mb-2"><strong>Câu trả lời của thí sinh:</strong></div>
                            <div class="mb-2 p-2 bg-light rounded">${studentAnswer || 'Không trả lời'}</div>
                            ${question.modelAnswer ? `<div class="mb-2"><strong>Đáp án mẫu:</strong></div>
                            <div class="mb-2 p-2 bg-light rounded">${question.modelAnswer}</div>` : ''}
                        `;
                    }
                    
                    // Generate AI feedback for this question
                    let aiFeedback = '';
                    if (question.type === 'multiple_choice' || question.type === 'true_false') {
                        if (studentAnswer === question.correctAnswer) {
                            aiFeedback = 'Thí sinh trả lời chính xác câu hỏi này.';
                        } else if (studentAnswer) {
                            aiFeedback = 'Thí sinh chọn sai đáp án. Cần ôn tập lại nội dung này.';
                        } else {
                            aiFeedback = 'Thí sinh không trả lời câu hỏi này.';
                        }
                    } else {
                        if (studentAnswer) {
                            aiFeedback = [
                                'Câu trả lời đáp ứng được yêu cầu cơ bản, có thể phát triển thêm ý.',
                                'Nội dung trình bày rõ ràng, cần bổ sung thêm dẫn chứng cụ thể.',
                                'Bài làm thể hiện hiểu biết về vấn đề, có thể phân tích sâu hơn.',
                                'Trình bày logic, cần chú ý đến cách diễn đạt và ngữ pháp.'
                            ][Math.floor(Math.random() * 4)];
                        } else {
                            aiFeedback = 'Thí sinh không trả lời câu hỏi này.';
                        }
                    }
                    
                    questionReview.innerHTML = `
                        <h6>Câu ${index + 1}: ${question.content || 'Nội dung câu hỏi'}</h6>
                        <div class="mb-2"><small class="text-muted">Loại câu hỏi: ${question.type === 'multiple_choice' ? 'Trắc nghiệm' : 
                                                                                 question.type === 'true_false' ? 'Đúng/Sai' : 
                                                                                 question.type === 'short_answer' ? 'Trả lời ngắn' : 'Tự luận'}</small></div>
                        ${answerDisplay}
                        <div class="ai-feedback">
                            <div class="feedback-label"><i class="fas fa-robot me-1"></i> Gợi ý chấm điểm từ AI:</div>
                            <div>${aiFeedback}</div>
                        </div>
                    `;
                    
                    questionsReview.appendChild(questionReview);
                });
                
                // Suggest a score
                let suggestedScore = 0;
                exam.questions.forEach((question, index) => {
                    const studentAnswer = attempt.answers ? attempt.answers[index] : null;
                    
                    if (question.type === 'multiple_choice' || question.type === 'true_false') {
                        if (studentAnswer === question.correctAnswer) {
                            suggestedScore += question.points || 1;
                        }
                    } else {
                        // For text answers, give partial credit
                        if (studentAnswer) {
                            suggestedScore += (question.points || 1) * (0.5 + Math.random() * 0.5);
                        }
                    }
                });
                
                const finalSuggestedScore = exam.questions.reduce((sum, q) => sum + (q.points || 1), 0) > 0 
                    ? (suggestedScore / exam.questions.reduce((sum, q) => sum + (q.points || 1), 0) * 10).toFixed(1)
                    : 0;
                
                document.getElementById('attemptScoreInput').value = finalSuggestedScore;
                document.getElementById('attemptFeedbackInput').value = 'AI đã phân tích và đề xuất điểm số. Vui lòng xem lại và điều chỉnh nếu cần.';
                
                aiGradingModal.hide();
                showSuccess('AI đã phân tích bài thi và đưa ra gợi ý chấm điểm');
            }, 3000);
        }
        
        // Save grade
        function saveGrade(attemptId) {
            const scoreInput = document.getElementById('attemptScoreInput');
            const feedbackInput = document.getElementById('attemptFeedbackInput');
            
            const score = parseFloat(scoreInput.value);
            const feedback = feedbackInput.value.trim();
            
            if (isNaN(score)) {
                showError('Vui lòng nhập điểm số hợp lệ');
                return;
            }
            
            if (score < 0 || score > 10) {
                showError('Điểm số phải từ 0 đến 10');
                return;
            }
            
            // Update the attempt
            db.collection('examAttempts').doc(attemptId).update({
                graded: true,
                score: score,
                feedback: feedback || null,
                gradedAt: new Date()
            })
            .then(() => {
                showSuccess('Điểm số đã được lưu thành công');
                attemptDetailsModal.hide();
                loadUserAttempts(currentAttemptsPage, document.getElementById('attemptSearch').value);
            })
            .catch(error => {
                console.error('Error saving grade:', error);
                showError('Lỗi khi lưu điểm số: ' + error.message);
            });
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    currentUser = user;
                    
                    // Load user's exams and attempts
                    loadUserExams();
                    loadUserAttempts();
                    
                    // Set up search functionality
                    document.getElementById('examSearch').addEventListener('input', function(e) {
                        loadUserExams(1, e.target.value);
                    });
                    
                    document.getElementById('attemptSearch').addEventListener('input', function(e) {
                        loadUserAttempts(1, e.target.value);
                    });
                }
            });
        });
    </script>
</body>
</html>
